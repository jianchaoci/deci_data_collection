<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ğŸ” é‡ç½®å¯†ç  - å¾—å¸Œè¡¨å‹é‡‡é›†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="common.css?v=fix1">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
        }

        .reset-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .reset-title {
            text-align: center;
            margin-bottom: 30px;
        }

        .reset-title h1 {
            font-size: 1.8rem;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .reset-title p {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .reset-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .reset-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .reset-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .message {
            margin-top: 20px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9rem;
            display: none;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .back-login {
            text-align: center;
            margin-top: 20px;
        }

        .back-login a {
            color: #6b7280;
            text-decoration: none;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <div class="reset-container">
        <div class="reset-title">
            <h1>ğŸ” é‡ç½®å¯†ç </h1>
            <p>è¯·è¾“å…¥æ–°å¯†ç </p>
        </div>

        <form id="resetPasswordForm">
            <div class="form-group">
                <label for="newPassword">ğŸ”’ æ–°å¯†ç </label>
                <input type="password" id="newPassword" placeholder="è‡³å°‘6ä½" required minlength="6">
            </div>
            <div class="form-group">
                <label for="confirmPassword">ğŸ”’ ç¡®è®¤æ–°å¯†ç </label>
                <input type="password" id="confirmPassword" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç " required>
            </div>
            <button type="submit" class="reset-btn" id="resetBtn">âœ… ç¡®è®¤é‡ç½®</button>
        </form>

        <div class="message" id="message"></div>

        <div class="back-login">
            <a href="index.html">â† è¿”å›ç™»å½•</a>
        </div>
    </div>

    <script src="common.js?v=auth4"></script>
    <script>
        function showMessage(text, type = 'info') {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type}`;
            msg.style.display = 'block';
        }

        document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('resetBtn');
            btn.disabled = true;
            btn.textContent = 'â³ é‡ç½®ä¸­...';

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                showMessage('âŒ ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´', 'error');
                btn.disabled = false;
                btn.textContent = 'âœ… ç¡®è®¤é‡ç½®';
                return;
            }

            try {
                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                });

                if (error) throw error;

                showMessage('âœ… å¯†ç é‡ç½®æˆåŠŸï¼3ç§’åè·³è½¬ç™»å½•...', 'success');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
            } catch (err) {
                showMessage('âŒ é‡ç½®å¤±è´¥: ' + err.message, 'error');
                btn.disabled = false;
                btn.textContent = 'âœ… ç¡®è®¤é‡ç½®';
            }
        });

        let isReady = false;

        // 1. æ·±åº¦ç›‘å¬æ‰€æœ‰èº«ä»½å˜åŠ¨
        supabase.auth.onAuthStateChange(async (event, session) => {
            console.log("Auth Event:", event);
            if (event === "PASSWORD_RECOVERY" || event === "SIGNED_IN" || session) {
                isReady = true;
                console.log("Recovery session ready.");
            }
        });

        async function checkSession() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const type = urlParams.get('type');

            // ä¼˜å…ˆä»æœ¬åœ°å­˜å‚¨è·å– emailï¼ŒURL ä¼ å‚ä½œä¸ºå¤‡é€‰
            const email = localStorage.getItem('reset_email') || urlParams.get('email');

            if (token && type === 'recovery') {
                console.log("Attempting OTP verification...");

                if (!email) {
                    console.warn("No email found for OTP verification.");
                    showMessage('ğŸ’¡ è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€ä»¥éªŒè¯èº«ä»½', 'info');
                    // è¿™é‡Œå¯ä»¥å¼¹å‡ºä¸€ä¸ªè¾“å…¥æ¡†è®©ç”¨æˆ·æ‰‹åŠ¨è¾“å…¥é‚®ç®±ï¼Œæˆ–è€…å¼•å¯¼ç”¨æˆ·
                } else {
                    const { error: verifyError } = await supabase.auth.verifyOtp({
                        email: email,
                        token: token,
                        type: 'recovery'
                    });

                    if (verifyError) {
                        console.error("OTP verification failed:", verifyError.message);
                        showMessage('âŒ éªŒè¯å¤±è´¥: ' + verifyError.message, 'error');
                    } else {
                        console.log("OTP verification success!");
                    }
                }
            }


            // ç»™è§£æå’Œä¼šè¯å»ºç«‹ç•™å‡º 1 ç§’æ—¶é—´
            await new Promise(res => setTimeout(res, 1000));

            const { data: { session } } = await supabase.auth.getSession();

            // æ‰«æ URL æ˜¯å¦åŒ…å« auth token (æ‰‹åŠ¨è¯†åˆ«)
            const hasAuthParams = window.location.hash.includes('access_token=') ||
                window.location.search.includes('type=recovery');

            if (session || isReady || hasAuthParams) {
                console.log("Session/Token verified successfully.");
            } else {
                const params = new URLSearchParams(window.location.search || window.location.hash.substring(1));
                const error = params.get('error_description') || params.get('error');

                if (error) {
                    showMessage('âŒ é“¾æ¥æ— æ•ˆ: ' + decodeURIComponent(error).replace(/\+/g, ' '), 'error');
                } else {
                    showMessage('âŒ æ— æ³•è¯†åˆ«é‡ç½®é“¾æ¥ã€‚è¯·ç¡®ä¿è¿™æ˜¯æœ€æ–°é‚®ä»¶ã€‚', 'error');
                }

                setTimeout(() => {
                    if (!isReady && !hasAuthParams) {
                        window.location.href = 'index.html';
                    }
                }, 5000);
            }
        }

        checkSession();
    </script>
</body>

</html>