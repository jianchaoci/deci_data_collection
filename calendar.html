<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>üìÖ ÈááÈõÜÊó•ÂéÜ - ÂæóÂ∏åË°®ÂûãÈááÈõÜÁ≥ªÁªü</title>
    <link rel="stylesheet" href="common.css?v=fix1">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .calendar-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.92) 100%);
            border-radius: var(--radius-2xl, 32px);
            padding: 36px;
            box-shadow: var(--shadow-lg, 0 10px 25px rgba(0, 0, 0, 0.05), 0 20px 40px rgba(16, 185, 129, 0.1));
            border: 1px solid rgba(255, 255, 255, 0.7);
            max-width: 1000px;
            margin: 0 auto;
            backdrop-filter: blur(20px);
            min-height: 600px;
            /* Ensure height for chart */
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .month-nav {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .month-nav button {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.2);
            font-size: 1rem;
            color: var(--color-primary-600, #059669);
            cursor: pointer;
            padding: 10px 18px;
            border-radius: var(--radius-xl, 24px);
            transition: var(--transition-normal, 250ms cubic-bezier(0.4, 0, 0.2, 1));
            font-weight: 600;
        }

        .month-nav button:hover {
            background: linear-gradient(135deg, var(--color-primary-500, #10b981), var(--color-primary-600, #059669));
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md, 0 4px 6px rgba(0, 0, 0, 0.04), 0 10px 15px rgba(16, 185, 129, 0.12));
        }

        .current-date {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--color-primary-800, #064e3b);
            background: linear-gradient(135deg, var(--color-primary-700, #047857), var(--color-primary-500, #10b981));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            min-width: 180px;
            text-align: center;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 450px;
            width: 100%;
        }

        .loading-placeholder {
            text-align: center;
            padding: 50px 20px;
            color: var(--color-neutral-500, #737373);
            font-size: 1rem;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        @media (max-width: 768px) {
            .calendar-card {
                padding: 20px;
                border-radius: 20px;
                min-height: auto;
            }

            .calendar-header {
                flex-direction: column;
                gap: 15px;
            }

            .month-nav {
                width: 100%;
                justify-content: space-between;
            }

            .current-date {
                font-size: 1.3rem;
                min-width: auto;
            }

            .month-nav button {
                padding: 8px 14px;
                font-size: 0.9rem;
            }

            .chart-container {
                height: 350px;
            }
        }

        @media (max-width: 480px) {
            .calendar-card {
                padding: 15px;
                border-radius: 16px;
            }

            .current-date {
                font-size: 1.1rem;
            }

            .chart-container {
                height: 280px;
            }

            .loading-placeholder {
                font-size: 0.9rem;
            }
        }
    </style>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <div class="nav-links">
            <a href="index.html" class="nav-link" title="È¶ñÈ°µ">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </a>
            <a href="calendar.html" class="nav-link" data-page="calendar" title="ÈááÈõÜÊó•ÂéÜ">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
            </a>
            <a href="collection.html" class="nav-link" data-page="collection" title="Êï∞ÊçÆÈááÈõÜ">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                </svg>
            </a>
            <a href="trends.html" class="nav-link" data-page="trends" title="ÁªüËÆ°ÂàÜÊûê">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="20" x2="18" y2="10"></line>
                    <line x1="12" y1="20" x2="12" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
            </a>
            <a href="download.html" class="nav-link" data-page="download" title="Êï∞ÊçÆ‰∏ãËΩΩ">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
            </a>
        </div>
        <div class="user-area" id="navUserArea" style="display: flex; gap: 10px; align-items: center;"><button
                class="lang-switch" id="langSwitch" style="display: none;">üåê EN</button></div>
    </nav>
    <!-- Main Container -->
    <div class="main-container">
        <div class="calendar-card">
            <div class="calendar-header">
                <div class="project-selector-wrapper" style="margin-right: auto;">
                    <select id="projectSelect" style="
                        padding: 8px 16px; 
                        border-radius: 24px; 
                        border: 1px solid rgba(16, 185, 129, 0.2); 
                        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05)); 
                        color: #059669; 
                        font-weight: 600;
                        font-size: 0.95rem;
                        cursor: pointer;
                        outline: none;
                        appearance: none;
                        -webkit-appearance: none;
                        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23059669%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
                        background-repeat: no-repeat;
                        background-position: right 12px top 50%;
                        background-size: 10px auto;
                        padding-right: 32px;
                        transition: all 0.2s;
                    ">
                        <option value="" disabled selected>ÈÄâÊã©È°πÁõÆ...</option>
                    </select>
                </div>
                <div class="month-nav"><button id="prevMonth">‚óÄ <span data-lang="prevMonth">‰∏äÊúà</span></button><span
                        class="current-date" id="currentDateDisplay">2026Âπ¥ 01Êúà</span><button id="nextMonth"><span
                            data-lang="nextMonth">‰∏ãÊúà</span>‚ñ∂</button></div>
            </div>
            <div class="chart-container" id="chartWrapper"><canvas id="calendarChart"></canvas>
                <div class="loading-placeholder" id="loadingIndicator" data-lang="loading">Âä†ËΩΩ‰∏≠...</div>
            </div>
        </div>
    </div>
    <script src="common.js?v=fix1"></script>
    <script> // Set active navigation
        setActiveNav('calendar');

        // Add specific translations for this page
        translations.zh.prevMonth = '‰∏äÊúà';
        translations.zh.nextMonth = '‰∏ãÊúà';
        translations.zh.dailyLabel = 'Êó•ÈááÈõÜ (Daily)';
        translations.zh.weeklyLabel = 'Âë®ÈááÈõÜ (Weekly)';

        translations.en.prevMonth = 'Prev Month';
        translations.en.nextMonth = 'Next Month';
        translations.en.dailyLabel = 'Daily Data';
        translations.en.weeklyLabel = 'Weekly Data';

        // State
        let currentMonthDate = getBeijingTime(); // Use first day of month logic later
        currentMonthDate.setDate(1); // Default to 1st of current month
        let calendarChart = null;
        let currentProject = localStorage.getItem('currentProject') || '';

        const dateDisplay = document.getElementById('currentDateDisplay');
        const loadingEl = document.getElementById('loadingIndicator');
        const projectSelect = document.getElementById('projectSelect');

        // Load Projects
        async function loadProjects() {
            if (!currentUser) return;

            try {
                const { data, error } = await supabase
                    .from('facility_settings')
                    .select('project_name')
                    .eq('user_id', currentUser.id);

                if (error) throw error;

                projectSelect.innerHTML = '<option value="" disabled>ÈÄâÊã©È°πÁõÆ...</option>';

                if (data && data.length > 0) {
                    // Check if currentProject is still valid
                    const exists = data.find(p => p.project_name === currentProject);
                    if (!exists) {
                        currentProject = data[0].project_name;
                        localStorage.setItem('currentProject', currentProject);
                    }

                    data.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.project_name;
                        option.textContent = p.project_name;
                        if (p.project_name === currentProject) {
                            option.selected = true;
                        }
                        projectSelect.appendChild(option);
                    });
                } else {
                    currentProject = '';
                    projectSelect.innerHTML = '<option value="" disabled>Êó†ÂèØÁî®È°πÁõÆ</option>';
                }
            } catch (err) {
                console.error('Error loading projects:', err);
            }
        }

        // Initial Header Update
        function updateHeader() {
            const year = currentMonthDate.getFullYear();
            const month = currentMonthDate.getMonth() + 1;

            if (currentLang === 'zh') {
                dateDisplay.textContent = `${year}Âπ¥ ${month.toString().padStart(2, '0')}Êúà`;
            } else {
                const monthName = currentMonthDate.toLocaleString('en-US', { month: 'long' });
                dateDisplay.textContent = `${monthName} ${year}`;
            }
        }

        // Generate Array of Days in Month
        function getDaysInMonth(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const days = new Date(year, month + 1, 0).getDate();
            return Array.from({ length: days }, (_, i) => i + 1);
        }

        // Render Chart
        function renderChart(dailyMap, weeklyMap) {
            const ctx = document.getElementById('calendarChart').getContext('2d');
            const days = getDaysInMonth(currentMonthDate);

            const dailyData = days.map(d => dailyMap[d] ? 1 : 0);
            const weeklyData = days.map(d => weeklyMap[d] ? 1 : 0);
            const lang = translations[currentLang];

            if (calendarChart) {
                calendarChart.destroy();
            }

            calendarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        label: lang.dailyLabel || 'Daily',
                        data: dailyData,
                        backgroundColor: '#8B5CF6',
                        borderColor: '#7C3AED',
                        borderWidth: 1,
                        borderRadius: 4,
                        barPercentage: 0.6,
                    }, {
                        label: lang.weeklyLabel || 'Weekly',
                        data: weeklyData,
                        backgroundColor: '#10B981',
                        borderColor: '#059669',
                        borderWidth: 1,
                        borderRadius: 4,
                        barPercentage: 0.6,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            grid: { display: false },
                            title: {
                                display: true,
                                text: currentLang === 'zh' ? 'Êó•Êúü (Âá†Âè∑)' : 'Date'
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            max: 2.2,
                            ticks: { display: false, stepSize: 1 },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { usePointStyle: true, pointStyle: 'rectRounded' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + (context.raw > 0 ? '‚úÖ' : '-');
                                }
                            }
                        }
                    }
                }
            });
        }

        async function loadMonthData() {
            loadingEl.style.display = 'block';
            if (calendarChart) {
                calendarChart.clear();
            }

            if (!currentUser || currentUser.is_guest) {
                loadingEl.style.display = 'none';
                renderChart({}, {});
                return;
            }

            try {
                const year = currentMonthDate.getFullYear();
                const month = currentMonthDate.getMonth();
                const startDate = new Date(year, month, 1);
                const localStartDateStr = `${year}-${String(month + 1).padStart(2, '0')}-01`;
                const endDate = new Date(year, month + 1, 0);
                const localEndDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${endDate.getDate()}`;

                console.log(`Loading data for range: ${localStartDateStr} to ${localEndDateStr}, Project: ${currentProject}`);

                if (!currentProject) {
                    renderChart({}, {});
                    return;
                }

                // 1. Fetch Daily Data (by date)
                const dailyRes = await supabase.from('daily_phenotypes')
                    .select('date')
                    .eq('user_id', currentUser.id)
                    .eq('project_name', currentProject) // Filter by project
                    .gte('date', localStartDateStr)
                    .lte('date', localEndDateStr);

                // 2. Fetch Weekly Data (by created_at)
                // Note: Weekly data doesn't have a 'date' column, so we use 'created_at'.
                const weeklyRes = await supabase.from('weekly_phenotypes')
                    .select('created_at')
                    .eq('user_id', currentUser.id)
                    .eq('project_name', currentProject) // Filter by project
                    .gte('created_at', wrapperDateToISO(startDate)) // Use approximate ISO range
                    .lte('created_at', wrapperDateToISO(new Date(year, month + 1, 1))); // Up to next month start

                if (dailyRes.error) throw dailyRes.error;
                if (weeklyRes.error) throw weeklyRes.error;

                // Process Daily Data -> Map of DayNumber: true
                const dailyMap = {}

                    ;

                if (dailyRes.data) {
                    dailyRes.data.forEach(row => {
                        const d = new Date(row.date);
                        dailyMap[d.getDate()] = true;
                    });
                }

                // Process Weekly Data -> Map of DayNumber: true
                const weeklyMap = {}

                    ;

                if (weeklyRes.data) {
                    weeklyRes.data.forEach(row => {
                        const d = new Date(row.created_at);
                        weeklyMap[d.getDate()] = true;
                    });
                }

                renderChart(dailyMap, weeklyMap);

            }

            catch (err) {
                console.error("Error loading calendar data:", err);

                loadingEl.textContent = `Error: $ {
                err.message
            }

            `;
            }

            finally {
                loadingEl.style.display = 'none';
            }
        }

        // Helper: Safe ISO string for constraints without timezone issues 
        // actually Supabase expects ISO strings for timestamps.
        function wrapperDateToISO(date) {
            return date.toISOString();
        }

        // Listeners
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentMonthDate.setMonth(currentMonthDate.getMonth() - 1);
            updateHeader();
            loadMonthData();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentMonthDate.setMonth(currentMonthDate.getMonth() + 1);
            updateHeader();
            loadMonthData();
        });

        projectSelect.addEventListener('change', (e) => {
            currentProject = e.target.value;
            localStorage.setItem('currentProject', currentProject);
            loadMonthData();
        });

        // Initialize
        async function init() {
            updateHeader();
            const session = await initAuth();

            if (session) {
                currentUser = session.user;
                await loadProjects(); // Load projects first
            }

            loadMonthData();
        }

        init();
    </script>
</body>

</html>