<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ğŸ“… é‡‡é›†æ—¥å† - å¾—å¸Œè¡¨å‹é‡‡é›†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="common.css?v=fix1">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .calendar-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.92) 100%);
            border-radius: var(--radius-2xl, 32px);
            padding: 36px;
            box-shadow: var(--shadow-lg, 0 10px 25px rgba(0, 0, 0, 0.05), 0 20px 40px rgba(16, 185, 129, 0.1));
            border: 1px solid rgba(255, 255, 255, 0.7);
            max-width: 1000px;
            margin: 0 auto;
            backdrop-filter: blur(20px);
            min-height: 600px;
            /* Ensure height for chart */
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .month-nav {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .month-nav button {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
            border: 1px solid rgba(16, 185, 129, 0.2);
            font-size: 1rem;
            color: var(--color-primary-600, #059669);
            cursor: pointer;
            padding: 10px 18px;
            border-radius: var(--radius-xl, 24px);
            transition: var(--transition-normal, 250ms cubic-bezier(0.4, 0, 0.2, 1));
            font-weight: 600;
        }

        .month-nav button:hover {
            background: linear-gradient(135deg, var(--color-primary-500, #10b981), var(--color-primary-600, #059669));
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md, 0 4px 6px rgba(0, 0, 0, 0.04), 0 10px 15px rgba(16, 185, 129, 0.12));
        }

        .current-date {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--color-primary-800, #064e3b);
            background: linear-gradient(135deg, var(--color-primary-700, #047857), var(--color-primary-500, #10b981));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            min-width: 180px;
            text-align: center;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 450px;
            width: 100%;
        }

        .loading-placeholder {
            text-align: center;
            padding: 50px 20px;
            color: var(--color-neutral-500, #737373);
            font-size: 1rem;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        @media (max-width: 768px) {
            .calendar-card {
                padding: 20px;
                border-radius: 20px;
                min-height: auto;
            }

            .calendar-header {
                flex-direction: column;
                gap: 15px;
            }

            .month-nav {
                width: 100%;
                justify-content: space-between;
            }

            .current-date {
                font-size: 1.3rem;
                min-width: auto;
            }

            .month-nav button {
                padding: 8px 14px;
                font-size: 0.9rem;
            }

            .chart-container {
                height: 350px;
            }
        }

        @media (max-width: 480px) {
            .calendar-card {
                padding: 15px;
                border-radius: 16px;
            }

            .current-date {
                font-size: 1.1rem;
            }

            .chart-container {
                height: 280px;
            }

            .loading-placeholder {
                font-size: 0.9rem;
            }
    </style>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <div class="nav-links"><a href="index.html" class="nav-link">ğŸ  é¦–é¡µ</a><a href="calendar.html" class="nav-link"
                data-page="calendar">ğŸ“… é‡‡é›†æ—¥å†</a><a href="collection.html" class="nav-link" data-page="collection">ğŸ“Š
                æ•°æ®é‡‡é›†</a><a href="trends.html" class="nav-link" data-page="trends">ğŸ“ˆ
                ç»Ÿè®¡åˆ†æ</a></div>
        <div class="user-area" id="navUserArea" style="display: flex; gap: 10px; align-items: center;"><button
                class="lang-switch" id="langSwitch" style="display: none;">ğŸŒ EN</button></div>
    </nav>
    <!-- Main Container -->
    <div class="main-container">
        <div class="calendar-card">
            <div class="calendar-header">
                <div class="month-nav"><button id="prevMonth">â—€ <span data-lang="prevMonth">ä¸Šæœˆ</span></button><span
                        class="current-date" id="currentDateDisplay">2026å¹´ 01æœˆ</span><button id="nextMonth"><span
                            data-lang="nextMonth">ä¸‹æœˆ</span>â–¶</button></div>
            </div>
            <div class="chart-container" id="chartWrapper"><canvas id="calendarChart"></canvas>
                <div class="loading-placeholder" id="loadingIndicator" data-lang="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>
    <script src="common.js?v=fix1"></script>
    <script> // Set active navigation
        setActiveNav('calendar');

        // Add specific translations for this page
        translations.zh.prevMonth = 'ä¸Šæœˆ';
        translations.zh.nextMonth = 'ä¸‹æœˆ';
        translations.zh.dailyLabel = 'æ—¥é‡‡é›† (Daily)';
        translations.zh.weeklyLabel = 'å‘¨é‡‡é›† (Weekly)';

        translations.en.prevMonth = 'Prev Month';
        translations.en.nextMonth = 'Next Month';
        translations.en.dailyLabel = 'Daily Data';
        translations.en.weeklyLabel = 'Weekly Data';

        // State
        let currentMonthDate = getBeijingTime(); // Use first day of month logic later
        currentMonthDate.setDate(1); // Default to 1st of current month
        let calendarChart = null;

        const dateDisplay = document.getElementById('currentDateDisplay');
        const loadingEl = document.getElementById('loadingIndicator');

        // Initial Header Update
        function updateHeader() {
            const year = currentMonthDate.getFullYear();
            const month = currentMonthDate.getMonth() + 1;

            if (currentLang === 'zh') {
                dateDisplay.textContent = `${year}å¹´ ${month.toString().padStart(2, '0')}æœˆ`;
            } else {
                const monthName = currentMonthDate.toLocaleString('en-US', { month: 'long' });
                dateDisplay.textContent = `${monthName} ${year}`;
            }
        }

        // Generate Array of Days in Month
        function getDaysInMonth(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            const days = new Date(year, month + 1, 0).getDate();
            return Array.from({ length: days }, (_, i) => i + 1);
        }

        // Render Chart
        function renderChart(dailyMap, weeklyMap) {
            const ctx = document.getElementById('calendarChart').getContext('2d');
            const days = getDaysInMonth(currentMonthDate);

            const dailyData = days.map(d => dailyMap[d] ? 1 : 0);
            const weeklyData = days.map(d => weeklyMap[d] ? 1 : 0);
            const lang = translations[currentLang];

            if (calendarChart) {
                calendarChart.destroy();
            }

            calendarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: days,
                    datasets: [{
                        label: lang.dailyLabel || 'Daily',
                        data: dailyData,
                        backgroundColor: '#8B5CF6',
                        borderColor: '#7C3AED',
                        borderWidth: 1,
                        borderRadius: 4,
                        barPercentage: 0.6,
                    }, {
                        label: lang.weeklyLabel || 'Weekly',
                        data: weeklyData,
                        backgroundColor: '#10B981',
                        borderColor: '#059669',
                        borderWidth: 1,
                        borderRadius: 4,
                        barPercentage: 0.6,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            grid: { display: false },
                            title: {
                                display: true,
                                text: currentLang === 'zh' ? 'æ—¥æœŸ (å‡ å·)' : 'Date'
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            max: 2.2,
                            ticks: { display: false, stepSize: 1 },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)',
                                drawBorder: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { usePointStyle: true, pointStyle: 'rectRounded' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': ' + (context.raw > 0 ? 'âœ…' : '-');
                                }
                            }
                        }
                    }
                }
            });
        }

        async function loadMonthData() {
            loadingEl.style.display = 'block';
            if (calendarChart) {
                calendarChart.clear();
            }

            if (!currentUser || currentUser.is_guest) {
                loadingEl.style.display = 'none';
                renderChart({}, {});
                return;
            }

            try {
                const year = currentMonthDate.getFullYear();
                const month = currentMonthDate.getMonth();
                const startDate = new Date(year, month, 1);
                const localStartDateStr = `${year}-${String(month + 1).padStart(2, '0')}-01`;
                const endDate = new Date(year, month + 1, 0);
                const localEndDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${endDate.getDate()}`;

                console.log(`Loading data for range: ${localStartDateStr} to ${localEndDateStr}`);

                // 1. Fetch Daily Data (by date)
                const dailyRes = await supabase.from('daily_phenotypes').select('date').eq('user_id', currentUser.id).gte('date', localStartDateStr).lte('date', localEndDateStr);

                // 2. Fetch Weekly Data (by created_at)
                // Note: Weekly data doesn't have a 'date' column, so we use 'created_at'.
                const weeklyRes = await supabase.from('weekly_phenotypes').select('created_at').eq('user_id', currentUser.id).gte('created_at', wrapperDateToISO(startDate)) // Use approximate ISO range
                    .lte('created_at', wrapperDateToISO(new Date(year, month + 1, 1))); // Up to next month start

                if (dailyRes.error) throw dailyRes.error;
                if (weeklyRes.error) throw weeklyRes.error;

                // Process Daily Data -> Map of DayNumber: true
                const dailyMap = {}

                    ;

                if (dailyRes.data) {
                    dailyRes.data.forEach(row => {
                        const d = new Date(row.date);
                        dailyMap[d.getDate()] = true;
                    });
                }

                // Process Weekly Data -> Map of DayNumber: true
                const weeklyMap = {}

                    ;

                if (weeklyRes.data) {
                    weeklyRes.data.forEach(row => {
                        const d = new Date(row.created_at);
                        weeklyMap[d.getDate()] = true;
                    });
                }

                renderChart(dailyMap, weeklyMap);

            }

            catch (err) {
                console.error("Error loading calendar data:", err);

                loadingEl.textContent = `Error: $ {
                err.message
            }

            `;
            }

            finally {
                loadingEl.style.display = 'none';
            }
        }

        // Helper: Safe ISO string for constraints without timezone issues 
        // actually Supabase expects ISO strings for timestamps.
        function wrapperDateToISO(date) {
            return date.toISOString();
        }

        // Listeners
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentMonthDate.setMonth(currentMonthDate.getMonth() - 1);
            updateHeader();
            loadMonthData();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentMonthDate.setMonth(currentMonthDate.getMonth() + 1);
            updateHeader();
            loadMonthData();
        });

        // Initialize
        async function init() {
            updateHeader();
            const session = await initAuth();

            if (session) {
                currentUser = session.user;
            }

            loadMonthData();
        }

        init();
    </script>
</body>

</html>