<!doctype html>

<html lang="zh-CN">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>ğŸŒ± å¾—å¸Œè¡¨å‹é‡‡é›†ç³»ç»Ÿ - ç°ä»£åŒ–äº‘ç«¯åŒæ­¥</title>
		<style>
			/* Light Green Theme Design */
			* { box-sizing: border-box; }
			
			body {
				font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
				margin: 0;
				padding: 15px;
				background: linear-gradient(135deg, #e8f5e8 0%, #f0fdf4 50%, #dcfce7 100%);
				min-height: 100vh;
				color: #1f2937;
			}
			
			.main-container {
				max-width: 1400px;
				margin: 0 auto;
				display: grid;
				grid-template-columns: 350px 1fr;
				gap: 20px;
				height: calc(100vh - 30px);
			}
			
			/* Left Panel - Calendar */
			.left-panel {
				background: rgba(255, 255, 255, 0.9);
				border-radius: 20px;
				padding: 20px;
				box-shadow: 0 8px 32px rgba(34, 197, 94, 0.1);
				border: 1px solid rgba(34, 197, 94, 0.1);
				overflow-y: auto;
				display: flex;
				flex-direction: column;
			}
			
			.calendar-header {
				text-align: center;
				margin-bottom: 20px;
			}
			
			.calendar-title {
				font-size: 1.5rem;
				font-weight: 700;
				color: #15803d;
				margin-bottom: 10px;
			}
			
			.calendar-nav {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 15px;
			}
			
			.nav-btn {
				background: linear-gradient(135deg, #22c55e, #16a34a);
				color: white;
				border: none;
				padding: 8px 12px;
				border-radius: 8px;
				cursor: pointer;
				font-weight: 600;
			}
			
			.nav-btn:hover {
				background: linear-gradient(135deg, #16a34a, #15803d);
			}
			
			.month-year {
				font-weight: 600;
				color: #166534;
			}
			
			.calendar-grid {
				display: grid;
				grid-template-columns: repeat(7, 1fr);
				gap: 2px;
				margin-bottom: 15px;
				flex-shrink: 0;
			}
			
			.calendar-day-header {
				text-align: center;
				font-weight: 600;
				color: #15803d;
				padding: 8px 4px;
				font-size: 12px;
			}
			
			.calendar-day {
				aspect-ratio: 1;
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				border: 1px solid #e5e7eb;
				border-radius: 6px;
				cursor: pointer;
				transition: all 0.3s ease;
				background: white;
				position: relative;
			}
			
			.calendar-day:hover {
				background: #f0fdf4;
				border-color: #22c55e;
			}
			
			.calendar-day.today {
				background: linear-gradient(135deg, #22c55e, #16a34a);
				color: white;
				font-weight: bold;
			}
			
			.calendar-day.other-month {
				color: #9ca3af;
				background: #f9fafb;
			}
			
			.calendar-day.has-data {
				background: linear-gradient(135deg, #bbf7d0, #86efac);
				border-color: #22c55e;
			}
			
			.data-count {
				font-size: 10px;
				background: #dc2626;
				color: white;
				border-radius: 50%;
				width: 16px;
				height: 16px;
				display: flex;
				align-items: center;
				justify-content: center;
				position: absolute;
				top: -2px;
				right: -2px;
				font-weight: bold;
			}
			
			.stats-summary {
				background: linear-gradient(135deg, #f0fdf4, #dcfce7);
				padding: 12px;
				border-radius: 10px;
				border: 1px solid #bbf7d0;
				margin-bottom: 10px;
				flex-shrink: 0;
			}
			
			.stats-title {
				font-weight: 600;
				color: #15803d;
				margin-bottom: 8px;
				font-size: 14px;
			}
			
			.stats-item {
				display: flex;
				justify-content: space-between;
				margin-bottom: 4px;
				font-size: 13px;
			}
			
			/* Day Details Section */
			.day-details {
				background: linear-gradient(135deg, #ecfdf5, #d1fae5);
				padding: 12px;
				border-radius: 10px;
				border: 1px solid #a7f3d0;
				flex: 1;
				overflow-y: auto;
				min-height: 0;
			}
			
			.selected-date {
				font-size: 16px;
				font-weight: 600;
				color: #065f46;
				margin-bottom: 12px;
				text-align: center;
				padding: 8px;
				background: white;
				border-radius: 8px;
				border: 1px solid #6ee7b7;
			}
			
			.loading {
				text-align: center;
				padding: 20px;
				color: #059669;
			}
			
			.loading-spinner {
				font-size: 24px;
				margin-bottom: 8px;
				animation: spin 1s linear infinite;
			}
			
			@keyframes spin {
				from { transform: rotate(0deg); }
				to { transform: rotate(360deg); }
			}
			
			.day-results {
				max-height: 150px;
				overflow-y: auto;
			}
			
			.file-item {
				background: white;
				padding: 8px 12px;
				margin: 5px 0;
				border-radius: 6px;
				border: 1px solid #d1fae5;
				display: flex;
				justify-content: space-between;
				align-items: center;
				font-size: 13px;
			}
			
			.file-name {
				color: #374151;
				font-weight: 500;
			}
			
			.file-time {
				color: #6b7280;
				font-size: 11px;
			}
			
			.no-data {
				text-align: center;
				color: #6b7280;
				padding: 20px;
				font-style: italic;
			}
			
			/* Right Panel - Data Collection */
			.right-panel {
				background: rgba(255, 255, 255, 0.9);
				border-radius: 20px;
				padding: 0;
				box-shadow: 0 8px 32px rgba(34, 197, 94, 0.1);
				border: 1px solid rgba(34, 197, 94, 0.1);
				display: flex;
				flex-direction: column;
				overflow: hidden;
				height: 100%;
			}
			
			.page-header {
				text-align: center;
				margin-bottom: 20px;
				flex-shrink: 0;
			}
			
			.page-title {
				background: linear-gradient(135deg, #22c55e, #15803d);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				background-clip: text;
				font-size: clamp(1.5rem, 3vw, 1.8rem);
				font-weight: 700;
				margin-bottom: 8px;
			}
			
			.page-subtitle {
				color: #15803d;
				font-size: 13px;
				background: linear-gradient(135deg, #f0fdf4, #dcfce7);
				padding: 8px 16px;
				border-radius: 20px;
				border: 1px solid #bbf7d0;
				display: inline-block;
			}
			
			/* æ»šåŠ¨æŒ‡æ ‡é€‰æ‹©å™¨æ ·å¼ */
			.indicators-scroll-container {
				flex: 1;
				display: flex;
				flex-direction: column;
				background: rgba(248, 250, 252, 0.8);
				border-radius: 15px;
				border: 1px solid rgba(34, 197, 94, 0.1);
				margin-bottom: 15px;
				overflow: hidden;
			}
			
			.scroll-header {
				background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
				color: white;
				text-align: center;
				padding: 20px;
				border-radius: 12px 12px 0 0;
				box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
				position: sticky;
				top: 0;
				z-index: 100;
			}
			
			.page-title {
				font-size: 28px;
				font-weight: 700;
				margin: 0 0 8px 0;
				text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
			}
			
			.page-subtitle {
				font-size: 14px;
				opacity: 0.9;
				margin: 0 0 20px 0;
				text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
			}
			
			.action-buttons {
				display: flex;
				gap: 10px;
				justify-content: center;
				margin: 15px 0;
			}
			
			.status-bar {
				background: rgba(255,255,255,0.1);
				border-radius: 6px;
				padding: 8px 16px;
				margin: 10px auto 0;
				max-width: 300px;
				font-size: 14px;
			}
			
			.status-text {
				color: white;
				font-weight: 500;
			}
			
			.scroll-hint {
				font-size: 0.8rem;
				color: #059669;
			}
			
			.indicators-scroll-wrapper {
				flex: 1;
				overflow-y: auto;
				padding: 8px;
				max-height: 450px;
			}
			
			.indicator-item {
				background: white;
				border: 1px solid #e5e7eb;
				border-radius: 8px;
				padding: 12px;
				margin-bottom: 6px;
				transition: all 0.2s ease;
			}
			
			.indicator-item:hover {
				border-color: #22c55e;
				box-shadow: 0 2px 8px rgba(34, 197, 94, 0.1);
			}
			
			.indicator-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 8px;
			}
			
			.indicator-name {
				font-weight: 600;
				color: #374151;
				font-size: 0.9rem;
			}
			
			.indicator-value-display {
				display: flex;
				align-items: center;
				gap: 5px;
				font-size: 0.85rem;
				color: #059669;
				font-weight: 600;
			}
			
			.indicator-controls {
				display: block;
				margin-top: 8px;
			}
			
			.control-range {
				width: 100%;
				height: 6px;
				border-radius: 3px;
				background: linear-gradient(to right, #dcfce7, #22c55e);
				outline: none;
				-webkit-appearance: none;
				appearance: none;
			}
			
			.control-range::-webkit-slider-thumb {
				appearance: none;
				width: 16px;
				height: 16px;
				border-radius: 50%;
				background: #22c55e;
				cursor: pointer;
				box-shadow: 0 2px 4px rgba(34, 197, 94, 0.3);
			}
			
			.control-range::-moz-range-thumb {
				width: 16px;
				height: 16px;
				border-radius: 50%;
				background: #22c55e;
				cursor: pointer;
				border: none;
				box-shadow: 0 2px 4px rgba(34, 197, 94, 0.3);
			}
			
			.btn {
				padding: 10px 20px;
				border: none;
				border-radius: 20px;
				font-weight: 600;
				font-size: 13px;
				cursor: pointer;
				transition: all 0.3s ease;
				display: flex;
				align-items: center;
				gap: 6px;
				min-width: 120px;
				justify-content: center;
			}
			
			.btn-primary {
				background: linear-gradient(135deg, #22c55e, #16a34a);
				color: white;
				box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
			}
			
			.btn-primary:hover {
				background: linear-gradient(135deg, #16a34a, #15803d);
				transform: translateY(-2px);
				box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
			}
			
			.btn-secondary {
				background: linear-gradient(135deg, #10b981, #059669);
				color: white;
				box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
			}
			
			.btn-secondary:hover {
				background: linear-gradient(135deg, #059669, #047857);
				transform: translateY(-2px);
			}
			
			/* Responsive Design */
			@media (max-width: 1024px) {
				.main-container {
					grid-template-columns: 1fr;
					grid-template-rows: auto 1fr;
					height: auto;
				}
				
				.left-panel {
					order: 2;
				}
				
				.right-panel {
					order: 1;
				}
			}
			
			@media (max-width: 768px) {
				body {
					padding: 10px;
				}
				
				.main-container {
					gap: 15px;
				}
				
				.left-panel, .right-panel {
					padding: 15px;
				}
			}
		</style>
	</head>
	<body>
		<div class="main-container">
			<!-- Left Panel - Calendar and Statistics -->
			<div class="left-panel">
				<div class="calendar-header">
					<div class="calendar-title">ğŸ“… é‡‡é›†å†å²</div>
					<div class="calendar-nav">
						<button class="nav-btn" onclick="changeMonth(-1)">â†</button>
						<span class="month-year" id="monthYear">2025å¹´11æœˆ</span>
						<button class="nav-btn" onclick="changeMonth(1)">â†’</button>
					</div>
				</div>
				
				<div class="calendar-grid" id="calendarGrid">
					<!-- Calendar will be generated by JavaScript -->
				</div>
				
				<div class="stats-summary">
					<div class="stats-title">ğŸ“Š æœ¬æœˆç»Ÿè®¡</div>
					<div class="stats-item">
						<span>æ€»é‡‡é›†æ¬¡æ•°:</span>
						<span id="totalCollections">0</span>
					</div>
					<div class="stats-item">
						<span>é‡‡é›†å¤©æ•°:</span>
						<span id="collectionDays">0</span>
					</div>
					<div class="stats-item">
						<span>æœ¬æœˆæœ€å¤š:</span>
						<span id="maxPerDay">0æ¬¡/å¤©</span>
					</div>
				</div>
				
				<!-- Selected Day Details -->
				<div class="day-details" id="dayDetails" style="display: none;">
					<div class="stats-title">ğŸ“… é€‰ä¸­æ—¥æœŸè¯¦æƒ…</div>
					<div id="selectedDate" class="selected-date"></div>
					<div class="loading" id="dayLoading" style="display: none;">
						<div class="loading-spinner">â³</div>
						<div>æ­£åœ¨æŸ¥è¯¢æ–‡ä»¶...</div>
					</div>
					<div id="dayResults" class="day-results"></div>
				</div>
			</div>
			
			<!-- Right Panel - Data Collection Form -->
			<div class="right-panel">
				<!-- æ»šåŠ¨æŒ‡æ ‡é€‰æ‹©å™¨ -->
				<div class="indicators-scroll-container">
					<div class="scroll-header">
						<h1 class="page-title">ğŸŒ± å¾—å¸Œè¡¨å‹é‡‡é›†ç³»ç»Ÿ</h1>
						<div class="page-subtitle">âœ¨ ç°ä»£åŒ–æ•°æ®æ”¶é›† | æ™ºèƒ½å†å²è¿½è¸ª | äº‘ç«¯åŒæ­¥ âœ¨</div>
						
						<div class="action-buttons">
							<button type="button" class="btn btn-primary" id="submitBtn">ğŸ“¥ å¯¼å‡º CSV</button>
							<button type="button" class="btn btn-secondary" id="dropboxBtn">â˜ï¸ åŒæ­¥åˆ°äº‘ç«¯</button>
							<button type="button" class="btn btn-primary" id="authBtn" style="display:none;">ğŸ”— è¿æ¥ Dropbox</button>
						</div>
						
						<div class="status-bar">
							<div class="status-text">çŠ¶æ€ï¼š<span id="status">ç³»ç»Ÿå°±ç»ª</span></div>
						</div>
					</div>
					
					<div class="indicators-scroll-wrapper" id="indicatorsScroll">
						<!-- æŒ‡æ ‡é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
					</div>
				</div>
				
				<!-- éšè—çš„æ•°æ®è¡¨å• -->
				<form id="dataForm" style="display: none;">
					<input type="hidden" name="growth_cm" value="100">
					<input type="hidden" name="stem_mm" value="25">
					<input type="hidden" name="leaf_count" value="50">
					<input type="hidden" name="leaf_length_cm" value="25">
					<input type="hidden" name="leaf_width_cm" value="15">
					<input type="hidden" name="potential_flower_count" value="10">
					<input type="hidden" name="current_flower_order" value="7">
					<input type="hidden" name="accum_ear_count" value="25">
					<input type="hidden" name="accum_grain_count" value="250">
					<input type="hidden" name="yield_kg_m2" value="50">
					<input type="hidden" name="single_grain_g" value="25">
					<input type="hidden" name="total_harvest_ear_count" value="15">
					<input type="hidden" name="total_harvest_grain_g" value="1000">
					<input type="hidden" name="ear_weight_g" value="100">
					<input type="hidden" name="single_head_yield_g" value="500">
					<input type="hidden" name="brix" value="15">
					<input type="hidden" name="acidity" value="1">
					<input type="hidden" name="cracking_rate" value="25">
					<input type="hidden" name="irrigation_ml" value="2500">
					<input type="hidden" name="reflux_ml" value="1500">
					<input type="hidden" name="reflux_ec" value="5">
					<input type="hidden" name="reflux_ph" value="7">
				</form>
				
				<!-- Debug Info Section -->
				<div id="debugInfo" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin: 10px 0; font-family: monospace; font-size: 12px; display: none;">
					<div style="font-weight: bold; color: #374151; margin-bottom: 10px;">ğŸ”§ è°ƒè¯•ä¿¡æ¯</div>
					<div id="debugContent"></div>
					<button onclick="document.getElementById('debugInfo').style.display='none'" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; margin-top: 10px; cursor: pointer;">å…³é—­</button>
				</div>
			</div>
		</div>

		<div class="result" id="csvPreview" style="white-space:pre-wrap;display:none"></div>

		<script>
			// æŒ‡æ ‡æ•°æ®å®šä¹‰
			const indicators = [
				{name: 'ç”Ÿé•¿é‡', unit: 'cm', min: 0, max: 200, step: 0.1, value: 100, field: 'growth_cm'},
				{name: 'èŒç²—', unit: 'mm', min: 0, max: 50, step: 0.1, value: 25, field: 'stem_mm'},
				{name: 'å¶ç‰‡æ•°', unit: 'ä¸ª', min: 0, max: 100, step: 1, value: 50, field: 'leaf_count'},
				{name: 'å¶é•¿', unit: 'cm', min: 0, max: 50, step: 0.1, value: 25, field: 'leaf_length_cm'},
				{name: 'å¶å®½', unit: 'cm', min: 0, max: 30, step: 0.1, value: 15, field: 'leaf_width_cm'},
				{name: 'æ½œåŠ›å¼€èŠ±æ•°', unit: 'ä¸²', min: 0, max: 20, step: 1, value: 10, field: 'potential_flower_count'},
				{name: 'å½“å‰å¼€èŠ±åºæ•°', unit: 'ä¸²', min: 0, max: 15, step: 1, value: 7, field: 'current_flower_order'},
				{name: 'å•å¤´ç´¯è®¡åæœç©—æ•°', unit: 'ä¸ª', min: 0, max: 50, step: 1, value: 25, field: 'accum_ear_count'},
				{name: 'å•å¤´ç´¯è®¡åæœç²’æ•°', unit: 'ä¸ª', min: 0, max: 500, step: 1, value: 250, field: 'accum_grain_count'},
				{name: 'å•ä½äº§é‡', unit: 'kg/ã¡', min: 0, max: 100, step: 0.1, value: 50, field: 'yield_kg_m2'},
				{name: 'å•ç²’æœé‡', unit: 'g', min: 0, max: 50, step: 0.1, value: 25, field: 'single_grain_g'},
				{name: 'å•å¤´æ€»é‡‡æ”¶æœç©—æ•°', unit: 'ä¸ª', min: 0, max: 30, step: 1, value: 15, field: 'total_harvest_ear_count'},
				{name: 'å•å¤´æ€»é‡‡æ”¶æœç²’æ•°', unit: 'g', min: 0, max: 2000, step: 1, value: 1000, field: 'total_harvest_grain_g'},
				{name: 'å•ç©—é‡', unit: 'g', min: 0, max: 200, step: 0.1, value: 100, field: 'ear_weight_g'},
				{name: 'å•å¤´äº§é‡', unit: 'g', min: 0, max: 1000, step: 1, value: 500, field: 'single_head_yield_g'},
				{name: 'å¯æº¶æ€§å›ºå½¢ç‰©', unit: 'Â°Brix', min: 0, max: 30, step: 0.1, value: 15, field: 'brix'},
				{name: 'é…¸åº¦', unit: '', min: 0, max: 2, step: 0.01, value: 1, field: 'acidity'},
				{name: 'è£‚æœç‡', unit: '%', min: 0, max: 50, step: 0.1, value: 25, field: 'cracking_rate'},
				{name: 'çŒæº‰é‡', unit: 'ml', min: 0, max: 5000, step: 10, value: 2500, field: 'irrigation_ml'},
				{name: 'å›æ¶²é‡', unit: 'ml', min: 0, max: 3000, step: 10, value: 1500, field: 'reflux_ml'},
				{name: 'å›æ¶²EC', unit: 'mS/cm', min: 0, max: 10, step: 0.1, value: 5, field: 'reflux_ec'},
				{name: 'å›æ¶²PH', unit: 'pH', min: 0, max: 14, step: 0.1, value: 7, field: 'reflux_ph'}
			];
			
			let currentIndicatorIndex = 0;
			
			// åˆå§‹åŒ–æ»šåŠ¨æŒ‡æ ‡é€‰æ‹©å™¨
			function initIndicatorsScroll() {
				const scrollWrapper = document.getElementById('indicatorsScroll');
				
				// ç”ŸæˆæŒ‡æ ‡åˆ—è¡¨
				indicators.forEach((indicator, index) => {
					const item = document.createElement('div');
					item.className = 'indicator-item';
					
					const percentage = ((indicator.value - indicator.min) / (indicator.max - indicator.min)) * 100;
					
					item.innerHTML = `
						<div class="indicator-header">
							<div class="indicator-name">${indicator.name}</div>
							<div class="indicator-value-display">
								<span class="value">${indicator.value}</span>
								<span class="unit">${indicator.unit}</span>
							</div>
						</div>
						<div class="indicator-controls">
							<input type="range" class="control-range" value="${indicator.value}" 
								   min="${indicator.min}" max="${indicator.max}" step="${indicator.step}">
						</div>
					`;
					
					// æ§åˆ¶è¾“å…¥äº‹ä»¶
					const rangeInput = item.querySelector('.control-range');
					
					rangeInput.addEventListener('input', (e) => {
						const value = parseFloat(e.target.value);
						updateIndicatorValue(index, value);
					});
					
					scrollWrapper.appendChild(item);
				});
			}
			
			// æ›´æ–°æŒ‡æ ‡å€¼
			function updateIndicatorValue(index, value) {
				if (index < 0 || index >= indicators.length) return;
				
				const indicator = indicators[index];
				
				// ç¡®ä¿å€¼åœ¨èŒƒå›´å†…
				value = Math.max(indicator.min, Math.min(indicator.max, value));
				indicator.value = value;
				
				// æ›´æ–°æ˜¾ç¤ºå€¼
				const indicatorItems = document.querySelectorAll('.indicator-item');
				if (indicatorItems[index]) {
					const valueSpan = indicatorItems[index].querySelector('.value');
					if (valueSpan) valueSpan.textContent = value;
				}
				
				// æ›´æ–°éšè—è¡¨å•ä¸­çš„å¯¹åº”å­—æ®µ
				const hiddenInput = document.querySelector(`input[name="${indicator.field}"]`);
				if (hiddenInput) {
					hiddenInput.value = value;
				}
			}
			
			// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
			document.addEventListener('DOMContentLoaded', function() {
				initIndicatorsScroll();
			});

			const form = document.getElementById('dataForm');
			const submitBtn = document.getElementById('submitBtn');
			const dropboxBtn = document.getElementById('dropboxBtn');
			const authBtn = document.getElementById('authBtn');
			const statusEl = document.getElementById('status');
			const csvPreview = document.getElementById('csvPreview');

			// Dropbox App Key (ç›´æ¥æ˜æ–‡é…ç½®)
			// æ³¨æ„: åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–æœåŠ¡å™¨ç«¯é…ç½®
			const DROPBOX_APP_KEY = 'j38wp0xvibd9bjq';
			
			// Registered URLs for this app (add your URLs here)
			const REGISTERED_URLS = [
				// Local development (from project directory)
				'http://localhost:8000/',
				'http://localhost:8000/index.html',
								
				// Local development (from parent directory)
				'http://localhost:8000/deci_data_collection/',
				'http://localhost:8000/deci_data_collection/index.html',
				
				// GitHub Pages deployment
				'https://jianchaoci.github.io/deci_data_collection/',
				'https://jianchaoci.github.io/deci_data_collection/index.html'
			];
			
			let accessToken = localStorage.getItem('dropbox_access_token');

			// Debug function to show current configuration
			function showDebugInfo() {
				const currentURL = window.location.href;
				const currentOrigin = window.location.origin;
				const currentPath = window.location.pathname;
				
				// Generate predicted redirect URI
				let predictedRedirectUri;
				let uriStability = 'unknown';
				let recommendations = [];
				
				if (window.location.protocol === 'file:') {
					predictedRedirectUri = 'http://localhost:8000/';
					uriStability = 'stable';
					recommendations.push('âœ… æ¨èï¼šæœ¬åœ°æœåŠ¡å™¨è®¿é—®ï¼Œä¸å—ç½‘ç»œå˜åŒ–å½±å“');
				} else if (currentOrigin.includes('localhost') || currentOrigin.includes('127.0.0.1')) {
					// Local server access
					const currentFullPath = window.location.origin + window.location.pathname;
					if (currentFullPath.endsWith('/index.html')) {
						predictedRedirectUri = currentFullPath;
					} else if (currentFullPath.endsWith('/')) {
						predictedRedirectUri = currentFullPath;
					} else {
						predictedRedirectUri = currentFullPath + '/';
					}
					uriStability = 'stable';
					recommendations.push('âœ… æœ¬åœ°è®¿é—®ï¼šä¸å—ç½‘ç»œ/ä½ç½®å˜åŒ–å½±å“');
					recommendations.push('ğŸ“± ç§»åŠ¨ä½¿ç”¨ï¼šå¯åœ¨ä»»ä½•ç½‘ç»œç¯å¢ƒä¸‹ä½¿ç”¨');
				} else if (currentOrigin.includes('github.io') || currentOrigin.includes('netlify') || currentOrigin.includes('vercel')) {
					// Static hosting services
					const currentFullPath = window.location.origin + window.location.pathname;
					if (currentFullPath.endsWith('/index.html')) {
						predictedRedirectUri = currentFullPath;
					} else if (currentFullPath.endsWith('/')) {
						predictedRedirectUri = currentFullPath;
					} else {
						predictedRedirectUri = currentFullPath + '/';
					}
					uriStability = 'stable';
					recommendations.push('âœ… é™æ€æ‰˜ç®¡ï¼šä¸å—ç½‘ç»œ/ä½ç½®å˜åŒ–å½±å“');
					recommendations.push('ğŸŒ å…¨çƒè®¿é—®ï¼šä»»ä½•äººéƒ½å¯ä»¥ä½¿ç”¨ç›¸åŒURL');
				} else {
					// Other hosting (potentially dynamic IP)
					const currentFullPath = window.location.origin + window.location.pathname;
					if (currentFullPath.endsWith('/index.html')) {
						predictedRedirectUri = currentFullPath;
					} else if (currentFullPath.endsWith('/')) {
						predictedRedirectUri = currentFullPath;
					} else {
						predictedRedirectUri = currentFullPath + '/';
					}
					
					if (currentOrigin.match(/\d+\.\d+\.\d+\.\d+/)) {
						uriStability = 'unstable';
						recommendations.push('âš ï¸ åŠ¨æ€IPï¼šå¯èƒ½å› ç½‘ç»œå˜åŒ–è€Œå¤±æ•ˆ');
						recommendations.push('ğŸ’¡ å»ºè®®ï¼šä½¿ç”¨åŸŸåæˆ–æœ¬åœ°æœåŠ¡å™¨');
					} else {
						uriStability = 'likely-stable';
						recommendations.push('âœ… åŸŸåè®¿é—®ï¼šåº”è¯¥ç¨³å®š');
					}
				}
				
				const debugContent = document.getElementById('debugContent');
				debugContent.innerHTML = `
					<div style="margin: 5px 0;"><strong>å½“å‰é¡µé¢URL:</strong> ${currentURL}</div>
					<div style="margin: 5px 0;"><strong>Origin:</strong> ${currentOrigin}</div>
					<div style="margin: 5px 0;"><strong>Path:</strong> ${currentPath}</div>
					<div style="margin: 5px 0;"><strong>é¢„æµ‹é‡å®šå‘URI:</strong> <span style="color: #059669">${predictedRedirectUri}</span></div>
					<div style="margin: 5px 0;"><strong>APP Key:</strong> ${DROPBOX_APP_KEY}</div>
					<div style="margin: 5px 0;"><strong>Access Token:</strong> ${accessToken ? 'âœ… å·²å­˜å‚¨' : 'âŒ æœªè·å–'}</div>
					
					<div style="margin: 15px 0; padding: 10px; background: ${uriStability === 'stable' ? '#dcfce7' : uriStability === 'unstable' ? '#fecaca' : '#fef3c7'}; border-radius: 4px; border-left: 4px solid ${uriStability === 'stable' ? '#059669' : uriStability === 'unstable' ? '#dc2626' : '#f59e0b'};">
						<strong>ğŸŒ ç½‘ç»œç¯å¢ƒåˆ†æ (${uriStability === 'stable' ? 'ç¨³å®š' : uriStability === 'unstable' ? 'ä¸ç¨³å®š' : 'å¯èƒ½ç¨³å®š'}):</strong><br>
						${recommendations.map(rec => `â€¢ ${rec}`).join('<br>')}
					</div>
					
					<div style="margin: 10px 0; padding: 10px; background: #fef3c7; border-radius: 4px; border-left: 4px solid #f59e0b;">
						<strong>âš ï¸ éœ€è¦åœ¨Dropboxåº”ç”¨ä¸­é…ç½®çš„é‡å®šå‘URI:</strong><br>
						<code style="background: #1f2937; color: #e5e7eb; padding: 4px 8px; border-radius: 3px; display: inline-block; margin: 5px 0;">${predictedRedirectUri}</code><br>
						<small style="color: #92400e;">è¯·ç¡®ä¿æ­¤URIå·²æ·»åŠ åˆ°ä½ çš„Dropboxåº”ç”¨çš„"OAuth 2 é‡å®šå‘URI"è®¾ç½®ä¸­</small>
					</div>
					
					<div style="margin: 10px 0; padding: 10px; background: #eff6ff; border-radius: 4px; border-left: 4px solid #3b82f6;">
						<strong>ğŸ“‹ ä¸åŒä½¿ç”¨åœºæ™¯çš„å»ºè®®:</strong><br>
						<strong>ğŸ  å›ºå®šä½ç½®ä½¿ç”¨:</strong> å½“å‰é…ç½®å³å¯<br>
						<strong>ğŸš€ ç§»åŠ¨åŠå…¬:</strong> æ¨èä½¿ç”¨ localhost:8000 (æœ¬åœ°æœåŠ¡å™¨)<br>
						<strong>ğŸ‘¥ å›¢é˜Ÿå…±äº«:</strong> éƒ¨ç½²åˆ°å›ºå®šåŸŸå (å¦‚ GitHub Pages)<br>
						<strong>ğŸ”’ ä¼ä¸šå†…ç½‘:</strong> é…ç½®å†…ç½‘åŸŸåæˆ–å¤šä¸ªIPåœ°å€
					</div>
					
					<div style="margin: 10px 0; padding: 10px; background: #eff6ff; border-radius: 4px; border-left: 4px solid #3b82f6;">
						<strong>ğŸ“‹ é…ç½®æ­¥éª¤:</strong><br>
						1. è®¿é—® <a href="https://www.dropbox.com/developers/apps" target="_blank">Dropboxå¼€å‘è€…æ§åˆ¶å°</a><br>
						2. é€‰æ‹©ä½ çš„åº”ç”¨ â†’ è®¾ç½® â†’ OAuth 2<br>
						3. åœ¨"é‡å®šå‘URI"ä¸­æ·»åŠ ä¸Šé¢çš„URI<br>
						4. ä¿å­˜å¹¶åˆ·æ–°æ­¤é¡µé¢
					</div>
				`;
				
				document.getElementById('debugInfo').style.display = 'block';
			}

			// Update slider value display
			function updateSliderValue(slider) {
				const valueSpan = slider.parentElement.querySelector('.slider-value');
				if (valueSpan) {
					valueSpan.textContent = slider.value;
				}
				
				// åŒæ­¥æ›´æ–°æ»šåŠ¨æŒ‡æ ‡ç³»ç»Ÿä¸­çš„å¯¹åº”å€¼
				const fieldName = slider.name;
				const indicatorIndex = indicators.findIndex(ind => ind.field === fieldName);
				if (indicatorIndex !== -1) {
					updateIndicatorValue(indicatorIndex, parseFloat(slider.value));
				}
			}

			// Check if current URL is registered and show specific redirect URI guidance
			function checkURLRegistration() {
				const currentOrigin = window.location.origin;
				const currentURL = window.location.href;
				
				// Generate the exact redirect URI that OAuth will use
				let predictedRedirectUri;
				if (window.location.protocol === 'file:') {
					predictedRedirectUri = 'http://localhost:8000/';
				} else {
					const currentPath = window.location.origin + window.location.pathname;
					if (currentPath.endsWith('/index.html')) {
						predictedRedirectUri = currentPath;
					} else if (currentPath.endsWith('/')) {
						predictedRedirectUri = currentPath;
					} else {
						predictedRedirectUri = currentPath + '/';
					}
				}
				
				// Check if the exact redirect URI is registered
				const isRedirectUriRegistered = REGISTERED_URLS.includes(predictedRedirectUri);
				
				// Also check if current origin is in the registered list (for basic compatibility)
				const isOriginRegistered = REGISTERED_URLS.some(url => {
					try {
						const registeredOrigin = new URL(url).origin;
						return registeredOrigin === currentOrigin;
					} catch (e) {
						return false;
					}
				});

				if (!isRedirectUriRegistered) {
					// Show specific redirect URI configuration guidance
					const message = `ï¿½ é‡å®šå‘URIé…ç½®æç¤º\n\næ£€æµ‹åˆ°ç³»ç»Ÿå¯èƒ½é‡åˆ°"Invalid redirect_uri"é”™è¯¯ã€‚\n\nå½“å‰é¡µé¢: ${currentURL}\n\néœ€è¦åœ¨Dropboxåº”ç”¨ä¸­æ·»åŠ çš„é‡å®šå‘URI:\n${predictedRedirectUri}\n\nè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š\n1. è®¿é—® Dropboxå¼€å‘è€…æ§åˆ¶å°\n2. é€‰æ‹©ä½ çš„åº”ç”¨ â†’ è®¾ç½® â†’ OAuth 2\n3. åœ¨é‡å®šå‘URIä¸­æ·»åŠ : ${predictedRedirectUri}\n4. ä¿å­˜å¹¶åˆ·æ–°æ­¤é¡µé¢\n\nç‚¹å‡»ç¡®å®šæŸ¥çœ‹è¯¦ç»†é…ç½®æŒ‡å—`;
					
					if (confirm(message)) {
						window.open('troubleshoot.html', '_blank');
					}
					
					// Show helpful status but don't completely disable functionality
					statusEl.innerHTML = `âš ï¸ éœ€è¦é…ç½®é‡å®šå‘URI: <code style="background: #f1f5f9; padding: 2px 6px; border-radius: 3px; font-size: 12px;">${predictedRedirectUri}</code> <a href="troubleshoot.html" target="_blank" style="color: #059669; text-decoration: none; margin-left: 10px;">ğŸ“‹ æŸ¥çœ‹é…ç½®æŒ‡å—</a>`;
					
					// Don't return false - let user try anyway, they might have configured it manually
					console.warn('Redirect URI not found in registered list:', predictedRedirectUri);
					console.log('Registered URLs:', REGISTERED_URLS);
					return true; // Allow functionality but warn user
				}
				
				// All good - URI is properly registered
				console.log('âœ“ Redirect URI is registered:', predictedRedirectUri);
				return true;
			}

			// Initialize URL check
			const isURLValid = checkURLRegistration();

			// Calendar functionality
			let currentDate = new Date();
			let collectionData = {}; // Store collection history: {date: count}

			function generateCalendar(year, month) {
				const firstDay = new Date(year, month, 1);
				const lastDay = new Date(year, month + 1, 0);
				const firstDayWeek = firstDay.getDay();
				const daysInMonth = lastDay.getDate();
				
				const calendarGrid = document.getElementById('calendarGrid');
				const monthYear = document.getElementById('monthYear');
				
				// Update month/year display
				const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
				monthYear.textContent = `${year}å¹´${monthNames[month]}`;
				
				// Clear previous calendar
				calendarGrid.innerHTML = '';
				
				// Add day headers
				const dayHeaders = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
				dayHeaders.forEach(day => {
					const header = document.createElement('div');
					header.className = 'calendar-day-header';
					header.textContent = day;
					calendarGrid.appendChild(header);
				});
				
				// Add empty cells for days before month starts
				for (let i = 0; i < firstDayWeek; i++) {
					const emptyDay = document.createElement('div');
					emptyDay.className = 'calendar-day other-month';
					calendarGrid.appendChild(emptyDay);
				}
				
				// Add days of the month
				const today = new Date();
				for (let day = 1; day <= daysInMonth; day++) {
					const dayElement = document.createElement('div');
					dayElement.className = 'calendar-day';
					dayElement.textContent = day;
					
					const dayKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
					
					// Check if it's today
					if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
						dayElement.classList.add('today');
					}
					
					// Check if there's collection data for this day
					if (collectionData[dayKey]) {
						dayElement.classList.add('has-data');
						const countBadge = document.createElement('div');
						countBadge.className = 'data-count';
						countBadge.textContent = collectionData[dayKey];
						dayElement.appendChild(countBadge);
					}
					
					// Add click event listener
					dayElement.addEventListener('click', () => {
						selectDay(year, month, day, dayKey);
					});
					
					calendarGrid.appendChild(dayElement);
				}
				
				updateMonthStats(year, month);
			}

			function changeMonth(direction) {
				currentDate.setMonth(currentDate.getMonth() + direction);
				generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
			}

			function updateMonthStats(year, month) {
				const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
				let totalCollections = 0;
				let collectionDays = 0;
				let maxPerDay = 0;
				
				Object.keys(collectionData).forEach(dateKey => {
					if (dateKey.startsWith(monthKey)) {
						const count = collectionData[dateKey];
						totalCollections += count;
						collectionDays++;
						maxPerDay = Math.max(maxPerDay, count);
					}
				});
				
				document.getElementById('totalCollections').textContent = totalCollections;
				document.getElementById('collectionDays').textContent = collectionDays;
				document.getElementById('maxPerDay').textContent = maxPerDay + 'æ¬¡/å¤©';
			}

			// Load collection history from Dropbox
			async function loadCollectionHistory() {
				if (!accessToken) return;
				
				try {
					statusEl.textContent = 'æ­£åœ¨åŠ è½½é‡‡é›†å†å²...';
					
					// List all folders in Plant_Data_Collection
					const response = await fetch('https://api.dropboxapi.com/2/files/list_folder', {
						method: 'POST',
						headers: {
							'Authorization': 'Bearer ' + accessToken,
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({
							path: '/Plant_Data_Collection',
							recursive: false
						})
					});

					if (response.ok) {
						const data = await response.json();
						collectionData = {};
						
						// Process each day folder
						for (const entry of data.entries) {
							if (entry['.tag'] === 'folder') {
								const folderName = entry.name; // Format: YYYY_MM_DD
								const dateParts = folderName.split('_');
								if (dateParts.length === 3) {
									const dateKey = `${dateParts[0]}-${dateParts[1]}-${dateParts[2]}`;
									
									// Count CSV files in this folder
									const folderResponse = await fetch('https://api.dropboxapi.com/2/files/list_folder', {
										method: 'POST',
										headers: {
											'Authorization': 'Bearer ' + accessToken,
											'Content-Type': 'application/json'
										},
										body: JSON.stringify({
											path: entry.path_lower,
											recursive: false
										})
									});
									
									if (folderResponse.ok) {
										const folderData = await folderResponse.json();
										const csvCount = folderData.entries.filter(file => 
											file['.tag'] === 'file' && file.name.endsWith('.csv')
										).length;
										
										if (csvCount > 0) {
											collectionData[dateKey] = csvCount;
										}
									}
								}
							}
						}
						
						// Refresh calendar display
						generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
						statusEl.textContent = 'âœ… å†å²æ•°æ®å·²åŠ è½½';
						
					} else {
						console.log('Failed to load collection history');
						statusEl.textContent = 'âš ï¸ æ— æ³•åŠ è½½å†å²æ•°æ®';
					}
				} catch (error) {
					console.error('Error loading collection history:', error);
					statusEl.textContent = 'âŒ åŠ è½½å†å²æ•°æ®å‡ºé”™';
				}
			}

			// Record new collection
			function recordCollection() {
				const today = new Date();
				const dateKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
				
				// Increment count for today
				collectionData[dateKey] = (collectionData[dateKey] || 0) + 1;
				
				// Update calendar display
				generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
			}

			// Select a specific day and show details
			async function selectDay(year, month, day, dateKey) {
				if (!accessToken) {
					alert('è¯·å…ˆè¿æ¥Dropboxä»¥æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯');
					return;
				}

				// Remove previous selection
				document.querySelectorAll('.calendar-day').forEach(el => {
					el.classList.remove('selected');
				});

				// Highlight selected day
				event.target.classList.add('selected');

				// Show day details panel
				const dayDetails = document.getElementById('dayDetails');
				const selectedDate = document.getElementById('selectedDate');
				const dayLoading = document.getElementById('dayLoading');
				const dayResults = document.getElementById('dayResults');

				dayDetails.style.display = 'block';
				selectedDate.textContent = `${year}å¹´${month + 1}æœˆ${day}æ—¥`;
				dayLoading.style.display = 'block';
				dayResults.innerHTML = '';

				try {
					// Convert date to folder format YYYY_MM_DD
					const folderName = `${year}_${String(month + 1).padStart(2, '0')}_${String(day).padStart(2, '0')}`;
					const folderPath = `/Plant_Data_Collection/${folderName}`;

					// Query files in the specific day folder
					const response = await fetch('https://api.dropboxapi.com/2/files/list_folder', {
						method: 'POST',
						headers: {
							'Authorization': 'Bearer ' + accessToken,
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({
							path: folderPath,
							recursive: false
						})
					});

					dayLoading.style.display = 'none';

					if (response.ok) {
						const data = await response.json();
						const csvFiles = data.entries.filter(file => 
							file['.tag'] === 'file' && file.name.endsWith('.csv')
						);

						if (csvFiles.length > 0) {
							dayResults.innerHTML = `
								<div style="margin-bottom: 10px; font-weight: 600; color: #059669;">
									ğŸ“ æ‰¾åˆ° ${csvFiles.length} ä¸ªé‡‡é›†æ–‡ä»¶
								</div>
							`;

							csvFiles.forEach(file => {
								const fileTime = extractTimeFromFilename(file.name);
								const fileItem = document.createElement('div');
								fileItem.className = 'file-item';
								fileItem.innerHTML = `
									<div class="file-name">ğŸ“„ ${file.name}</div>
									<div class="file-time">${fileTime}</div>
								`;
								dayResults.appendChild(fileItem);
							});
						} else {
							dayResults.innerHTML = '<div class="no-data">ğŸ“­ è¯¥æ—¥æœŸæ²¡æœ‰é‡‡é›†æ•°æ®</div>';
						}
					} else if (response.status === 409) {
						// Folder doesn't exist
						dayResults.innerHTML = '<div class="no-data">ğŸ“­ è¯¥æ—¥æœŸæ²¡æœ‰é‡‡é›†æ•°æ®</div>';
					} else {
						dayResults.innerHTML = '<div class="no-data">âŒ æŸ¥è¯¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
					}
				} catch (error) {
					dayLoading.style.display = 'none';
					dayResults.innerHTML = '<div class="no-data">âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥</div>';
					console.error('Error querying day files:', error);
				}
			}

			// Extract time from filename like "data_2025_11_04_14_30_25.csv"
			function extractTimeFromFilename(filename) {
				const match = filename.match(/data_\d{4}_\d{2}_\d{2}_(\d{2})_(\d{2})_(\d{2})\.csv/);
				if (match) {
					const [, hour, minute, second] = match;
					return `${hour}:${minute}:${second}`;
				}
				return 'æœªçŸ¥æ—¶é—´';
			}

			function buildCSV(formData){
				const headers = [
					'timestamp','growth_cm','stem_mm','leaf_count','leaf_length_cm','leaf_width_cm',
					'potential_flower_count','current_flower_order','accum_ear_count','accum_grain_count',
					'yield_kg_m2','single_grain_g','total_harvest_ear_count','total_harvest_grain_g',
					'ear_weight_g','single_head_yield_g','brix','acidity','cracking_rate',
					'irrigation_ml','reflux_ml','reflux_ec','reflux_ph'
				];

				const row = [new Date().toISOString()];
				for(const h of headers.slice(1)){
					let v = formData.get(h);
					if(v === null || v === '') v = '';
					// escape double quotes
					if(typeof v === 'string' && v.includes(',')) v = '"'+v.replace(/"/g,'""')+'"';
					row.push(v);
				}
				const csv = headers.join(',') + '\n' + row.join(',') + '\n';
				return csv;
			}

			// Generate random string for PKCE
			function generateRandomString(length) {
				const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
				let result = '';
				for (let i = 0; i < length; i++) {
					result += chars.charAt(Math.floor(Math.random() * chars.length));
				}
				return result;
			}

			// SHA256 hash function
			async function sha256(plain) {
				const encoder = new TextEncoder();
				const data = encoder.encode(plain);
				const hash = await crypto.subtle.digest('SHA-256', data);
				return hash;
			}

			// Base64 URL encode
			function base64URLEncode(buffer) {
				const bytes = new Uint8Array(buffer);
				let binary = '';
				for (let i = 0; i < bytes.byteLength; i++) {
					binary += String.fromCharCode(bytes[i]);
				}
				return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
			}

			// Dropbox OAuth2 PKCE flow
			async function authenticateDropbox() {
				console.log('Using App Key:', DROPBOX_APP_KEY);

				// Generate the exact redirect URI that will be used
				let predictedRedirectUri;
				if (window.location.protocol === 'file:') {
					alert('æœ¬åœ°æ–‡ä»¶æ¨¡å¼ä¸‹ Dropbox OAuth æœ‰é™åˆ¶ã€‚\n\nè¯·ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ä¹‹ä¸€ï¼š\n1. å¯åŠ¨ä¸€ä¸ªç®€å•çš„æœ¬åœ°æœåŠ¡å™¨\n2. æˆ–è€…ä¸Šä¼ åˆ°ç½‘ç«™æ‰˜ç®¡æœåŠ¡\n\nç°åœ¨å°†ä¸ºæ‚¨å¯åŠ¨ä¸€ä¸ªç®€å•çš„ Python æœåŠ¡å™¨...');
					predictedRedirectUri = 'http://localhost:8000/';
				} else {
					const currentPath = window.location.origin + window.location.pathname;
					if (currentPath.endsWith('/index.html')) {
						predictedRedirectUri = currentPath;
					} else if (currentPath.endsWith('/')) {
						predictedRedirectUri = currentPath;
					} else {
						predictedRedirectUri = currentPath + '/';
					}
				}

				// Check if this exact redirect URI is registered
				// Note: We can't actually verify if it's registered in Dropbox, only remind user
				console.log('Will use redirect URI:', predictedRedirectUri);
				
				// Analyze network environment stability
				let networkStability = 'stable';
				let environmentWarning = '';
				
				if (predictedRedirectUri.includes('localhost') || predictedRedirectUri.includes('127.0.0.1')) {
					networkStability = 'stable';
					environmentWarning = 'âœ… æœ¬åœ°æœåŠ¡å™¨æ¨¡å¼ - ä¸å—ç½‘ç»œå˜åŒ–å½±å“';
				} else if (predictedRedirectUri.match(/\d+\.\d+\.\d+\.\d+/)) {
					networkStability = 'unstable';
					environmentWarning = 'âš ï¸ åŠ¨æ€IPæ¨¡å¼ - å¯èƒ½å› ç½‘ç»œå˜åŒ–è€Œå¤±æ•ˆ\nå»ºè®®ä½¿ç”¨ localhost:8000 è®¿é—®';
				} else if (predictedRedirectUri.includes('github.io') || predictedRedirectUri.includes('netlify') || predictedRedirectUri.includes('vercel')) {
					networkStability = 'stable';
					environmentWarning = 'âœ… é™æ€æ‰˜ç®¡æ¨¡å¼ - å…¨çƒç¨³å®šè®¿é—®';
				} else {
					networkStability = 'likely-stable';
					environmentWarning = 'âœ… åŸŸåè®¿é—® - åº”è¯¥ç¨³å®š';
				}
				
				// Show enhanced confirmation with network analysis
				const confirmMessage = `ğŸ”— å‡†å¤‡è¿æ¥åˆ°Dropbox\n\nå°†ä½¿ç”¨çš„é‡å®šå‘URI: ${predictedRedirectUri}\n\nç½‘ç»œç¯å¢ƒåˆ†æ: ${environmentWarning}\n\nè¯·ç¡®è®¤æ­¤URIå·²åœ¨ä½ çš„Dropboxåº”ç”¨ä¸­é…ç½®ã€‚\n\nå¦‚æœæœªé…ç½®ï¼Œä¼šå‡ºç°"Invalid redirect_uri"é”™è¯¯ã€‚\n\næ˜¯å¦ç»§ç»­è¿æ¥ï¼Ÿ`;
				
				if (!confirm(confirmMessage)) {
					// User chose to cancel and configure first
					const configMessage = `ğŸ“‹ é…ç½®ä¸ç½‘ç»œç¯å¢ƒæŒ‡å—ï¼š\n\nå½“å‰æ£€æµ‹URI: ${predictedRedirectUri}\n\nå¦‚æœç»å¸¸æ›´æ¢ç½‘ç»œç¯å¢ƒï¼Œå»ºè®®ï¼š\nâ€¢ ä½¿ç”¨ localhost:8000 (ç¨³å®š)\nâ€¢ æˆ–æŸ¥çœ‹ç½‘ç»œç¯å¢ƒé…ç½®æŒ‡å—\n\nç‚¹å‡»ç¡®å®šæŸ¥çœ‹è¯¦ç»†æŒ‡å—`;
					
					if (confirm(configMessage)) {
						showDebugInfo();
					}
					
					statusEl.innerHTML = `ğŸ”§ è¯·å…ˆé…ç½®é‡å®šå‘URI: <code style="background: #f1f5f9; padding: 2px 6px; border-radius: 3px;">${predictedRedirectUri}</code> <a href="network-guide.html" target="_blank" style="color: #059669; margin-left: 10px;">ğŸ“– ç½‘ç»œç¯å¢ƒæŒ‡å—</a>`;
					return;
				}

				// Generate PKCE parameters
				const codeVerifier = generateRandomString(128);
				const codeChallenge = base64URLEncode(await sha256(codeVerifier));
				
				// Store verifier for later use
				localStorage.setItem('dropbox_code_verifier', codeVerifier);
				
				// Use the redirect URI we already determined and checked
				const redirectUri = predictedRedirectUri;
				
				// Build authorization URL
				const authUrl = 'https://www.dropbox.com/oauth2/authorize?' +
					'client_id=' + encodeURIComponent(DROPBOX_APP_KEY) +
					'&response_type=code' +
					'&code_challenge=' + encodeURIComponent(codeChallenge) +
					'&code_challenge_method=S256' +
					'&redirect_uri=' + encodeURIComponent(redirectUri);
				
				// Debug: show what redirect URI we're using
				console.log('Using redirect URI:', redirectUri);
				console.log('Full auth URL:', authUrl);
				
				// Show helpful info to user
				const helpMessage = `å‡†å¤‡è¿æ¥åˆ°Dropbox...\n\né‡å®šå‘URI: ${redirectUri}\n\nå¦‚æœé‡åˆ°"Invalid redirect_uri"é”™è¯¯ï¼š\n1. æ‰“å¼€è¯Šæ–­å·¥å…·æ£€æŸ¥é…ç½®\n2. æˆ–è®¿é—®Dropboxå¼€å‘è€…æ§åˆ¶å°æ·»åŠ æ­¤URI`;
				console.log(helpMessage);
				
				statusEl.textContent = 'æ­£åœ¨é‡å®šå‘åˆ° Dropbox æˆæƒé¡µé¢...';
				
				window.location.href = authUrl;
			}

			// Handle OAuth callback
			async function handleOAuthCallback() {
				// Debug: show current URL and parameters
				console.log('Current URL:', window.location.href);
				console.log('URL search params:', window.location.search);
				
				const urlParams = new URLSearchParams(window.location.search);
				const code = urlParams.get('code');
				const error = urlParams.get('error');
				
				console.log('Code parameter:', code);
				console.log('Error parameter:', error);

				if (error) {
					statusEl.innerHTML = `âŒ Dropbox æˆæƒå¤±è´¥: ${error} <a href="javascript:showDebugInfo()" style="color: #dc2626; text-decoration: none; margin-left: 10px;">ğŸ” æŸ¥çœ‹é…ç½®è¯¦æƒ…</a>`;
					showDebugInfo(); // è‡ªåŠ¨æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
					return;
				}

				if (code) {
					statusEl.textContent = 'æ£€æµ‹åˆ°æˆæƒç ï¼Œæ­£åœ¨è·å–è®¿é—®ä»¤ç‰Œ...';
					console.log('Starting token exchange...');
					console.log('Token exchange using App Key:', DROPBOX_APP_KEY);
					const codeVerifier = localStorage.getItem('dropbox_code_verifier');

				// Auto-detect redirect URI (same logic as in auth function)
				let redirectUri;
				if (window.location.protocol === 'file:') {
					redirectUri = 'http://localhost:8000/';
				} else {
					const currentPath = window.location.origin + window.location.pathname;
					if (currentPath.endsWith('/index.html')) {
						redirectUri = currentPath;
					} else if (currentPath.endsWith('/')) {
						redirectUri = currentPath;
					} else {
						redirectUri = currentPath + '/';
					}
				}					try {
						const response = await fetch('https://api.dropboxapi.com/oauth2/token', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/x-www-form-urlencoded',
							},
							body: new URLSearchParams({
								code: code,
								grant_type: 'authorization_code',
								client_id: DROPBOX_APP_KEY,
								code_verifier: codeVerifier,
								redirect_uri: redirectUri
							})
						});

						if (response.ok) {
							const data = await response.json();
							accessToken = data.access_token;
							localStorage.setItem('dropbox_access_token', accessToken);
							localStorage.removeItem('dropbox_code_verifier');
							
							// Clean up URL
							window.history.replaceState({}, document.title, window.location.pathname);
							
							statusEl.textContent = 'âœ… Dropbox æˆæƒæˆåŠŸï¼';
							updateButtonStates();
							
							// Load collection history
							loadCollectionHistory();
						} else {
							const errorData = await response.json();
							statusEl.innerHTML = `âŒ è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥: ${errorData.error_description || errorData.error} <a href="javascript:showDebugInfo()" style="color: #dc2626; text-decoration: none; margin-left: 10px;">ğŸ” æŸ¥çœ‹é…ç½®è¯¦æƒ…</a>`;
							showDebugInfo(); // è‡ªåŠ¨æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
						}
					} catch (err) {
						statusEl.innerHTML = `âŒ æˆæƒè¿‡ç¨‹å‡ºé”™: ${err.message} <a href="javascript:showDebugInfo()" style="color: #dc2626; text-decoration: none; margin-left: 10px;">ğŸ” æŸ¥çœ‹é…ç½®è¯¦æƒ…</a>`;
						showDebugInfo(); // è‡ªåŠ¨æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
					}
				}
			}

			// Upload CSV to Dropbox
			async function uploadToDropbox(csv) {
				if (!accessToken) {
					statusEl.textContent = 'è¯·å…ˆè¿æ¥ Dropbox';
					return false;
				}

				statusEl.textContent = 'æ­£åœ¨ä¸Šä¼ åˆ° Dropbox...';
				
				// Generate folder name with current date and time (nian_yue_ri_h_min_s format)
				const now = new Date();
				const year = now.getFullYear();
				const month = String(now.getMonth() + 1).padStart(2, '0');
				const day = String(now.getDate()).padStart(2, '0');
				const hour = String(now.getHours()).padStart(2, '0');
				const minute = String(now.getMinutes()).padStart(2, '0');
				const second = String(now.getSeconds()).padStart(2, '0');
				
				const folderName = `${year}_${month}_${day}_${hour}_${minute}_${second}`;
				const filename = `data_${year}_${month}_${day}_${hour}_${minute}_${second}.csv`;
				
				// Create folder path: main folder/day folder/csv file
				const mainFolder = '/Plant_Data_Collection';
				const dayFolder = `${year}_${month}_${day}`;
				const dayFolderPath = `${mainFolder}/${dayFolder}`;
				const filePath = dayFolderPath + '/' + filename;

				try {
					const response = await fetch('https://content.dropboxapi.com/2/files/upload', {
						method: 'POST',
						headers: {
							'Authorization': 'Bearer ' + accessToken,
							'Content-Type': 'application/octet-stream',
							'Dropbox-API-Arg': JSON.stringify({
								path: filePath,
								mode: 'add',
								autorename: true
							})
						},
						body: csv
					});

					console.log('Upload response status:', response.status);
					console.log('Upload response headers:', [...response.headers.entries()]);

					if (response.ok) {
						const result = await response.json();
						statusEl.textContent = 'âœ… æˆåŠŸä¸Šä¼ åˆ°äº‘ç«¯: ' + result.name;
						
						// Record this collection in calendar
						recordCollection();
						
						return true;
					} else {
						// Get response text to see the actual error
						const errorText = await response.text();
						console.log('Error response text:', errorText);
						
						// Try to parse as JSON if possible
						let errorData;
						try {
							errorData = JSON.parse(errorText);
						} catch (e) {
							errorData = { error: errorText };
						}

						if (response.status === 401) {
							// Token expired, clear it
							localStorage.removeItem('dropbox_access_token');
							accessToken = null;
							updateButtonStates();
							statusEl.textContent = 'Dropbox ä»¤ç‰Œå·²è¿‡æœŸï¼Œè¯·é‡æ–°æˆæƒ';
						} else {
							statusEl.textContent = 'Dropbox ä¸Šä¼ å¤±è´¥ (' + response.status + '): ' + (errorData.error_summary || errorData.error || errorText);
						}
						return false;
					}
				} catch (err) {
					statusEl.textContent = 'Dropbox ä¸Šä¼ å‡ºé”™: ' + err.message;
					return false;
				}
			}

			// Update button states based on auth status
			function updateButtonStates() {
				if (!isURLValid) {
					dropboxBtn.style.display = 'none';
					authBtn.style.display = 'none';
					return;
				}

				if (accessToken) {
					dropboxBtn.style.display = 'inline-block';
					authBtn.style.display = 'none';
				} else {
					dropboxBtn.style.display = 'none';
					authBtn.style.display = 'inline-block';
				}
			}

			// Event listeners
			submitBtn.addEventListener('click', ()=>{
				const fd = new FormData(form);
				const csv = buildCSV(fd);
				csvPreview.style.display = 'block';
				csvPreview.textContent = csv;
				
				// Download CSV
				const blob = new Blob([csv],{type:'text/csv'});
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = 'data_' + (new Date()).toISOString().replace(/[:.]/g,'-') + '.csv';
				document.body.appendChild(a);
				a.click();
				a.remove();
				URL.revokeObjectURL(url);
				
				statusEl.textContent = 'CSV å·²ä¸‹è½½';
			});

			dropboxBtn.addEventListener('click', async ()=>{
				const fd = new FormData(form);
				const csv = buildCSV(fd);
				csvPreview.style.display = 'block';
				csvPreview.textContent = csv;
				
				await uploadToDropbox(csv);
			});

			authBtn.addEventListener('click', authenticateDropbox);

			// Initialize
			if (isURLValid) {
				// Show current redirect URI status  
				const currentPath = window.location.origin + window.location.pathname;
				let predictedRedirectUri;
				if (window.location.protocol === 'file:') {
					predictedRedirectUri = 'http://localhost:8000/';
				} else {
					if (currentPath.endsWith('/index.html')) {
						predictedRedirectUri = currentPath;
					} else if (currentPath.endsWith('/')) {
						predictedRedirectUri = currentPath;
					} else {
						predictedRedirectUri = currentPath + '/';
					}
				}
				
				// Always show the redirect URI that needs to be configured
				statusEl.innerHTML = `âœ… ç³»ç»Ÿå°±ç»ª - è¯·ç¡®ä¿é‡å®šå‘URIå·²é…ç½®: <code style="background: #f1f5f9; padding: 2px 6px; border-radius: 3px; font-size: 11px;">${predictedRedirectUri}</code> <a href="javascript:showDebugInfo()" style="color: #6b7280; text-decoration: none; margin-left: 10px; font-size: 11px;">ğŸ” æŸ¥çœ‹è¯¦æƒ…</a> <a href="network-guide.html" target="_blank" style="color: #6b7280; text-decoration: none; margin-left: 5px; font-size: 11px;">ğŸŒ ç½‘ç»œæŒ‡å—</a>`;
				
				updateButtonStates();
				handleOAuthCallback();
				
				// Generate initial calendar
				generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
				
				// Load collection history if authenticated
				if (accessToken) {
					loadCollectionHistory();
				}
			}
		</script>
	</body>
</html>
