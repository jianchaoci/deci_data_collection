<!doctype html>

<html lang="zh-CN">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>ğŸŒ± å¾—å¸Œè¡¨å‹é‡‡é›†ç³»ç»Ÿ (Supabase)</title>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<!-- Supabase JS Client -->
		<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
		<style>
			/* Deep Green Theme Design */
			* { box-sizing: border-box; }
			
		body {
			font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			margin: 0;
			padding: 0;
			background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 50%, #e0f2fe 100%);
			min-height: 100vh;
			color: #064e3b;
			display: flex;
			flex-direction: column;
		}
		
		.page-header {
			background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 50%, #e0f2fe 100%);
			color: #064e3b;
			text-align: center;
			padding: 30px 20px;
			box-shadow: 0 2px 8px rgba(5, 150, 105, 0.1);
			border-bottom: 1px solid rgba(5, 150, 105, 0.15);
		}			.page-title {
			font-size: 52px;
			font-weight: 800;
			margin: 0 0 10px 0;
			text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
			background: linear-gradient(135deg, #059669, #047857, #10b981);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
		}
		
		.page-subtitle {
			font-size: 18px;
			opacity: 1;
			margin: 0 0 25px 0;
			text-shadow: none;
			color: #047857;
			font-weight: 600;
		}			.action-buttons {
				display: flex;
				justify-content: center;
				gap: 15px;
				flex-wrap: wrap;
				margin-top: 20px;
			}
			
		.lang-switch {
			position: absolute;
			top: 20px;
			right: 20px;
			background: rgba(255, 255, 255, 0.9);
			border: 2px solid #10b981;
			border-radius: 8px;
			padding: 8px 16px;
			cursor: pointer;
			font-weight: 600;
			color: #047857;
			transition: all 0.2s ease;
		}
		
		.lang-switch:hover {
			background: #10b981;
			color: white;
		}
			
		.status-bar {
			margin-top: 20px;
			padding: 12px 20px;
			background: rgba(255, 255, 255, 0.9);
			border-radius: 12px;
			max-width: 600px;
			margin-left: auto;
			margin-right: auto;
			box-shadow: 0 2px 8px rgba(5, 150, 105, 0.15);
			border: 1px solid rgba(5, 150, 105, 0.2);
		}
		
		.status-text {
			color: #047857;
			font-weight: 600;
		}			.btn {
				padding: 12px 24px;
				border: none;
				border-radius: 12px;
				font-size: 14px;
				font-weight: 600;
				cursor: pointer;
				transition: all 0.3s ease;
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
			}
			
			.btn:hover {
				transform: translateY(-2px);
				box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
			}
			
		.btn-primary {
			background: linear-gradient(135deg, #10b981, #059669);
			color: white;
		}
		
	
	.btn-secondary {
		background: linear-gradient(135deg, #059669, #047857);
		color: white;
	}			.chart-container {
			background: rgba(255, 255, 255, 0.95);
			border-radius: 20px;
			padding: 20px;
			box-shadow: 0 8px 32px rgba(5, 150, 105, 0.12);
			border: 1px solid rgba(5, 150, 105, 0.15);
	}
	
	.chart-content {
		padding: 15px 5px;
		min-height: 270px;
		height: 270px;
	}			#trendChart {
			max-width: 100%;
			height: auto;
			display: none;
		}			.main-container {
				width: 90%;
				max-width: 1400px;
				margin: 0 auto;
				display: grid;
				grid-template-columns: 400px 1fr;
				gap: 20px;
				padding: 20px;
				align-items: start;
			}
			
		/* Left Panel - Calendar */
		.left-panel {
			background: rgba(255, 255, 255, 0.95);
			border-radius: 20px;
			padding: 20px;
			box-shadow: 0 8px 32px rgba(5, 150, 105, 0.12);
			border: 1px solid rgba(5, 150, 105, 0.15);
			display: flex;
			flex-direction: column;
			height: 500px;
		}
		
		.calendar-header {
			text-align: center;
			margin-bottom: 10px;
		}
		
		.calendar-title {
			font-size: 1.2rem;
			font-weight: 700;
			color: #047857;
			margin-bottom: 5px;
		}			.calendar-nav {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 15px;
			}
			
		.nav-btn {
			background: linear-gradient(135deg, #10b981, #059669);
			color: white;
			border: none;
			padding: 6px 12px;
			border-radius: 8px;
			cursor: pointer;
			font-size: 0.9rem;
			font-weight: 600;
			transition: all 0.2s ease;
		}
		
		.nav-btn:hover {
			transform: scale(1.05);
			box-shadow: 0 4px 8px rgba(5, 150, 105, 0.3);
		}
		
		.current-month {
			font-size: 1.1rem;
			font-weight: 700;
			color: #047857;
		}			.calendar-weekdays {
				display: grid;
				grid-template-columns: repeat(7, 1fr);
				gap: 5px;
				margin-bottom: 5px;
			}
			
		.weekday {
			text-align: center;
			font-size: 0.75rem;
			font-weight: 600;
			color: #059669;
			padding: 4px 0;
		}			.calendar-grid {
				display: grid;
				grid-template-columns: repeat(7, 1fr);
				gap: 5px;
				flex: 1;
				align-content: start;
			}
			
	.calendar-day {
		aspect-ratio: 1;
		display: flex;
		align-items: center;
		justify-content: center;
		border-radius: 8px;
		font-size: 0.85rem;
		cursor: pointer;
		transition: all 0.2s ease;
		background: #d1fae5;
		color: #064e3b;
		font-weight: 500;
		position: relative;
	}		.calendar-day:hover {
			background: #a7f3d0;
			transform: scale(1.05);
		}
		
		.calendar-day.other-month {
			color: #6ee7b7;
			opacity: 0.5;
		}
		
		.calendar-day.today {
			background: linear-gradient(135deg, #10b981, #059669);
			color: white;
			font-weight: 700;
			box-shadow: 0 2px 8px rgba(5, 150, 105, 0.4);
		}
		
		.calendar-day.has-data::after {
			content: '';
			position: absolute;
			bottom: 2px;
			width: 4px;
			height: 4px;
			background: #059669;
			border-radius: 50%;
		}			.calendar-day.today.has-data::after {
				background: white;
			}

			/* Right Panel - Data Collection */
			.right-panel {
				background: rgba(255, 255, 255, 0.9);
				border-radius: 20px;
				padding: 30px;
				box-shadow: 0 8px 32px rgba(5, 150, 105, 0.15);
				border: 1px solid rgba(5, 150, 105, 0.15);
				max-height: 500px;
				overflow-y: auto;
			}
			
			.section-title {
				font-size: 1.5rem;
				font-weight: 700;
				color: #065f46;
				margin-bottom: 20px;
				padding-bottom: 10px;
				border-bottom: 2px solid #6ee7b7;
			}
			
			.indicator-group {
				margin-bottom: 20px;
			}
			
			.indicator-label {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 8px;
			}
			
			.indicator-name {
				font-weight: 600;
				color: #064e3b;
				font-size: 0.95rem;
			}
			
			.indicator-value-display {
				font-weight: 700;
				color: #065f46;
				font-size: 0.95rem;
			}
			
			.slider-container {
				position: relative;
			}
			
			input[type="range"] {
				width: 100%;
				height: 8px;
				border-radius: 5px;
				background: linear-gradient(to right, #d1fae5, #6ee7b7);
				outline: none;
				-webkit-appearance: none;
			}
			
			input[type="range"]::-webkit-slider-thumb {
				-webkit-appearance: none;
				appearance: none;
				width: 20px;
				height: 20px;
				border-radius: 50%;
				background: linear-gradient(135deg, #10b981, #059669);
				cursor: pointer;
				box-shadow: 0 2px 6px rgba(5, 150, 105, 0.4);
			}
			
			input[type="range"]::-moz-range-thumb {
				width: 20px;
				height: 20px;
				border-radius: 50%;
				background: linear-gradient(135deg, #10b981, #059669);
				cursor: pointer;
				border: none;
				box-shadow: 0 2px 6px rgba(5, 150, 105, 0.4);
			}

			.result {
				margin-top: 30px;
				padding: 20px;
				background: rgba(209, 250, 229, 0.5);
				border-radius: 12px;
				border: 1px solid #a7f3d0;
			}

			/* Chart Controls */
			.chart-controls {
				margin-bottom: 20px;
				padding: 15px;
				background: rgba(209, 250, 229, 0.4);
				border-radius: 12px;
			}

	.chart-controls-row {
		display: flex;
		justify-content: space-between;
		align-items: center;
		gap: 10px;
		margin-bottom: 15px;
	}

	.chart-controls-row:last-child {
		margin-bottom: 0;
	}
	
	.chart-controls-row.time-controls {
		display: flex;
		justify-content: center;
		align-items: center;
		gap: 15px;
	}
	
	.chart-controls-row.time-controls > div {
		flex: 2;
		display: flex;
		justify-content: center;
		align-items: center;
		gap: 10px;
	}
	
	.indicator-select {
		flex: 0 0 200px;
		max-width: 200px;
	}			.chart-controls-row button {
				background: linear-gradient(135deg, #10b981, #059669);
				color: white;
				border: none;
				padding: 8px 16px;
				border-radius: 8px;
				cursor: pointer;
				font-size: 13px;
				font-weight: 600;
				transition: all 0.2s ease;
			}

			.chart-controls-row button:hover {
				transform: scale(1.05);
				box-shadow: 0 4px 8px rgba(5, 150, 105, 0.3);
			}

		.chart-controls-row span {
			font-size: 14px;
			font-weight: 600;
			color: #065f46;
			min-width: 120px;
			text-align: center;
		}			.indicator-select {
				padding: 8px 12px;
				border: 2px solid #6ee7b7;
				border-radius: 8px;
				font-size: 13px;
				color: #064e3b;
				background: white;
				cursor: pointer;
				transition: all 0.2s ease;
			}

			.indicator-select:focus {
				outline: none;
				border-color: #10b981;
				box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
			}

			.loading-overlay {
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: rgba(255, 255, 255, 0.9);
				display: flex;
				align-items: center;
				justify-content: center;
				border-radius: 12px;
				z-index: 10;
			}

		.loading-text {
			font-size: 16px;
			font-weight: 600;
			color: #065f46;
		}			.no-data-message {
				text-align: center;
				padding: 40px 20px;
				color: #6b7280;
				font-size: 14px;
			}

			/* Responsive Design */
			@media (max-width: 768px) {
				.main-container {
					grid-template-columns: 1fr;
				}
				
				.page-title {
					font-size: 2rem;
				}
				
				.left-panel {
					height: auto;
				}
				
				.right-panel {
					max-height: none;
				}
			}

		@media (max-width: 768px) {
			.main-container {
				width: 98%;
				padding: 10px;
			}
			
			.chart-container {
				padding: 20px 15px;
		margin: 0;
		}
		
	.chart-content {
		padding: 15px 5px;
		min-height: 200px;
		height: 200px;
	}
	}			@media (max-width: 480px) {
			.page-title {
				font-size: 1.5rem;
			}
			
			.page-subtitle {
				font-size: 12px;
			}			.btn {
				font-size: 11px;
				padding: 6px 10px;
			}
			
			.main-container {
				width: 100%;
				padding: 5px;
			}
			
		.chart-container {
			width: 100%;
		padding: 15px 10px;
		margin: 0;
	}		.chart-content {
		padding: 10px 5px;
		min-height: 240px;
		height: 240px;
	}			.chart-controls-row button {
			font-size: 10px;
			padding: 5px 8px;
		}				.chart-controls-row span {
				font-size: 11px !important;
				margin: 0 5px !important;
			}
			
			.chart-controls-row.time-controls {
				flex-direction: column;
				gap: 10px;
			}
			
			.chart-controls-row.time-controls > div {
				flex: none;
				width: 100%;
			}
			
			.indicator-select {
				flex: none;
				max-width: 100%;
				width: 100%;
				font-size: 10px;
			}
				
				.left-panel {
					overflow-y: visible;
					overflow-x: visible;
					max-height: none;
				}
				
				.right-panel {
					max-height: 450px;
					overflow-y: auto;
				}
				
				.calendar-grid {
					gap: 2px;
				}
				
				.calendar-day {
					font-size: 10px;
					padding: 1px;
				}
				
				.indicator-name {
					font-size: 11px;
				}
				
				.indicator-value-display {
					font-size: 11px;
				}
			}
		</style>
	</head>
	<body>
		<!-- Page Header -->
		<div class="page-header">
			<button class="lang-switch" id="langSwitch">EN</button>
			<h1 class="page-title" data-lang="title">ğŸŒ± å¾—å¸Œè¡¨å‹é‡‡é›†ç³»ç»Ÿ</h1>
			<p class="page-subtitle" data-lang="subtitle">ä½¿ç”¨æœ¬ç³»ç»Ÿè®°å½•å’Œç®¡ç†æ¤ç‰©è¡¨å‹æ•°æ®ï¼ŒåŠ©åŠ›ç²¾å‡†å†œä¸šç ”ç©¶ä¸åˆ†æã€‚</p>			
			<div class="action-buttons">
				<button type="button" class="btn btn-primary" id="submitBtn" data-lang="exportBtn">ğŸ“¥ å¯¼å‡º CSV</button>
				<button type="button" class="btn btn-secondary" id="syncBtn" data-lang="syncBtn">â˜ï¸ åŒæ­¥åˆ°äº‘ç«¯</button>
				<button type="button" class="btn btn-primary" id="authBtn" style="display:none;" data-lang="authBtn">ğŸ”— ç™»å½•</button>
			</div>
			
			<div class="status-bar">
				<div class="status-text"><span data-lang="statusLabel">çŠ¶æ€ï¼š</span><span id="status" data-lang="statusReady">ç³»ç»Ÿå°±ç»ª</span></div>
			</div>
		</div>
		
		<div class="main-container">
			<!-- Left Panel - Calendar -->
			<div class="left-panel">
				<div class="calendar-header">
					<h2 class="calendar-title" data-lang="calendarTitle">ğŸ“… é‡‡é›†æ—¥å†</h2>
					<div class="calendar-nav">
						<button class="nav-btn" id="prevCalMonth">â—€</button>
						<span class="current-month" id="currentCalMonth">2025å¹´1æœˆ</span>
						<button class="nav-btn" id="nextCalMonth">â–¶</button>
					</div>
				</div>
				<div class="calendar-weekdays" id="calendarWeekdays">
					<div class="weekday">æ—¥</div>
					<div class="weekday">ä¸€</div>
					<div class="weekday">äºŒ</div>
					<div class="weekday">ä¸‰</div>
					<div class="weekday">å››</div>
					<div class="weekday">äº”</div>
					<div class="weekday">å…­</div>
				</div>
				<div class="calendar-grid" id="calendarGrid"></div>
			</div>

			<!-- Right Panel - Data Input -->
			<div class="right-panel">
				<h2 class="section-title" data-lang="dataCollection">ğŸ“Š æŒ‡æ ‡é‡‡é›†</h2>
				<form id="dataForm">
					<!-- Indicators will be dynamically generated here -->
				</form>
			</div>
		</div>

		<!-- Trend Analysis Chart -->
		<div class="main-container" style="margin-top: 20px;">
			<div class="chart-container" style="grid-column: 1 / -1;">
				<h2 class="section-title" data-lang="trendAnalysis">ğŸ“ˆ è¶‹åŠ¿åˆ†æ</h2>
				<div class="chart-controls">
					<div class="chart-controls-row time-controls">
						<div>
							<button type="button" id="prevMonth" data-lang="prevMonth">â—€ ä¸Šæœˆ</button>
							<span id="chartMonthDisplay">2025å¹´1æœˆ</span>
							<button type="button" id="nextMonth" data-lang="nextMonth">ä¸‹æœˆ â–¶</button>
						</div>
						<select id="indicatorSelect" class="indicator-select">
							<option value="" data-lang="selectIndicator">é€‰æ‹©æŒ‡æ ‡...</option>
						</select>
					</div>
				</div>
				<div class="chart-content" style="position: relative;">
					<canvas id="trendChart" width="800" height="400"></canvas>
					<div id="loadingOverlay" class="loading-overlay" style="display: none;">
						<div class="loading-text" data-lang="loading">åŠ è½½ä¸­...</div>
					</div>
					<div id="noDataMessage" class="no-data-message" style="display: none;" data-lang="noData">
						æš‚æ— æ•°æ®
					</div>
				</div>
			</div>
		</div>

		<script>
		// ====================================
		// LANGUAGE CONFIGURATION
		// ====================================
		let currentLang = 'zh';
		
		const translations = {
			zh: {
				title: 'ğŸŒ± å¾—å¸Œè¡¨å‹é‡‡é›†ç³»ç»Ÿ',
				subtitle: 'ä½¿ç”¨æœ¬ç³»ç»Ÿè®°å½•å’Œç®¡ç†æ¤ç‰©è¡¨å‹æ•°æ®ï¼ŒåŠ©åŠ›ç²¾å‡†å†œä¸šç ”ç©¶ä¸åˆ†æã€‚',
				exportBtn: 'ğŸ“¥ å¯¼å‡º CSV',
				syncBtn: 'â˜ï¸ åŒæ­¥åˆ°äº‘ç«¯',
				authBtn: 'ğŸ”— ç™»å½•',
				statusLabel: 'çŠ¶æ€ï¼š',
				statusReady: 'ç³»ç»Ÿå°±ç»ª',
				calendarTitle: 'ğŸ“… é‡‡é›†æ—¥å†',
				dataCollection: 'ğŸ“Š æŒ‡æ ‡é‡‡é›†',
				trendAnalysis: 'ğŸ“ˆ è¶‹åŠ¿åˆ†æ',
				prevMonth: 'â—€ ä¸Šæœˆ',
				nextMonth: 'ä¸‹æœˆ â–¶',
				selectIndicator: 'é€‰æ‹©æŒ‡æ ‡...',
				loading: 'åŠ è½½ä¸­...',
				noData: 'æš‚æ— æ•°æ®',
				weekdays: ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'],
				indicators: {
					growth_cm: 'ç”Ÿé•¿é‡',
					stem_mm: 'èŒç²—',
					leaf_count: 'å¶ç‰‡æ•°',
					leaf_length_cm: 'å¶é•¿',
					leaf_width_cm: 'å¶å®½',
					potential_flower_count: 'æ½œåœ¨èŠ±æ•°',
					current_flower_order: 'å½“å‰èŠ±åº',
					accum_ear_count: 'ç´¯è®¡ç©—æ•°',
					accum_grain_count: 'ç´¯è®¡ç²’æ•°',
					yield_kg_m2: 'äº§é‡',
					single_grain_g: 'å•ç²’é‡',
					total_harvest_ear_count: 'æ€»æ”¶è·ç©—æ•°',
					total_harvest_grain_g: 'æ€»æ”¶è·ç²’é‡',
					ear_weight_g: 'ç©—é‡',
					single_head_yield_g: 'å•å¤´äº§é‡',
					brix: 'ç³–åº¦',
					acidity: 'é…¸åº¦',
					cracking_rate: 'è£‚æœç‡',
					irrigation_ml: 'çŒæº‰é‡',
					reflux_ml: 'å›æµé‡',
					reflux_ec: 'å›æµEC',
					reflux_ph: 'å›æµpH'
				}
			},
			en: {
				title: 'ğŸŒ± Dexi Phenotype Collection System',
				subtitle: 'Record and manage plant phenotype data for precision agriculture research and analysis.',
				exportBtn: 'ğŸ“¥ Export CSV',
				syncBtn: 'â˜ï¸ Sync to Cloud',
				authBtn: 'ğŸ”— Login',
				statusLabel: 'Status: ',
				statusReady: 'System Ready',
				calendarTitle: 'ğŸ“… Collection Calendar',
				dataCollection: 'ğŸ“Š Data Collection',
				trendAnalysis: 'ğŸ“ˆ Trend Analysis',
				prevMonth: 'â—€ Prev',
				nextMonth: 'Next â–¶',
				selectIndicator: 'Select Indicator...',
				loading: 'Loading...',
				noData: 'No Data',
				weekdays: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
				indicators: {
					growth_cm: 'Growth',
					stem_mm: 'Stem Diameter',
					leaf_count: 'Leaf Count',
					leaf_length_cm: 'Leaf Length',
					leaf_width_cm: 'Leaf Width',
					potential_flower_count: 'Potential Flowers',
					current_flower_order: 'Current Flower Order',
					accum_ear_count: 'Accumulated Ears',
					accum_grain_count: 'Accumulated Grains',
					yield_kg_m2: 'Yield',
					single_grain_g: 'Single Grain Weight',
					total_harvest_ear_count: 'Total Harvest Ears',
					total_harvest_grain_g: 'Total Harvest Grain Weight',
					ear_weight_g: 'Ear Weight',
					single_head_yield_g: 'Single Head Yield',
					brix: 'Brix',
					acidity: 'Acidity',
					cracking_rate: 'Cracking Rate',
					irrigation_ml: 'Irrigation',
					reflux_ml: 'Reflux',
					reflux_ec: 'Reflux EC',
					reflux_ph: 'Reflux pH'
				}
			}
		};
		
		function switchLanguage() {
			currentLang = currentLang === 'zh' ? 'en' : 'zh';
			document.getElementById('langSwitch').textContent = currentLang === 'zh' ? 'EN' : 'ä¸­æ–‡';
			updateLanguage();
		}
		
		function updateLanguage() {
			const lang = translations[currentLang];
			
			// Update all elements with data-lang attribute
			document.querySelectorAll('[data-lang]').forEach(el => {
				const key = el.getAttribute('data-lang');
				if (lang[key]) {
					el.textContent = el.textContent.replace(/[^ğŸŒ±ğŸ“…ğŸ“ŠğŸ“ˆğŸ“¥â˜ï¸ğŸ”—â—€â–¶]/g, '') + lang[key].replace(/[ğŸŒ±ğŸ“…ğŸ“ŠğŸ“ˆğŸ“¥â˜ï¸ğŸ”—â—€â–¶]/g, '');
				}
			});
			
			// Update weekdays
			const weekdayElements = document.querySelectorAll('#calendarWeekdays .weekday');
			weekdayElements.forEach((el, index) => {
				el.textContent = lang.weekdays[index];
			});
			
			// Update title
			document.title = lang.title;
			
			// Refresh indicators with new language
			indicators = getIndicators();
			
			// Regenerate form with new language
			generateForm();
			
			// Update chart indicator dropdown
			updateChartIndicators();
			
			// Update chart month display
			updateChartMonthDisplay();
			generateCalendar(currentCalDate.getFullYear(), currentCalDate.getMonth());
		}
		
		// ====================================
		// SUPABASE CONFIGURATION
		// ====================================
		const SUPABASE_URL = 'https://fnahnjojeiwclyixcyia.supabase.co';
		const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZuYWhuam9qZWl3Y2x5aXhjeWlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0NDQxMDksImV4cCI6MjA3ODAyMDEwOX0.7ftrvq8MAsAepwrRll0lcHDkXBt7MClgIgXsBn2KED8';
		
		// Initialize Supabase client
		const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
		// ====================================
		// DATA CONFIGURATION
		// ====================================
			const indicatorsConfig = [
				{field:'growth_cm', unit:'cm', unitEn:'cm', min:0, max:200, step:0.1, defaultValue:0},
				{field:'stem_mm', unit:'mm', unitEn:'mm', min:0, max:100, step:0.1, defaultValue:0},
				{field:'leaf_count', unit:'ç‰‡', unitEn:'pcs', min:0, max:500, step:1, defaultValue:0},
				{field:'leaf_length_cm', unit:'cm', unitEn:'cm', min:0, max:100, step:0.1, defaultValue:0},
				{field:'leaf_width_cm', unit:'cm', unitEn:'cm', min:0, max:50, step:0.1, defaultValue:0},
				{field:'potential_flower_count', unit:'æœµ', unitEn:'pcs', min:0, max:200, step:1, defaultValue:0},
				{field:'current_flower_order', unit:'åº', unitEn:'order', min:0, max:50, step:1, defaultValue:0},
				{field:'accum_ear_count', unit:'ç©—', unitEn:'ears', min:0, max:100, step:1, defaultValue:0},
				{field:'accum_grain_count', unit:'ç²’', unitEn:'grains', min:0, max:1000, step:1, defaultValue:0},
				{field:'yield_kg_m2', unit:'kg/mÂ²', unitEn:'kg/mÂ²', min:0, max:50, step:0.01, defaultValue:0},
				{field:'single_grain_g', unit:'g', unitEn:'g', min:0, max:10, step:0.001, defaultValue:0},
				{field:'total_harvest_ear_count', unit:'ç©—', unitEn:'ears', min:0, max:100, step:1, defaultValue:0},
				{field:'total_harvest_grain_g', unit:'g', unitEn:'g', min:0, max:5000, step:0.1, defaultValue:0},
				{field:'ear_weight_g', unit:'g', unitEn:'g', min:0, max:500, step:0.1, defaultValue:0},
				{field:'single_head_yield_g', unit:'g', unitEn:'g', min:0, max:200, step:0.1, defaultValue:0},
				{field:'brix', unit:'Â°Bx', unitEn:'Â°Bx', min:0, max:30, step:0.1, defaultValue:0},
				{field:'acidity', unit:'%', unitEn:'%', min:0, max:5, step:0.01, defaultValue:0},
				{field:'cracking_rate', unit:'%', unitEn:'%', min:0, max:100, step:0.1, defaultValue:0},
				{field:'irrigation_ml', unit:'ml', unitEn:'ml', min:0, max:10000, step:1, defaultValue:0},
				{field:'reflux_ml', unit:'ml', unitEn:'ml', min:0, max:10000, step:1, defaultValue:0},
				{field:'reflux_ec', unit:'mS/cm', unitEn:'mS/cm', min:0, max:10, step:0.01, defaultValue:0},
				{field:'reflux_ph', unit:'pH', unitEn:'pH', min:0, max:14, step:0.01, defaultValue:0}
			];
			
			// Get indicators with current language
			function getIndicators() {
				const lang = translations[currentLang];
				return indicatorsConfig.map(ind => ({
					...ind,
					name: lang.indicators[ind.field],
					unit: currentLang === 'zh' ? ind.unit : ind.unitEn
				}));
			}
			
			let indicators = getIndicators();

			// Helper function to get Beijing time (UTC+8)
			function getBeijingTime() {
				const now = new Date();
				const utcTime = now.getTime() + (now.getTimezoneOffset() * 60000);
				const beijingTime = new Date(utcTime + (8 * 3600000));
				return beijingTime;
			}
			
			let currentIndicatorIndex = 0;
			let trendChart = null;
			let currentChartDate = getBeijingTime();
			let currentTrendField = null;
			let currentCalDate = getBeijingTime();
			let collectionData = {}; // {YYYY-MM-DD: count}
			let currentUser = null;

			// DOM Elements
			const form = document.getElementById('dataForm');
			const statusEl = document.getElementById('status');
			const submitBtn = document.getElementById('submitBtn');
			const syncBtn = document.getElementById('syncBtn');
			const authBtn = document.getElementById('authBtn');

			// ====================================
			// AUTHENTICATION
			// ====================================
			async function initAuth() {
				// Check if user is already logged in
				const { data: { session } } = await supabase.auth.getSession();
				
				if (session) {
					currentUser = session.user;
					statusEl.textContent = 'âœ… å·²ç™»å½•';
					syncBtn.style.display = 'inline-block';
					authBtn.style.display = 'none';
					await loadCollectionHistory();
				} else {
					statusEl.textContent = 'è¯·ç™»å½•ä»¥åŒæ­¥æ•°æ®';
					syncBtn.style.display = 'none';
					authBtn.style.display = 'inline-block';
				}
			}

		async function signIn() {
			// Email/password login
			const email = prompt('è¯·è¾“å…¥é‚®ç®±:');
			const password = prompt('è¯·è¾“å…¥å¯†ç :');
			
			if (!email || !password) return;
			
			statusEl.textContent = 'æ­£åœ¨ç™»å½•...';
			
			// Try to sign in first
			const { data, error } = await supabase.auth.signInWithPassword({
				email: email,
				password: password
			});
			
			if (error) {
				// If user doesn't exist, try to sign up
				statusEl.textContent = 'æ­£åœ¨æ³¨å†Œ...';
				const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
					email: email,
					password: password
				});
				
				if (signUpError) {
					statusEl.textContent = 'âŒ æ³¨å†Œå¤±è´¥: ' + signUpError.message;
					return;
				}
				
				// Check if session is available (email confirmation disabled)
				if (signUpData.session && signUpData.user) {
					currentUser = signUpData.user;
					statusEl.textContent = 'âœ… æ³¨å†ŒæˆåŠŸå¹¶å·²ç™»å½•';
					
					syncBtn.style.display = 'inline-block';
					authBtn.style.display = 'none';
					await loadCollectionHistory();
				} else {
					statusEl.textContent = 'âŒ æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¡®ä¿å·²ç¦ç”¨é‚®ç®±éªŒè¯';
					alert('è¯·åœ¨ Supabase æ§åˆ¶å°çš„ Authentication â†’ Providers â†’ Email ä¸­ç¦ç”¨ "Confirm email" é€‰é¡¹');
				}
			} else {
				// Successful login
				currentUser = data.user;
				statusEl.textContent = 'âœ… ç™»å½•æˆåŠŸ';
				
				syncBtn.style.display = 'inline-block';
				authBtn.style.display = 'none';
				await loadCollectionHistory();
			}
		}			// ====================================
			// FORM GENERATION
			// ====================================
			function generateForm() {
				// Clear existing form
				form.innerHTML = '';
				
				indicators.forEach((indicator, index) => {
					const group = document.createElement('div');
					group.className = 'indicator-group';
					
					const label = document.createElement('div');
					label.className = 'indicator-label';
					
					const nameSpan = document.createElement('span');
					nameSpan.className = 'indicator-name';
					nameSpan.textContent = `${indicator.name} (${indicator.unit})`;
					
					const valueSpan = document.createElement('span');
					valueSpan.className = 'indicator-value-display';
					valueSpan.id = `value-${indicator.field}`;
					valueSpan.textContent = indicator.defaultValue;
					
					label.appendChild(nameSpan);
					label.appendChild(valueSpan);
					
					const sliderContainer = document.createElement('div');
					sliderContainer.className = 'slider-container';
					
					const slider = document.createElement('input');
					slider.type = 'range';
					slider.name = indicator.field;
					slider.min = indicator.min;
					slider.max = indicator.max;
					slider.step = indicator.step;
					slider.value = indicator.defaultValue;
					slider.id = `slider-${indicator.field}`;
					
					slider.addEventListener('input', (e) => {
						valueSpan.textContent = e.target.value;
					});
					
					sliderContainer.appendChild(slider);
					group.appendChild(label);
					group.appendChild(sliderContainer);
					form.appendChild(group);
				});
			}

			// ====================================
			// CALENDAR
			// ====================================
			function generateCalendar(year, month) {
				const grid = document.getElementById('calendarGrid');
				grid.innerHTML = '';
				
				const firstDay = new Date(year, month, 1);
				const lastDay = new Date(year, month + 1, 0);
				const daysInMonth = lastDay.getDate();
				const startingDayOfWeek = firstDay.getDay();
				
				const monthNames = currentLang === 'zh'
					? ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ']
					: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
				const display = currentLang === 'zh'
					? `${year}å¹´${monthNames[month]}`
					: `${monthNames[month]} ${year}`;
				document.getElementById('currentCalMonth').textContent = display;
				
				const prevMonthDays = new Date(year, month, 0).getDate();
				for (let i = startingDayOfWeek - 1; i >= 0; i--) {
					const dayElement = document.createElement('div');
					dayElement.className = 'calendar-day other-month';
					dayElement.textContent = prevMonthDays - i;
					grid.appendChild(dayElement);
				}
				
				const today = getBeijingTime();
				for (let day = 1; day <= daysInMonth; day++) {
					const dayElement = document.createElement('div');
					dayElement.className = 'calendar-day';
					dayElement.textContent = day;
					
					if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
						dayElement.classList.add('today');
					}
					
					const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
					if (collectionData[dateKey]) {
						dayElement.classList.add('has-data');
					}
					
					grid.appendChild(dayElement);
				}
				
				const totalCells = startingDayOfWeek + daysInMonth;
				const remainingCells = 7 - (totalCells % 7);
				if (remainingCells < 7) {
					for (let i = 1; i <= remainingCells; i++) {
						const dayElement = document.createElement('div');
						dayElement.className = 'calendar-day other-month';
						dayElement.textContent = i;
						grid.appendChild(dayElement);
					}
				}
			}

			document.getElementById('prevCalMonth').addEventListener('click', () => {
				currentCalDate.setMonth(currentCalDate.getMonth() - 1);
				generateCalendar(currentCalDate.getFullYear(), currentCalDate.getMonth());
			});

			document.getElementById('nextCalMonth').addEventListener('click', () => {
				currentCalDate.setMonth(currentCalDate.getMonth() + 1);
				generateCalendar(currentCalDate.getFullYear(), currentCalDate.getMonth());
			});

			// ====================================
			// CHART FUNCTIONS
			// ====================================
			async function initChart() {
				const indicatorSelect = document.getElementById('indicatorSelect');
				indicators.forEach((indicator) => {
					const option = document.createElement('option');
					option.value = indicator.field;
					option.textContent = `${indicator.name} (${indicator.unit})`;
					indicatorSelect.appendChild(option);
				});

			indicatorSelect.addEventListener('change', handleIndicatorChange);
			document.getElementById('prevMonth').addEventListener('click', () => changeChartMonth(-1));
			document.getElementById('nextMonth').addEventListener('click', () => changeChartMonth(1));

			updateChartMonthDisplay();
			indicatorSelect.value = 'growth_cm';
			// Load trend data after authentication
			const { data: { session } } = await supabase.auth.getSession();
			if (session) {
				loadTrendData('growth_cm');
			}
		}			function updateChartMonthDisplay() {
				const monthNames = currentLang === 'zh' 
					? ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ']
					: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
				const display = currentLang === 'zh'
					? `${currentChartDate.getFullYear()}å¹´${monthNames[currentChartDate.getMonth()]}`
					: `${monthNames[currentChartDate.getMonth()]} ${currentChartDate.getFullYear()}`;
				document.getElementById('chartMonthDisplay').textContent = display;
			}
			
			function updateChartIndicators() {
				const indicatorSelect = document.getElementById('indicatorSelect');
				const currentValue = indicatorSelect.value;
				
				// Clear existing options
				indicatorSelect.innerHTML = '';
				
				// Add new options with current language
				indicators.forEach((indicator) => {
					const option = document.createElement('option');
					option.value = indicator.field;
					option.textContent = `${indicator.name} (${indicator.unit})`;
					indicatorSelect.appendChild(option);
				});
				
				// Restore selected value
				if (currentValue) {
					indicatorSelect.value = currentValue;
				}
			}

		async function changeChartMonth(direction) {
			currentChartDate.setMonth(currentChartDate.getMonth() + direction);
			updateChartMonthDisplay();
			
			const selectedField = document.getElementById('indicatorSelect').value;
			if (selectedField) {
				loadTrendData(selectedField);
			}
		}

		async function handleIndicatorChange() {
			const selectedField = document.getElementById('indicatorSelect').value;
			if (selectedField) {
				currentTrendField = selectedField;
				await loadTrendData(selectedField);
			} else {
				currentTrendField = null;
				showNoDataMessage();
			}
		}		async function loadTrendData(field) {
			const { data: { session } } = await supabase.auth.getSession();
			if (!session || !session.user) {
				showNoDataMessage();
				return;
			}
			
			currentTrendField = field;
			showLoading(true);
			
			const year = currentChartDate.getFullYear();
			const month = currentChartDate.getMonth();
			const startDate = `${year}-${String(month + 1).padStart(2, '0')}-01`;
			const endDate = new Date(year, month + 1, 0);
			const endDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(endDate.getDate()).padStart(2, '0')}`;
			
			try {
				// Query data from Supabase
				const { data, error } = await supabase
					.from('plant_data')
					.select('date, data')
					.eq('user_id', session.user.id)
					.gte('date', startDate)
					.lte('date', endDateStr)
					.order('date', { ascending: true });					if (error) throw error;
					
					// Prepare chart data
					const daysInMonth = endDate.getDate();
					const dates = [];
					const values = [];
					const dataMap = {};
					
				// Map existing data
				if (data) {
					data.forEach(row => {
						const day = new Date(row.date).getDate();
						dataMap[day] = row.data[field] || 0;
					});
				}
				
				// Fill in all days
				for (let day = 1; day <= daysInMonth; day++) {
					dates.push(String(day));
					values.push(dataMap[day] !== undefined ? dataMap[day] : 0);
				}					createTrendChart(dates, values, field);
					showLoading(false);
				} catch (error) {
					console.error('Error loading trend data:', error);
					statusEl.textContent = 'âŒ åŠ è½½è¶‹åŠ¿æ•°æ®å¤±è´¥';
					showLoading(false);
					showNoDataMessage();
				}
			}

			function createTrendChart(dates, values, field) {
				const ctx = document.getElementById('trendChart').getContext('2d');
				const indicator = indicators.find(ind => ind.field === field);
				
				if (trendChart) {
					trendChart.destroy();
				}
				
				const isMobile = window.innerWidth <= 768;
				const maxTicks = isMobile ? 10 : 31;
				
				trendChart = new Chart(ctx, {
					type: 'line',
					data: {
						labels: dates,
						datasets: [{
							label: `${indicator.name} (${indicator.unit})`,
							data: values,
							borderColor: '#22c55e',
							backgroundColor: 'rgba(34, 197, 94, 0.1)',
							tension: 0.4,
							fill: true,
							pointRadius: 4,
							pointHoverRadius: 6
						}]
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						scales: {
							y: {
								beginAtZero: true,
								title: {
									display: true,
									text: `${indicator.name} (${indicator.unit})`
								}
							},
							x: {
								title: {
									display: true,
									text: 'æ—¥æœŸ'
								},
								ticks: {
									maxTicksLimit: maxTicks
								}
							}
						},
						plugins: {
							legend: {
								display: false
							}
						}
					}
				});
				
				document.getElementById('trendChart').style.display = 'block';
			}

			function showLoading(show) {
				document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
				document.getElementById('trendChart').style.display = show ? 'none' : 'block';
				document.getElementById('noDataMessage').style.display = 'none';
			}

			function showNoDataMessage() {
				document.getElementById('trendChart').style.display = 'none';
				document.getElementById('loadingOverlay').style.display = 'none';
				document.getElementById('noDataMessage').style.display = 'block';
				
				if (trendChart) {
					trendChart.destroy();
					trendChart = null;
				}
			}

		// ====================================
		// LOAD TODAY'S DATA
		// ====================================
		async function loadTodayData() {
			const { data: { session } } = await supabase.auth.getSession();
			if (!session || !session.user) return;
			
			const today = getBeijingTime();
			const dateKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
			
			try {
				const { data, error } = await supabase
					.from('plant_data')
					.select('data')
					.eq('user_id', session.user.id)
					.eq('date', dateKey)
					.single();					if (error) {
						// No data for today, keep defaults
						console.log('No data for today, using defaults');
						return;
					}
					
					if (data && data.data) {
						// Load the data into sliders
						indicators.forEach(indicator => {
							const slider = document.getElementById(`slider-${indicator.field}`);
							const valueDisplay = document.getElementById(`value-${indicator.field}`);
							const value = data.data[indicator.field];
							
							if (value !== undefined && value !== null) {
								slider.value = value;
								valueDisplay.textContent = value;
							}
						});
						
						console.log('Loaded today\'s data');
					}
				} catch (error) {
					console.error('Error loading today\'s data:', error);
				}
			}

		// ====================================
		// LOAD COLLECTION HISTORY
		// ====================================
		async function loadCollectionHistory() {
			const { data: { session } } = await supabase.auth.getSession();
			if (!session || !session.user) return;
			
			try {
				const { data, error } = await supabase
					.from('plant_data')
					.select('date')
					.eq('user_id', session.user.id);					if (error) throw error;
					
					collectionData = {};
					if (data) {
						data.forEach(row => {
							collectionData[row.date] = 1;
						});
					}
					
					generateCalendar(currentCalDate.getFullYear(), currentCalDate.getMonth());
				} catch (error) {
					console.error('Error loading collection history:', error);
				}
			}

			// ====================================
			// DATA SYNC TO SUPABASE
			// ====================================
		async function syncToSupabase() {
			// Get current session to ensure we have the latest user
			const { data: { session }, error: sessionError } = await supabase.auth.getSession();
			
			if (!session || !session.user) {
				statusEl.textContent = 'è¯·å…ˆç™»å½•';
				return false;
			}
			
			const userId = session.user.id;
			statusEl.textContent = 'æ­£åœ¨åŒæ­¥åˆ°äº‘ç«¯...';
			
			const now = getBeijingTime();
			const dateKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
			
			// Collect form data
			const formData = {};
			indicators.forEach(indicator => {
				const slider = document.getElementById(`slider-${indicator.field}`);
				formData[indicator.field] = parseFloat(slider.value);
			});
			
			try {
				// Check if record exists (use maybeSingle instead of single to avoid error when no data)
				const { data: existing, error: selectError } = await supabase
					.from('plant_data')
					.select('id')
					.eq('user_id', userId)
					.eq('date', dateKey)
					.maybeSingle();
				
				// Ignore "not found" errors
				if (selectError && selectError.code !== 'PGRST116') {
					throw selectError;
				}
				
				let result;
				if (existing) {
					// Update existing record
					const { data, error } = await supabase
						.from('plant_data')
						.update({
							data: formData,
							updated_at: new Date().toISOString()
						})
						.eq('id', existing.id)
						.select();
					
					if (error) throw error;
					result = data;
					console.log('Updated existing record');
				} else {
					// Insert new record
					const { data, error } = await supabase
						.from('plant_data')
						.insert([{
							user_id: userId,
							date: dateKey,
							data: formData,
							created_at: new Date().toISOString(),
							updated_at: new Date().toISOString()
						}])
						.select();
					
					if (error) throw error;
				result = data;
			}					statusEl.textContent = 'âœ… æˆåŠŸåŒæ­¥åˆ°äº‘ç«¯';
				
				// Update calendar
				collectionData[dateKey] = 1;
				generateCalendar(currentCalDate.getFullYear(), currentCalDate.getMonth());
				
				// Refresh trend chart if showing current month
				if (currentTrendField) {
					const uploadYear = now.getFullYear();
					const uploadMonth = now.getMonth();
					const chartYear = currentChartDate.getFullYear();
					const chartMonth = currentChartDate.getMonth();
					
					if (uploadYear === chartYear && uploadMonth === chartMonth) {
						await loadTrendData(currentTrendField);
					}
				}					return true;
				} catch (error) {
					console.error('Error syncing to Supabase:', error);
					statusEl.textContent = 'âŒ åŒæ­¥å¤±è´¥: ' + error.message;
					return false;
				}
			}

			// ====================================
			// EXPORT CSV
			// ====================================
			function buildCSV() {
				const headers = [
					'timestamp','growth_cm','stem_mm','leaf_count','leaf_length_cm','leaf_width_cm',
					'potential_flower_count','current_flower_order','accum_ear_count','accum_grain_count',
					'yield_kg_m2','single_grain_g','total_harvest_ear_count','total_harvest_grain_g',
					'ear_weight_g','single_head_yield_g','brix','acidity','cracking_rate',
					'irrigation_ml','reflux_ml','reflux_ec','reflux_ph'
				];

				const row = [getBeijingTime().toISOString()];
				indicators.forEach(indicator => {
					const slider = document.getElementById(`slider-${indicator.field}`);
					row.push(slider.value);
				});
				
				const csv = headers.join(',') + '\n' + row.join(',') + '\n';
				return csv;
			}

			function exportCSV() {
				const csv = buildCSV();
				
				const blob = new Blob([csv], {type: 'text/csv'});
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = 'data_' + getBeijingTime().toISOString().replace(/[:.]/g, '-') + '.csv';
				document.body.appendChild(a);
				a.click();
				a.remove();
				URL.revokeObjectURL(url);
				
				statusEl.textContent = 'CSV å·²ä¸‹è½½';
			}

			// ====================================
			// EVENT LISTENERS
			// ====================================
			submitBtn.addEventListener('click', exportCSV);
			syncBtn.addEventListener('click', syncToSupabase);
			authBtn.addEventListener('click', signIn);

			// ====================================
			// INITIALIZATION
			// ====================================
			async function init() {
				// Set up language switch button
				document.getElementById('langSwitch').addEventListener('click', switchLanguage);
				
				generateForm();
				generateCalendar(currentCalDate.getFullYear(), currentCalDate.getMonth());
				await initChart();
				await initAuth();
				
				// Load today's data if user is logged in
				const { data: { session } } = await supabase.auth.getSession();
				if (session) {
					await loadTodayData();
				}
			}

			// Start the app
			init();
		</script>
	</body>
</html>
