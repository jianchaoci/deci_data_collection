<!doctype html>

<html lang="zh-CN">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>ğŸŒ± å¾—å¸Œè¡¨å‹é‡‡é›†ç³»ç»Ÿ</title>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<style>
			/* Light Green Theme Design */
			* { box-sizing: border-box; }
			
			body {
				font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
				margin: 0;
				padding: 0;
				background: linear-gradient(135deg, #e8f5e8 0%, #f0fdf4 50%, #dcfce7 100%);
				min-height: 100vh;
				color: #1f2937;
				display: flex;
				flex-direction: column;
			}
			
			.page-header {
				background: linear-gradient(135deg, #e8f5e8 0%, #f0fdf4 50%, #dcfce7 100%);
				color: #1f2937;
				text-align: center;
				padding: 30px 20px;
				box-shadow: 0 4px 20px rgba(34, 197, 94, 0.2);
			}
			
			.page-title {
				font-size: 42px;
				font-weight: 700;
				margin: 0 0 10px 0;
				text-shadow: none;
			}
			
			.page-subtitle {
				font-size: 16px;
				opacity: 0.8;
				margin: 0 0 25px 0;
				text-shadow: none;
			}
			
			.action-buttons {
				display: flex;
				gap: 15px;
				justify-content: center;
				margin: 20px 0;
				flex-wrap: wrap;
			}
			
			.status-bar {
				background: rgba(34, 197, 94, 0.15);
				border-radius: 8px;
				padding: 10px 20px;
				margin: 15px auto 0;
				max-width: 400px;
				font-size: 16px;
				word-break: break-word;
			}
			
			.status-text {
				color: #1f2937;
				font-weight: 500;
				overflow-wrap: break-word;
			}

			/* å›¾è¡¨å®¹å™¨æ ·å¼ */
			.chart-container {
				width: 90%;
				max-width: 1400px;
				margin: 0 auto 20px;
				background: rgba(255, 255, 255, 0.9);
				border-radius: 20px;
				padding: 20px;
				box-shadow: 0 8px 32px rgba(102, 126, 234, 0.1);
				border: 1px solid rgba(102, 126, 234, 0.1);
				overflow-x: auto;
			}
			
			.chart-content {
				min-width: 300px;
			}

			.chart-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 20px;
				flex-wrap: wrap;
				gap: 15px;
			}

			.chart-header h3 {
				margin: 0;
				color: #374151;
				font-size: 1.4rem;
			}

			.chart-controls {
				display: flex;
				flex-direction: column;
				gap: 10px;
			}
			
			.chart-controls-row {
				display: flex;
				align-items: center;
				gap: 10px;
				justify-content: center;
			}

			.indicator-select {
				padding: 8px 12px;
				border: 1px solid #d1d5db;
				border-radius: 6px;
				font-size: 14px;
				background: white;
				min-width: 150px;
				max-width: 100%;
			}

			.chart-content {
				position: relative;
				background: white;
				border-radius: 12px;
				padding: 20px;
				min-height: 400px;
				display: flex;
				align-items: center;
				justify-content: center;
			}

			.chart-loading, .no-data-message {
				text-align: center;
				color: #6b7280;
				font-size: 16px;
			}

			.loading-spinner {
				font-size: 24px;
				margin-bottom: 10px;
			}

			#trendChart {
				max-width: 100%;
				height: auto;
				display: none;
			}

			.main-container {
				width: 90%;
				max-width: 1400px;
				margin: 0 auto;
				display: grid;
				grid-template-columns: 400px 1fr;
				gap: 20px;
				padding: 20px;
				align-items: start;
			}
			
			/* Left Panel - Calendar */
			.left-panel {
				background: rgba(255, 255, 255, 0.9);
				border-radius: 20px;
				padding: 20px;
				box-shadow: 0 8px 32px rgba(34, 197, 94, 0.1);
				border: 1px solid rgba(34, 197, 94, 0.1);
				display: flex;
				flex-direction: column;
				height: 600px;
			}
			
			.calendar-header {
				text-align: center;
				margin-bottom: 10px;
			}
			
			.calendar-title {
				font-size: 1.2rem;
				font-weight: 700;
				color: #15803d;
				margin-bottom: 5px;
			}
			
			.calendar-nav {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 15px;
			}
			
			.nav-btn {
				background: linear-gradient(135deg, #22c55e, #16a34a);
				color: white;
				border: none;
				padding: 8px 12px;
				border-radius: 8px;
				cursor: pointer;
				font-weight: 600;
			}
			
			.nav-btn:hover {
				background: linear-gradient(135deg, #16a34a, #15803d);
			}
			
			.month-year {
				font-weight: 600;
				color: #166534;
			}
			
			.calendar-grid {
				display: grid;
				grid-template-columns: repeat(7, 1fr);
				gap: 3px;
				margin-bottom: 10px;
				flex-shrink: 0;
			}
			
			.calendar-day-header {
				text-align: center;
				font-weight: 600;
				color: #15803d;
				padding: 4px 2px;
				font-size: 11px;
			}
			
			.calendar-day {
				aspect-ratio: 1;
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				border: 1px solid #e5e7eb;
				border-radius: 4px;
				cursor: pointer;
				transition: all 0.3s ease;
				background: white;
				position: relative;
				font-size: 13px;
				padding: 2px;
			}
			
			.calendar-day:hover {
				background: #f0fdf4;
				border-color: #22c55e;
			}
			
			.calendar-day.today {
				background: linear-gradient(135deg, #22c55e, #16a34a);
				color: white;
				font-weight: bold;
			}
			
			.calendar-day.other-month {
				color: #9ca3af;
				background: #f9fafb;
			}
			
			.calendar-day.has-data {
				background: linear-gradient(135deg, #bbf7d0, #86efac);
				border-color: #22c55e;
			}
			
			.data-count {
				font-size: 10px;
				background: #dc2626;
				color: white;
				border-radius: 50%;
				width: 16px;
				height: 16px;
				display: flex;
				align-items: center;
				justify-content: center;
				position: absolute;
				top: -2px;
				right: -2px;
				font-weight: bold;
			}
			

			.file-time {
				color: #6b7280;
				font-size: 11px;
			}
			
			.no-data {
				text-align: center;
				color: #6b7280;
				padding: 20px;
				font-style: italic;
			}
			
			/* Right Panel - Data Collection */
			.right-panel {
				background: rgba(255, 255, 255, 0.9);
				border-radius: 20px;
				padding: 0;
				box-shadow: 0 8px 32px rgba(34, 197, 94, 0.1);
				border: 1px solid rgba(34, 197, 94, 0.1);
				display: flex;
				flex-direction: column;
				overflow: hidden;
				height: 600px;
			}
			
			.page-header {
				text-align: center;
				margin-bottom: 20px;
				flex-shrink: 0;
			}
			
			.page-title {
				background: linear-gradient(135deg, #22c55e, #15803d);
				-webkit-background-clip: text;
				-webkit-text-fill-color: transparent;
				background-clip: text;
				font-size: clamp(1.5rem, 3vw, 1.8rem);
				font-weight: 700;
				margin-bottom: 8px;
			}
			
			.page-subtitle {
				color: #15803d;
				font-size: 13px;
				background: linear-gradient(135deg, #f0fdf4, #dcfce7);
				padding: 8px 16px;
				border-radius: 20px;
				border: 1px solid #bbf7d0;
				display: inline-block;
			}
			
			/* æ»šåŠ¨æŒ‡æ ‡é€‰æ‹©å™¨æ ·å¼ */
			.indicators-scroll-container {
				display: flex;
				flex-direction: column;
				background: rgba(248, 250, 252, 0.8);
				border-radius: 15px;
				border: 1px solid rgba(34, 197, 94, 0.1);
				height: 100%;
				min-height: 300px;
				overflow: hidden;
			}
			
			.scroll-header {
				background: white;
				padding: 15px;
				border-bottom: 1px solid rgba(0, 0, 0, 0.1);
				text-align: center;
				border-radius: 12px 12px 0 0;
			}
			
			.scroll-header h3 {
				margin: 0 0 5px 0;
				color: #374151;
				font-size: 1.2rem;
				font-weight: bold;
			}
			
			.scroll-hint {
				font-size: 0.85rem;
				color: #6b7280;
				margin: 0;
			}
			
			.scroll-hint {
				font-size: 0.8rem;
				color: #059669;
			}
			
			.indicators-scroll-wrapper {
				flex: 1;
				overflow-y: auto;
				overflow-x: hidden;
				padding: 8px;
				-webkit-overflow-scrolling: touch; /* iOSå¹³æ»‘æ»šåŠ¨ */
				min-height: 200px;
			}
			
			.indicator-item {
				background: white;
				border: 1px solid #e5e7eb;
				border-radius: 8px;
				padding: 12px;
				margin-bottom: 8px;
				transition: all 0.2s ease;
				box-shadow: 0 1px 3px rgba(0,0,0,0.1);
			}
			
			.indicator-item:hover {
				border-color: #22c55e;
				box-shadow: 0 2px 8px rgba(34, 197, 94, 0.1);
			}
			
			.indicator-header {
				display: flex;
				justify-content: space-between;
				align-items: center;
				margin-bottom: 8px;
			}
			
			.indicator-name {
				font-weight: 600;
				color: #374151;
				font-size: 0.9rem;
			}
			
			.indicator-value-display {
				display: flex;
				align-items: center;
				gap: 5px;
				font-size: 0.85rem;
				color: #059669;
				font-weight: 600;
			}
			
			.indicator-controls {
				display: block;
				margin-top: 8px;
			}
			
			.control-range {
				width: 100%;
				height: 6px;
				border-radius: 3px;
				background: linear-gradient(to right, #dcfce7, #22c55e);
				outline: none;
				-webkit-appearance: none;
				appearance: none;
			}
			
			.control-range::-webkit-slider-thumb {
				appearance: none;
				width: 16px;
				height: 16px;
				border-radius: 50%;
				background: #22c55e;
				cursor: pointer;
				box-shadow: 0 2px 4px rgba(34, 197, 94, 0.3);
			}
			
			.control-range::-moz-range-thumb {
				width: 16px;
				height: 16px;
				border-radius: 50%;
				background: #22c55e;
				cursor: pointer;
				border: none;
				box-shadow: 0 2px 4px rgba(34, 197, 94, 0.3);
			}
			
			.btn {
				padding: 10px 20px;
				border: none;
				border-radius: 20px;
				font-weight: 600;
				font-size: 13px;
				cursor: pointer;
				transition: all 0.3s ease;
				display: flex;
				align-items: center;
				gap: 6px;
				min-width: 120px;
				justify-content: center;
			}
			
			.btn-primary {
				background: linear-gradient(135deg, #22c55e, #16a34a);
				color: white;
				box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
			}
			
			.btn-primary:hover {
				background: linear-gradient(135deg, #16a34a, #15803d);
				transform: translateY(-2px);
				box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
			}
			
			.btn-secondary {
				background: linear-gradient(135deg, #10b981, #059669);
				color: white;
				box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
			}
			
			.btn-secondary:hover {
				background: linear-gradient(135deg, #059669, #047857);
				transform: translateY(-2px);
			}
			
			/* Responsive Design */
			@media (max-width: 1024px) {
				.main-container {
					grid-template-columns: 1fr;
					gap: 15px;
				}
				
				.left-panel {
					order: 1;
					height: auto;
					max-height: 500px;
				}
				
				.right-panel {
					order: 2;
					height: auto;
					min-height: 400px;
				}
			}
			
			@media (max-width: 768px) {
				body {
					padding: 5px;
				}
				
				.page-header {
					padding: 20px 10px;
				}
				
				.page-title {
					font-size: 1.8rem;
					word-break: keep-all;
				}
				
				.page-subtitle {
					font-size: 11px;
					padding: 6px 12px;
				}
				
				.action-buttons {
					gap: 8px;
					flex-wrap: wrap;
				}
				
				.btn {
					font-size: 12px;
					padding: 8px 12px;
					white-space: nowrap;
					flex: 1 1 auto;
					min-width: 120px;
				}
				
				.status-bar {
					max-width: 90%;
					font-size: 14px;
					padding: 8px 15px;
				}
				
				.main-container {
					width: 100%;
					padding: 5px;
					gap: 10px;
				}
				
				.chart-container {
					width: 95%;
					padding: 15px 10px;
					margin: 0 auto 15px;
				}
				
			.left-panel, .right-panel {
				padding: 12px;
				height: auto;
				border-radius: 12px;
			}
			
			.left-panel {
				min-height: 300px;
				max-height: none;
				overflow-y: visible;
				overflow-x: visible;
			}
			
			.right-panel {
				min-height: 350px;
				max-height: 500px;
				overflow-y: auto;
				overflow-x: hidden;
			}				.calendar-day {
					font-size: 11px;
				}
				
				.indicator-item {
					padding: 8px;
				}
				
				.indicator-name {
					font-size: 12px;
				}
				
				.control-range {
					height: 6px;
				}
				
				.chart-container {
					width: 90%;
					padding: 12px 8px;
				}
				
				.chart-header {
					flex-direction: column;
					gap: 8px;
					align-items: stretch;
				}
				
				.chart-content {
					padding: 10px 5px;
				}
				
				.chart-controls-row {
					gap: 6px;
					font-size: 12px;
				}
				
				.chart-controls-row label {
					font-size: 11px;
					margin: 0;
				}
				
				.chart-controls-row button {
					font-size: 11px;
					padding: 6px 10px;
					white-space: nowrap;
				}
				
				.chart-controls-row span {
					font-size: 12px !important;
					margin: 0 8px !important;
				}
				
				.indicator-select {
					max-width: 140px;
					font-size: 11px;
					padding: 6px 8px;
				}
			}
			
			@media (max-width: 480px) {
				.page-title {
					font-size: 1.5rem;
				}
				
				.btn {
					font-size: 11px;
					padding: 6px 10px;
				}
				
				.chart-container {
					width: 95%;
					padding: 10px 5px;
				}
				
				.chart-content {
					padding: 8px 3px;
				}
				
				.chart-controls-row button {
					font-size: 10px;
					padding: 5px 8px;
				}
				
				.chart-controls-row span {
					font-size: 11px !important;
					margin: 0 5px !important;
				}
				
				.indicator-select {
					max-width: 120px;
					font-size: 10px;
				}
				
				.left-panel {
					overflow-y: visible;
					overflow-x: visible;
					max-height: none;
				}
				
				.right-panel {
					max-height: 450px;
					overflow-y: auto;
				}
				
				.calendar-grid {
					gap: 2px;
				}
				
				.calendar-day {
					font-size: 10px;
					padding: 1px;
				}
				
				.indicator-name {
					font-size: 11px;
				}
				
				.indicator-value-display {
					font-size: 11px;
				}
			}
		</style>
	</head>
	<body>
		<!-- é¡µé¢é¡¶éƒ¨æ ‡é¢˜ -->
		<div class="page-header">
			<h1 class="page-title">ğŸŒ± å¾—å¸Œè¡¨å‹é‡‡é›†ç³»ç»Ÿ</h1>
			<p class="page-subtitle">ä½¿ç”¨æœ¬ç³»ç»Ÿè®°å½•å’Œç®¡ç†æ¤ç‰©è¡¨å‹æ•°æ®ï¼ŒåŠ©åŠ›ç²¾å‡†å†œä¸šç ”ç©¶ä¸åˆ†æã€‚</p>			
			<div class="action-buttons">
				<button type="button" class="btn btn-primary" id="submitBtn">ğŸ“¥ å¯¼å‡º CSV</button>
				<button type="button" class="btn btn-secondary" id="dropboxBtn">â˜ï¸ åŒæ­¥åˆ°äº‘ç«¯</button>
				<button type="button" class="btn btn-primary" id="authBtn" style="display:none;">ğŸ”— è¿æ¥ Dropbox</button>
			</div>
			
			<div class="status-bar">
				<div class="status-text">çŠ¶æ€ï¼š<span id="status">ç³»ç»Ÿå°±ç»ª</span></div>
			</div>
		</div>
		
		<div class="main-container">
			<!-- Left Panel - Calendar and Statistics -->
			<div class="left-panel">
				<div class="calendar-header">
					<div class="calendar-title">ğŸ“… é‡‡é›†å†å²</div>
					<div class="calendar-nav">
						<button class="nav-btn" onclick="changeMonth(-1)">â†</button>
						<span class="month-year" id="monthYear">2025å¹´11æœˆ</span>
						<button class="nav-btn" onclick="changeMonth(1)">â†’</button>
					</div>
				</div>
				
				<div class="calendar-grid" id="calendarGrid">
					<!-- Calendar will be generated by JavaScript -->
				</div>
			</div>
			
			<!-- Right Panel - Data Collection Form -->
			<div class="right-panel">
				<!-- æ»šåŠ¨æŒ‡æ ‡é€‰æ‹©å™¨ -->
				<div class="indicators-scroll-container">
					<div class="scroll-header">
						<h3>ğŸ“Š æŒ‡æ ‡é‡‡é›†</h3>
						<div class="scroll-hint">æ»‘åŠ¨è°ƒæ•´å„é¡¹æŒ‡æ ‡æ•°å€¼</div>
					</div>
					
					<div class="indicators-scroll-wrapper" id="indicatorsScroll">
						<!-- æŒ‡æ ‡é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
					</div>
				</div>
				
				<!-- éšè—çš„æ•°æ®è¡¨å• -->
				<form id="dataForm" style="display: none;">
					<input type="hidden" name="growth_cm" value="100">
					<input type="hidden" name="stem_mm" value="25">
					<input type="hidden" name="leaf_count" value="50">
					<input type="hidden" name="leaf_length_cm" value="25">
					<input type="hidden" name="leaf_width_cm" value="15">
					<input type="hidden" name="potential_flower_count" value="10">
					<input type="hidden" name="current_flower_order" value="7">
					<input type="hidden" name="accum_ear_count" value="25">
					<input type="hidden" name="accum_grain_count" value="250">
					<input type="hidden" name="yield_kg_m2" value="50">
					<input type="hidden" name="single_grain_g" value="25">
					<input type="hidden" name="total_harvest_ear_count" value="15">
					<input type="hidden" name="total_harvest_grain_g" value="1000">
					<input type="hidden" name="ear_weight_g" value="100">
					<input type="hidden" name="single_head_yield_g" value="500">
					<input type="hidden" name="brix" value="15">
					<input type="hidden" name="acidity" value="1">
					<input type="hidden" name="cracking_rate" value="25">
					<input type="hidden" name="irrigation_ml" value="2500">
					<input type="hidden" name="reflux_ml" value="1500">
					<input type="hidden" name="reflux_ec" value="5">
					<input type="hidden" name="reflux_ph" value="7">
				</form>
				
				<!-- Debug Info Section -->
				<div id="debugInfo" style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin: 10px 0; font-family: monospace; font-size: 12px; display: none;">
					<div style="font-weight: bold; color: #374151; margin-bottom: 10px;">ğŸ”§ è°ƒè¯•ä¿¡æ¯</div>
					<div id="debugContent"></div>
					<button onclick="document.getElementById('debugInfo').style.display='none'" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 4px; margin-top: 10px; cursor: pointer;">å…³é—­</button>
				</div>
			</div>
		</div>

		<!-- å›¾è¡¨åˆ†æåŒºåŸŸ -->
		<div class="chart-container">
			<div class="chart-header">
				<h3>ğŸ“ˆ è¶‹åŠ¿åˆ†æ</h3>
				<div class="chart-controls">
					<div class="chart-controls-row">
						<button id="prevMonth" class="btn btn-secondary">â† ä¸Šæœˆ</button>
						<span id="chartMonthDisplay" style="margin: 0 15px; font-weight: 600; color: #374151;">2025å¹´11æœˆ</span>
						<button id="nextMonth" class="btn btn-secondary">ä¸‹æœˆ â†’</button>
					</div>
					<div class="chart-controls-row">
						<label for="indicatorSelect">é€‰æ‹©æŒ‡æ ‡ï¼š</label>
						<select id="indicatorSelect" class="indicator-select">
						</select>
					</div>
				</div>
			</div>
			<div class="chart-content">
				<canvas id="trendChart" width="800" height="400"></canvas>
				<div id="chartLoading" class="chart-loading" style="display: none;">
					<div class="loading-spinner">â³</div>
					<div>æ­£åœ¨åŠ è½½æ•°æ®...</div>
				</div>
				<div id="noDataMessage" class="no-data-message" style="display: none;">
					ğŸ“Š è¯·é€‰æ‹©æŒ‡æ ‡æŸ¥çœ‹è¿‡å»30å¤©çš„å˜åŒ–è¶‹åŠ¿
				</div>
			</div>
		</div>

		<div class="result" id="csvPreview" style="white-space:pre-wrap;display:none"></div>

		<script>
			// æŒ‡æ ‡æ•°æ®å®šä¹‰
			const indicators = [
				{name: 'ç”Ÿé•¿é‡', unit: 'cm', min: 0, max: 200, step: 0.1, value: 0, field: 'growth_cm'},
				{name: 'èŒç²—', unit: 'mm', min: 0, max: 50, step: 0.1, value: 0, field: 'stem_mm'},
				{name: 'å¶ç‰‡æ•°', unit: 'ä¸ª', min: 0, max: 100, step: 1, value: 0, field: 'leaf_count'},
				{name: 'å¶é•¿', unit: 'cm', min: 0, max: 50, step: 0.1, value: 0, field: 'leaf_length_cm'},
				{name: 'å¶å®½', unit: 'cm', min: 0, max: 30, step: 0.1, value: 0, field: 'leaf_width_cm'},
				{name: 'æ½œåŠ›å¼€èŠ±æ•°', unit: 'ä¸²', min: 0, max: 20, step: 1, value: 0, field: 'potential_flower_count'},
				{name: 'å½“å‰å¼€èŠ±åºæ•°', unit: 'ä¸²', min: 0, max: 15, step: 1, value: 0, field: 'current_flower_order'},
				{name: 'å•å¤´ç´¯è®¡åæœç©—æ•°', unit: 'ä¸ª', min: 0, max: 50, step: 1, value: 0, field: 'accum_ear_count'},
				{name: 'å•å¤´ç´¯è®¡åæœç²’æ•°', unit: 'ä¸ª', min: 0, max: 500, step: 1, value: 0, field: 'accum_grain_count'},
				{name: 'å•ä½äº§é‡', unit: 'kg/ã¡', min: 0, max: 100, step: 0.1, value: 0, field: 'yield_kg_m2'},
				{name: 'å•ç²’æœé‡', unit: 'g', min: 0, max: 50, step: 0.1, value: 0, field: 'single_grain_g'},
				{name: 'å•å¤´æ€»é‡‡æ”¶æœç©—æ•°', unit: 'ä¸ª', min: 0, max: 30, step: 1, value: 0, field: 'total_harvest_ear_count'},
				{name: 'å•å¤´æ€»é‡‡æ”¶æœç²’æ•°', unit: 'g', min: 0, max: 2000, step: 1, value: 0, field: 'total_harvest_grain_g'},
				{name: 'å•ç©—é‡', unit: 'g', min: 0, max: 200, step: 0.1, value: 0, field: 'ear_weight_g'},
				{name: 'å•å¤´äº§é‡', unit: 'g', min: 0, max: 1000, step: 1, value: 0, field: 'single_head_yield_g'},
				{name: 'å¯æº¶æ€§å›ºå½¢ç‰©', unit: 'Â°Brix', min: 0, max: 30, step: 0.1, value: 0, field: 'brix'},
				{name: 'é…¸åº¦', unit: '', min: 0, max: 2, step: 0.01, value: 0, field: 'acidity'},
				{name: 'è£‚æœç‡', unit: '%', min: 0, max: 50, step: 0.1, value: 0, field: 'cracking_rate'},
				{name: 'çŒæº‰é‡', unit: 'ml', min: 0, max: 5000, step: 10, value: 0, field: 'irrigation_ml'},
				{name: 'å›æ¶²é‡', unit: 'ml', min: 0, max: 3000, step: 10, value: 0, field: 'reflux_ml'},
				{name: 'å›æ¶²EC', unit: 'mS/cm', min: 0, max: 10, step: 0.1, value: 0, field: 'reflux_ec'},
				{name: 'å›æ¶²PH', unit: 'pH', min: 0, max: 14, step: 0.1, value: 0, field: 'reflux_ph'}
			];
			
			let currentIndicatorIndex = 0;
			let trendChart = null;
			let currentChartDate = new Date(); // å½“å‰å›¾è¡¨æ˜¾ç¤ºçš„æœˆä»½

			// åˆå§‹åŒ–å›¾è¡¨åŠŸèƒ½
			async function initChart() {
				// å¡«å……æŒ‡æ ‡é€‰æ‹©ä¸‹æ‹‰æ¡†
				const indicatorSelect = document.getElementById('indicatorSelect');
				indicators.forEach((indicator, index) => {
					const option = document.createElement('option');
					option.value = indicator.field;
					option.textContent = `${indicator.name} (${indicator.unit})`;
					indicatorSelect.appendChild(option);
				});

				// ç»‘å®šäº‹ä»¶
				indicatorSelect.addEventListener('change', handleIndicatorChange);
				document.getElementById('prevMonth').addEventListener('click', () => changeChartMonth(-1));
				document.getElementById('nextMonth').addEventListener('click', () => changeChartMonth(1));

				// æ›´æ–°æœˆä»½æ˜¾ç¤º
				updateChartMonthDisplay();

				// é»˜è®¤é€‰æ‹©å¹¶åŠ è½½ç”Ÿé•¿é‡æ•°æ®
				indicatorSelect.value = 'growth_cm';
				loadTrendData('growth_cm');
			}

			// æ›´æ–°æœˆä»½æ˜¾ç¤º
			function updateChartMonthDisplay() {
				const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
				const display = `${currentChartDate.getFullYear()}å¹´${monthNames[currentChartDate.getMonth()]}`;
				document.getElementById('chartMonthDisplay').textContent = display;
			}

			// åˆ‡æ¢å›¾è¡¨æ˜¾ç¤ºçš„æœˆä»½
			async function changeChartMonth(direction) {
				currentChartDate.setMonth(currentChartDate.getMonth() + direction);
				updateChartMonthDisplay();
				
				// é‡æ–°åŠ è½½å½“å‰é€‰æ‹©çš„æŒ‡æ ‡
				const selectedField = document.getElementById('indicatorSelect').value;
				if (selectedField) {
					loadTrendData(selectedField);
				}
			}

			// å¤„ç†æŒ‡æ ‡é€‰æ‹©å˜åŒ–
			function handleIndicatorChange() {
				const selectedField = document.getElementById('indicatorSelect').value;
				if (selectedField) {
					loadTrendData(selectedField);
				} else {
					showNoDataMessage();
				}
			}

			// åŠ è½½è¶‹åŠ¿æ•°æ®ï¼ˆç›´æ¥ä»æœˆåº¦CSVæ–‡ä»¶åŠ è½½ï¼‰
			async function loadTrendData(field) {
				if (!accessToken) {
					showNoDataMessage();
					return;
				}
				
				showLoading(true);
				
				const year = currentChartDate.getFullYear();
				const month = currentChartDate.getMonth();
				const monthFileName = `${year}_${String(month + 1).padStart(2, '0')}.csv`;
				const filePath = `/Plant_Data_Collection/${monthFileName}`;
				
				try {
					// ä¸‹è½½æœˆåº¦CSVæ–‡ä»¶
					const downloadResponse = await fetch('https://content.dropboxapi.com/2/files/download', {
						method: 'POST',
						headers: {
							'Authorization': 'Bearer ' + accessToken,
							'Dropbox-API-Arg': JSON.stringify({
								path: filePath
							})
						}
					});
					
					if (!downloadResponse.ok) {
						// æœˆåº¦æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºç©ºæ•°æ®
						const daysInMonth = new Date(year, month + 1, 0).getDate();
						const dates = [];
						const values = [];
						for (let day = 1; day <= daysInMonth; day++) {
							dates.push(String(day));
							values.push(null);
						}
						createTrendChart(dates, values, field);
						showLoading(false);
						return;
					}
					
					const csvText = await downloadResponse.text();
					const lines = csvText.trim().split('\n');
					
					if (lines.length < 1) {
						showNoDataMessage();
						showLoading(false);
						return;
					}
					
					const headers = lines[0].split(',');
					const fieldIndex = headers.findIndex(h => h.trim() === field);
					
					if (fieldIndex === -1) {
						console.error('å­—æ®µä¸å­˜åœ¨:', field);
						showNoDataMessage();
						showLoading(false);
						return;
					}
					
					// åˆå§‹åŒ–1-31å¤©çš„ç©ºæ•°æ®
					const daysInMonth = new Date(year, month + 1, 0).getDate();
					const dates = [];
					const values = [];
					
					for (let day = 1; day <= daysInMonth; day++) {
						dates.push(String(day));
						values.push(null);
					}
					
					// è§£æCSVä¸­çš„æ¯ä¸€è¡Œæ•°æ®
					for (let i = 1; i < lines.length; i++) {
						const dataLine = lines[i].split(',');
						if (dataLine.length === 0) continue;
						
						const timestamp = dataLine[0];
						if (!timestamp) continue;
						
						const rowDate = timestamp.split('T')[0]; // YYYY-MM-DD
						const dateParts = rowDate.split('-');
						const day = parseInt(dateParts[2], 10);
						
						if (day < 1 || day > daysInMonth) continue;
						
						// æ›´æ–°è¯¥å¤©çš„æ•°æ®
						const value = parseFloat(dataLine[fieldIndex]);
						values[day - 1] = isNaN(value) ? null : value;
					}
					
					// åˆ›å»ºå›¾è¡¨
					createTrendChart(dates, values, field);
					
				} catch (error) {
					console.error('åŠ è½½è¶‹åŠ¿æ•°æ®å¤±è´¥:', error);
					showNoDataMessage();
				} finally {
					showLoading(false);
				}
			}

			// è·å–æŒ‡å®šæ—¥æœŸçš„æ•°æ®ï¼ˆè·å–æœ€æ–°çš„CSVæ–‡ä»¶ï¼‰
			async function getDataForDate(field, date) {
				if (!accessToken) {
					return null;
				}
				
				const year = date.getFullYear();
				const month = String(date.getMonth() + 1).padStart(2, '0');
				const day = String(date.getDate()).padStart(2, '0');
				const monthFileName = `${year}_${month}.csv`;
				const filePath = `/Plant_Data_Collection/${monthFileName}`;
				const targetDate = `${year}-${month}-${day}`;
				
				try {
					// ä¸‹è½½æœˆåº¦CSVæ–‡ä»¶
					const downloadResponse = await fetch('https://content.dropboxapi.com/2/files/download', {
						method: 'POST',
						headers: {
							'Authorization': 'Bearer ' + accessToken,
							'Dropbox-API-Arg': JSON.stringify({
								path: filePath
							})
						}
					});
					
					if (!downloadResponse.ok) {
						return null; // æœˆåº¦æ–‡ä»¶ä¸å­˜åœ¨
					}
					
					const csvText = await downloadResponse.text();
					const lines = csvText.trim().split('\n');
					
					if (lines.length < 2) return null; // æ²¡æœ‰æ•°æ®è¡Œ
					
					const headers = lines[0].split(',');
					const fieldIndex = headers.findIndex(header => header.trim() === field);
					
					if (fieldIndex === -1) return null; // å­—æ®µä¸å­˜åœ¨
					
					// æŸ¥æ‰¾ç›®æ ‡æ—¥æœŸçš„è¡Œ
					for (let i = 1; i < lines.length; i++) {
						const dataLine = lines[i].split(',');
						const timestamp = dataLine[0]; // ç¬¬ä¸€åˆ—æ˜¯timestamp
						const rowDate = timestamp.split('T')[0]; // æå–YYYY-MM-DD
						
						if (rowDate === targetDate) {
							const value = parseFloat(dataLine[fieldIndex]);
							return isNaN(value) ? null : value;
						}
					}
					
					return null; // æ–‡ä»¶ä¸­æœªæ‰¾åˆ°è¯¥æ—¥æœŸ
					
				} catch (error) {
					console.log(`æ— æ³•è¯»å– ${targetDate} çš„æ•°æ®:`, error);
					return null;
				}
			}

			// è§£æCSVæ•°æ®ä¸­çš„æŒ‡å®šå­—æ®µ
			function parseCSVData(csvText, field) {
				const lines = csvText.trim().split('\n');
				if (lines.length < 2) return null;
				
				const headers = lines[0].split(',');
				const values = lines[1].split(',');
				
				const fieldIndex = headers.findIndex(header => header.trim() === field);
				if (fieldIndex === -1) return null;
				
				const value = parseFloat(values[fieldIndex]);
				return isNaN(value) ? null : value;
			}

			// åˆ›å»ºè¶‹åŠ¿å›¾è¡¨
			function createTrendChart(dates, values, field) {
				const ctx = document.getElementById('trendChart').getContext('2d');
				
				// é”€æ¯ç°æœ‰å›¾è¡¨
				if (trendChart) {
					trendChart.destroy();
				}
				
				// æ‰¾åˆ°æŒ‡æ ‡ä¿¡æ¯
				const indicator = indicators.find(ind => ind.field === field);
				const indicatorName = indicator ? `${indicator.name} (${indicator.unit})` : field;
				
				// å°†nullå€¼è½¬æ¢ä¸º0ï¼Œä¿æŒæ‰€æœ‰æ—¥æœŸ
				const chartData = dates.map((date, index) => ({
					x: date,
					y: values[index] !== null ? values[index] : 0
				}));
				
				// æ£€æµ‹æ˜¯å¦ä¸ºæ‰‹æœºç«¯
				const isMobile = window.innerWidth <= 768;
				
				trendChart = new Chart(ctx, {
					type: 'line',
					data: {
						datasets: [{
							label: indicatorName,
							data: chartData,
							borderColor: '#667eea',
							backgroundColor: 'rgba(102, 126, 234, 0.1)',
							borderWidth: 2,
							fill: true,
							tension: 0.2,
							pointBackgroundColor: '#667eea',
							pointBorderColor: '#ffffff',
							pointBorderWidth: 2,
							pointRadius: isMobile ? 2 : 4,
							pointHoverRadius: isMobile ? 4 : 6
						}]
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						scales: {
							x: {
								type: 'category',
								title: {
									display: !isMobile,
									text: 'æ—¥æœŸ',
									font: {
										size: isMobile ? 10 : 12
									}
								},
								ticks: {
									autoSkip: true,
									maxTicksLimit: isMobile ? 10 : 31,
									maxRotation: 0,
									minRotation: 0,
									font: {
										size: isMobile ? 9 : 11
									}
								}
							},
							y: {
								title: {
									display: !isMobile,
									text: indicatorName,
									font: {
										size: isMobile ? 10 : 12
									}
								},
								beginAtZero: true,
								ticks: {
									stepSize: 1,
									font: {
										size: isMobile ? 9 : 11
									}
								}
							}
						},
						plugins: {
							title: {
								display: false
							},
							legend: {
								display: false
							}
						},
						interaction: {
							intersect: false,
							mode: 'index'
						}
					}
				});
				
				// æ˜¾ç¤ºå›¾è¡¨
				document.getElementById('trendChart').style.display = 'block';
				document.getElementById('noDataMessage').style.display = 'none';
			}

			// æ˜¾ç¤ºåŠ è½½çŠ¶æ€
			function showLoading(show) {
				const loadingEl = document.getElementById('chartLoading');
				const loadingTextEl = loadingEl.querySelector('div:last-child');
				loadingTextEl.textContent = 'æ­£åœ¨åŠ è½½æ•°æ®...';
				
				loadingEl.style.display = show ? 'block' : 'none';
				document.getElementById('trendChart').style.display = show ? 'none' : 'block';
				document.getElementById('noDataMessage').style.display = 'none';
			}

			// æ˜¾ç¤ºé‡æ–°åŠ è½½æç¤º
			// æ˜¾ç¤ºæ— æ•°æ®æ¶ˆæ¯
			function showNoDataMessage() {
				document.getElementById('chartLoading').style.display = 'none';
				document.getElementById('trendChart').style.display = 'none';
				document.getElementById('noDataMessage').style.display = 'block';
				
				if (trendChart) {
					trendChart.destroy();
					trendChart = null;
				}
			}

			// åˆå§‹åŒ–ç©ºå›¾è¡¨ï¼ˆæ˜¾ç¤ºç½‘æ ¼ï¼‰
			function initEmptyChart() {
				const ctx = document.getElementById('trendChart').getContext('2d');
				
				// é”€æ¯ç°æœ‰å›¾è¡¨
				if (trendChart) {
					trendChart.destroy();
				}
				
				// ç”Ÿæˆ1-31çš„æ—¥æœŸæ ‡ç­¾
				const labels = Array.from({length: 31}, (_, i) => String(i + 1));
				
				// åˆ›å»ºç©ºæ•°æ®ï¼ˆå…¨éƒ¨ä¸º0ï¼‰
				const emptyData = Array(31).fill(0);
				
				trendChart = new Chart(ctx, {
					type: 'line',
					data: {
						labels: labels,
						datasets: [{
							label: 'è¯·é€‰æ‹©æŒ‡æ ‡',
							data: emptyData,
							borderColor: '#e5e7eb',
							backgroundColor: 'rgba(229, 231, 235, 0.1)',
							borderWidth: 2,
							fill: true,
							tension: 0.2,
							pointBackgroundColor: '#e5e7eb',
							pointBorderColor: '#ffffff',
							pointBorderWidth: 2,
							pointRadius: 0,
							pointHoverRadius: 0
						}]
					},
					options: {
						responsive: true,
						maintainAspectRatio: false,
						scales: {
							x: {
								type: 'category',
								title: {
									display: true,
									text: 'æ—¥æœŸ'
								},
								ticks: {
									autoSkip: false,
									maxRotation: 0,
									minRotation: 0
								},
								grid: {
									display: true,
									color: 'rgba(0, 0, 0, 0.05)'
								}
							},
							y: {
								title: {
									display: true,
									text: 'æ•°å€¼'
								},
								beginAtZero: true,
								ticks: {
									stepSize: 1
								},
								grid: {
									display: true,
									color: 'rgba(0, 0, 0, 0.05)'
								}
							}
						},
						plugins: {
							title: {
								display: true,
								text: 'è¶‹åŠ¿åˆ†æ - è¯·é€‰æ‹©æŒ‡æ ‡æŸ¥çœ‹æ•°æ®',
								font: {
									size: 16,
									weight: 'bold'
								}
							},
							legend: {
								display: false
							}
						}
					}
				});
				
				// æ˜¾ç¤ºå›¾è¡¨
				document.getElementById('trendChart').style.display = 'block';
				document.getElementById('noDataMessage').style.display = 'none';
				document.getElementById('chartLoading').style.display = 'none';
			}

			// æ ¼å¼åŒ–æ—¥æœŸ
			function formatDate(date) {
				return date.getFullYear() + '-' + 
					   String(date.getMonth() + 1).padStart(2, '0') + '-' + 
					   String(date.getDate()).padStart(2, '0');
			}
			
			// æ ¼å¼åŒ–æ—¥æœŸä¸ºçŸ­æ ¼å¼ï¼ˆåªæ˜¾ç¤ºæ—¥æœŸæ•°å­—ï¼š1-31ï¼‰
			function formatDateShort(date) {
				return String(date.getDate());
			}
			
			// åˆå§‹åŒ–æ»šåŠ¨æŒ‡æ ‡é€‰æ‹©å™¨
			function initIndicatorsScroll() {
				const scrollWrapper = document.getElementById('indicatorsScroll');
				
				// ç”ŸæˆæŒ‡æ ‡åˆ—è¡¨
				indicators.forEach((indicator, index) => {
					const item = document.createElement('div');
					item.className = 'indicator-item';
					
					const percentage = ((indicator.value - indicator.min) / (indicator.max - indicator.min)) * 100;
					
					item.innerHTML = `
						<div class="indicator-header">
							<div class="indicator-name">${indicator.name}</div>
							<div class="indicator-value-display">
								<span class="value">${indicator.value}</span>
								<span class="unit">${indicator.unit}</span>
							</div>
						</div>
						<div class="indicator-controls">
							<input type="range" class="control-range" value="${indicator.value}" 
								   min="${indicator.min}" max="${indicator.max}" step="${indicator.step}">
						</div>
					`;
					
					// æ§åˆ¶è¾“å…¥äº‹ä»¶
					const rangeInput = item.querySelector('.control-range');
					
					rangeInput.addEventListener('input', (e) => {
						const value = parseFloat(e.target.value);
						updateIndicatorValue(index, value);
					});
					
					scrollWrapper.appendChild(item);
				});
			}
			
			// æ›´æ–°æŒ‡æ ‡å€¼
			function updateIndicatorValue(index, value) {
				if (index < 0 || index >= indicators.length) return;
				
				const indicator = indicators[index];
				
				// ç¡®ä¿å€¼åœ¨èŒƒå›´å†…
				value = Math.max(indicator.min, Math.min(indicator.max, value));
				indicator.value = value;
				
				// æ›´æ–°æ˜¾ç¤ºå€¼
				const indicatorItems = document.querySelectorAll('.indicator-item');
				if (indicatorItems[index]) {
					const valueSpan = indicatorItems[index].querySelector('.value');
					if (valueSpan) valueSpan.textContent = value;
				}
				
				// æ›´æ–°éšè—è¡¨å•ä¸­çš„å¯¹åº”å­—æ®µ
				const hiddenInput = document.querySelector(`input[name="${indicator.field}"]`);
				if (hiddenInput) {
					hiddenInput.value = value;
				}
			}
			
			// ä»DropboxåŠ è½½ä»Šå¤©çš„æ•°æ®å¹¶åˆå§‹åŒ–è¡¨å•
			async function loadTodayData() {
				if (!accessToken) {
					console.log('æœªç™»å½•Dropboxï¼Œä½¿ç”¨é»˜è®¤å€¼');
					return;
				}
				
				const today = new Date();
				const year = today.getFullYear();
				const month = String(today.getMonth() + 1).padStart(2, '0');
				const day = String(today.getDate()).padStart(2, '0');
				const monthFileName = `${year}_${month}.csv`;
				const filePath = `/Plant_Data_Collection/${monthFileName}`;
				const targetDate = `${year}-${month}-${day}`;
				
				try {
					// ä¸‹è½½æœˆåº¦CSVæ–‡ä»¶
					const downloadResponse = await fetch('https://content.dropboxapi.com/2/files/download', {
						method: 'POST',
						headers: {
							'Authorization': 'Bearer ' + accessToken,
							'Dropbox-API-Arg': JSON.stringify({
								path: filePath
							})
						}
					});
					
					if (!downloadResponse.ok) {
						console.log('å½“æœˆæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤å€¼');
						return;
					}
					
					const csvText = await downloadResponse.text();
					const lines = csvText.trim().split('\n');
					
					if (lines.length < 2) {
						console.log('å½“æœˆæ— æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼');
						return;
					}
					
					const headers = lines[0].split(',');
					
					// æŸ¥æ‰¾ä»Šå¤©çš„æ•°æ®è¡Œ
					for (let i = 1; i < lines.length; i++) {
						const dataLine = lines[i].split(',');
						if (dataLine.length === 0) continue;
						
						const timestamp = dataLine[0];
						const rowDate = timestamp.split('T')[0]; // YYYY-MM-DD
						
						if (rowDate === targetDate) {
							console.log('æ‰¾åˆ°ä»Šå¤©çš„æ•°æ®ï¼Œæ­£åœ¨åŠ è½½...');
							
							// æ›´æ–°æ¯ä¸ªæŒ‡æ ‡çš„å€¼
							indicators.forEach((indicator, index) => {
								const fieldIndex = headers.findIndex(h => h.trim() === indicator.field);
								if (fieldIndex !== -1) {
									const value = parseFloat(dataLine[fieldIndex]);
									if (!isNaN(value)) {
										// æ›´æ–°æŒ‡æ ‡é»˜è®¤å€¼
										indicator.value = value;
										
										// æ›´æ–°æ»šåŠ¨æŒ‡æ ‡UI
										const indicatorItems = document.querySelectorAll('.indicator-item');
										if (indicatorItems[index]) {
											const rangeInput = indicatorItems[index].querySelector('.control-range');
											const valueSpan = indicatorItems[index].querySelector('.value');
											if (rangeInput) rangeInput.value = value;
											if (valueSpan) valueSpan.textContent = value;
										}
										
										// æ›´æ–°éšè—è¡¨å•
										const hiddenInput = document.querySelector(`input[name="${indicator.field}"]`);
										if (hiddenInput) {
											hiddenInput.value = value;
										}
									}
								}
							});
							
							statusEl.textContent = 'âœ… å·²åŠ è½½ä»Šå¤©çš„æ•°æ®';
							console.log('ä»Šå¤©çš„æ•°æ®åŠ è½½å®Œæˆ');
							return;
						}
					}
					
					console.log('ä»Šå¤©è¿˜æ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼');
					
				} catch (error) {
					console.error('åŠ è½½ä»Šå¤©æ•°æ®å¤±è´¥:', error);
				}
			}
			
			// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
			document.addEventListener('DOMContentLoaded', async function() {
				initIndicatorsScroll();
				await loadTodayData(); // å°è¯•åŠ è½½ä»Šå¤©çš„æ•°æ®
				initChart();
			});

			const form = document.getElementById('dataForm');
			const submitBtn = document.getElementById('submitBtn');
			const dropboxBtn = document.getElementById('dropboxBtn');
			const authBtn = document.getElementById('authBtn');
			const statusEl = document.getElementById('status');
			const csvPreview = document.getElementById('csvPreview');

			// Dropbox App Key (ç›´æ¥æ˜æ–‡é…ç½®)
			// æ³¨æ„: åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–æœåŠ¡å™¨ç«¯é…ç½®
			const DROPBOX_APP_KEY = 'j38wp0xvibd9bjq';
			
			// Registered URLs for this app (add your URLs here)
			const REGISTERED_URLS = [
				// Local development (from project directory)
				'http://localhost:8000/',
				'http://localhost:8000/index.html',
								
				// Local development (from parent directory)
				'http://localhost:8000/deci_data_collection/',
				'http://localhost:8000/deci_data_collection/index.html',
				
				// GitHub Pages deployment
				'https://jianchaoci.github.io/deci_data_collection/',
				'https://jianchaoci.github.io/deci_data_collection/index.html'
			];
			
			let accessToken = localStorage.getItem('dropbox_access_token');

			// Debug function to show current configuration
			function showDebugInfo() {
				const debugContent = document.getElementById('debugContent');
				debugContent.innerHTML = `
					<div style="margin: 5px 0;"><strong>APP Key:</strong> ${DROPBOX_APP_KEY}</div>
					<div style="margin: 5px 0;"><strong>Access Token:</strong> ${accessToken ? 'âœ… å·²å­˜å‚¨' : 'âŒ æœªè·å–'}</div>
					
					<div style="margin: 10px 0; padding: 10px; background: #eff6ff; border-radius: 4px; border-left: 4px solid #3b82f6;">
						<strong>ğŸ“‹ å¦‚æœæˆæƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥:</strong><br>
						1. è®¿é—® <a href="https://www.dropbox.com/developers/apps" target="_blank">Dropboxå¼€å‘è€…æ§åˆ¶å°</a><br>
						2. ç¡®è®¤åº”ç”¨çš„ App Key æ˜¯å¦æ­£ç¡®<br>
						3. ç¡®è®¤å·²åœ¨ OAuth 2 è®¾ç½®ä¸­æ·»åŠ é‡å®šå‘URI<br>
						4. é‡è¯•æˆæƒæµç¨‹
					</div>
				`;
				
				document.getElementById('debugInfo').style.display = 'block';
			}

			// Update slider value display
			function updateSliderValue(slider) {
				const valueSpan = slider.parentElement.querySelector('.slider-value');
				if (valueSpan) {
					valueSpan.textContent = slider.value;
				}
				
				// åŒæ­¥æ›´æ–°æ»šåŠ¨æŒ‡æ ‡ç³»ç»Ÿä¸­çš„å¯¹åº”å€¼
				const fieldName = slider.name;
				const indicatorIndex = indicators.findIndex(ind => ind.field === fieldName);
				if (indicatorIndex !== -1) {
					updateIndicatorValue(indicatorIndex, parseFloat(slider.value));
				}
			}

			// Check if current URL is registered and show specific redirect URI guidance
			function checkURLRegistration() {
				const currentOrigin = window.location.origin;
				const currentURL = window.location.href;
				
				// Generate the exact redirect URI that OAuth will use
				let predictedRedirectUri;
				if (window.location.protocol === 'file:') {
					predictedRedirectUri = 'http://localhost:8000/';
				} else {
					const currentPath = window.location.origin + window.location.pathname;
					if (currentPath.endsWith('/index.html')) {
						predictedRedirectUri = currentPath;
					} else if (currentPath.endsWith('/')) {
						predictedRedirectUri = currentPath;
					} else {
						predictedRedirectUri = currentPath + '/';
					}
				}
				
				// Check if the exact redirect URI is registered
				const isRedirectUriRegistered = REGISTERED_URLS.includes(predictedRedirectUri);
				
				if (!isRedirectUriRegistered) {
					// é™é»˜è®°å½•åˆ°æ§åˆ¶å°ï¼Œä¸æ˜¾ç¤ºä»»ä½•æç¤º
					console.warn('Redirect URI not found in registered list:', predictedRedirectUri);
					console.log('Registered URLs:', REGISTERED_URLS);
					console.log('å¦‚æœé‡åˆ°æˆæƒé—®é¢˜ï¼Œè¯·åœ¨Dropboxåº”ç”¨ä¸­æ·»åŠ é‡å®šå‘URI:', predictedRedirectUri);
					return true; // Allow functionality
				}
				
				// All good - URI is properly registered
				console.log('âœ“ Redirect URI is registered:', predictedRedirectUri);
				return true;
			}

			// Initialize URL check
			const isURLValid = checkURLRegistration();

			// Calendar functionality
			let currentDate = new Date();
			let collectionData = {}; // Store collection history: {date: count}

			function generateCalendar(year, month) {
				const firstDay = new Date(year, month, 1);
				const lastDay = new Date(year, month + 1, 0);
				const firstDayWeek = firstDay.getDay();
				const daysInMonth = lastDay.getDate();
				
				const calendarGrid = document.getElementById('calendarGrid');
				const monthYear = document.getElementById('monthYear');
				
				// Update month/year display
				const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
				monthYear.textContent = `${year}å¹´${monthNames[month]}`;
				
				// Clear previous calendar
				calendarGrid.innerHTML = '';
				
				// Add day headers
				const dayHeaders = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
				dayHeaders.forEach(day => {
					const header = document.createElement('div');
					header.className = 'calendar-day-header';
					header.textContent = day;
					calendarGrid.appendChild(header);
				});
				
				// Add empty cells for days before month starts
				for (let i = 0; i < firstDayWeek; i++) {
					const emptyDay = document.createElement('div');
					emptyDay.className = 'calendar-day other-month';
					calendarGrid.appendChild(emptyDay);
				}
				
				// Add days of the month
				const today = new Date();
				for (let day = 1; day <= daysInMonth; day++) {
					const dayElement = document.createElement('div');
					dayElement.className = 'calendar-day';
					dayElement.textContent = day;
					
					const dayKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
					
					// Check if it's today
					if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
						dayElement.classList.add('today');
					}
					
					// Check if there's collection data for this day
					if (collectionData[dayKey]) {
						dayElement.classList.add('has-data');
						const countBadge = document.createElement('div');
						countBadge.className = 'data-count';
						countBadge.textContent = 'âœ“';  // æ˜¾ç¤ºå¯¹å‹¾ç¬¦å·è€Œä¸æ˜¯æ•°å­—
						dayElement.appendChild(countBadge);
					}
					
					// Add click event listener
					dayElement.addEventListener('click', () => {
						selectDay(year, month, day, dayKey);
					});
					
					calendarGrid.appendChild(dayElement);
				}
				
			}

			function changeMonth(direction) {
				currentDate.setMonth(currentDate.getMonth() + direction);
				generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
			}

			// Load collection history from Dropbox
			async function loadCollectionHistory() {
				if (!accessToken) return;
				
				try {
					statusEl.textContent = 'æ­£åœ¨åŠ è½½é‡‡é›†å†å²...';
					
					// List all files in Plant_Data_Collection
					const response = await fetch('https://api.dropboxapi.com/2/files/list_folder', {
						method: 'POST',
						headers: {
							'Authorization': 'Bearer ' + accessToken,
							'Content-Type': 'application/json'
						},
						body: JSON.stringify({
							path: '/Plant_Data_Collection',
							recursive: false
						})
					});

					if (response.ok) {
						const data = await response.json();
						collectionData = {};
						
						// Process each monthly CSV file
						for (const entry of data.entries) {
							if (entry['.tag'] === 'file' && entry.name.endsWith('.csv')) {
								// æ–‡ä»¶åæ ¼å¼: YYYY_MM.csv
								const fileName = entry.name.replace('.csv', '');
								const dateParts = fileName.split('_');
								
								if (dateParts.length === 2) {
									const year = dateParts[0];
									const month = dateParts[1];
									
									// ä¸‹è½½æœˆåº¦æ–‡ä»¶ï¼Œç»Ÿè®¡å…¶ä¸­çš„æ•°æ®è¡Œæ•°
									const downloadResponse = await fetch('https://content.dropboxapi.com/2/files/download', {
										method: 'POST',
										headers: {
											'Authorization': 'Bearer ' + accessToken,
											'Dropbox-API-Arg': JSON.stringify({
												path: entry.path_lower
											})
										}
									});
									
									if (downloadResponse.ok) {
										const csvText = await downloadResponse.text();
										const lines = csvText.trim().split('\n');
										
										// è·³è¿‡è¡¨å¤´ï¼Œå¤„ç†æ¯ä¸€è¡Œæ•°æ®
										for (let i = 1; i < lines.length; i++) {
											const dataLine = lines[i].split(',');
											if (dataLine.length > 0) {
												const timestamp = dataLine[0];
												const rowDate = timestamp.split('T')[0]; // YYYY-MM-DD
												
												// æ ‡è®°è¯¥æ—¥æœŸæœ‰æ•°æ®
												collectionData[rowDate] = 1;
											}
										}
									}
								}
							}
						}
						
						// Refresh calendar display
						generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
						statusEl.textContent = 'âœ… å†å²æ•°æ®å·²åŠ è½½';
						
					} else {
						console.log('Failed to load collection history');
						statusEl.textContent = 'âš ï¸ æ— æ³•åŠ è½½å†å²æ•°æ®';
					}
				} catch (error) {
					console.error('Error loading collection history:', error);
					statusEl.textContent = 'âŒ åŠ è½½å†å²æ•°æ®å‡ºé”™';
				}
			}

			// Record new collection
			function recordCollection() {
				const today = new Date();
				const dateKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
				
				// Increment count for today
				collectionData[dateKey] = (collectionData[dateKey] || 0) + 1;
				
				// Update calendar display
				generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
			}

			// Select a specific day (simplified - no details shown)
			async function selectDay(year, month, day, dateKey) {
				// Remove previous selection
				document.querySelectorAll('.calendar-day').forEach(el => {
					el.classList.remove('selected');
				});

				// Highlight selected day
				event.target.classList.add('selected');
			}



			function buildCSV(formData){
				const headers = [
					'timestamp','growth_cm','stem_mm','leaf_count','leaf_length_cm','leaf_width_cm',
					'potential_flower_count','current_flower_order','accum_ear_count','accum_grain_count',
					'yield_kg_m2','single_grain_g','total_harvest_ear_count','total_harvest_grain_g',
					'ear_weight_g','single_head_yield_g','brix','acidity','cracking_rate',
					'irrigation_ml','reflux_ml','reflux_ec','reflux_ph'
				];

				const row = [new Date().toISOString()];
				for(const h of headers.slice(1)){
					let v = formData.get(h);
					if(v === null || v === '') v = '';
					// escape double quotes
					if(typeof v === 'string' && v.includes(',')) v = '"'+v.replace(/"/g,'""')+'"';
					row.push(v);
				}
				const csv = headers.join(',') + '\n' + row.join(',') + '\n';
				return csv;
			}

			// Generate random string for PKCE
			function generateRandomString(length) {
				const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
				let result = '';
				for (let i = 0; i < length; i++) {
					result += chars.charAt(Math.floor(Math.random() * chars.length));
				}
				return result;
			}

			// SHA256 hash function
			async function sha256(plain) {
				const encoder = new TextEncoder();
				const data = encoder.encode(plain);
				const hash = await crypto.subtle.digest('SHA-256', data);
				return hash;
			}

			// Base64 URL encode
			function base64URLEncode(buffer) {
				const bytes = new Uint8Array(buffer);
				let binary = '';
				for (let i = 0; i < bytes.byteLength; i++) {
					binary += String.fromCharCode(bytes[i]);
				}
				return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
			}

			// Dropbox OAuth2 PKCE flow
			async function authenticateDropbox() {
				console.log('Using App Key:', DROPBOX_APP_KEY);

				// Generate the exact redirect URI that will be used
				let predictedRedirectUri;
				if (window.location.protocol === 'file:') {
					alert('æœ¬åœ°æ–‡ä»¶æ¨¡å¼ä¸‹ Dropbox OAuth æœ‰é™åˆ¶ã€‚\n\nè¯·ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ä¹‹ä¸€ï¼š\n1. å¯åŠ¨ä¸€ä¸ªç®€å•çš„æœ¬åœ°æœåŠ¡å™¨\n2. æˆ–è€…ä¸Šä¼ åˆ°ç½‘ç«™æ‰˜ç®¡æœåŠ¡\n\nç°åœ¨å°†ä¸ºæ‚¨å¯åŠ¨ä¸€ä¸ªç®€å•çš„ Python æœåŠ¡å™¨...');
					predictedRedirectUri = 'http://localhost:8000/';
				} else {
					const currentPath = window.location.origin + window.location.pathname;
					if (currentPath.endsWith('/index.html')) {
						predictedRedirectUri = currentPath;
					} else if (currentPath.endsWith('/')) {
						predictedRedirectUri = currentPath;
					} else {
						predictedRedirectUri = currentPath + '/';
					}
				}

				// Use the predicted redirect URI
				console.log('Will use redirect URI:', predictedRedirectUri);

				// Generate PKCE parameters
				const codeVerifier = generateRandomString(128);
				const codeChallenge = base64URLEncode(await sha256(codeVerifier));
				
				// Store verifier for later use
				localStorage.setItem('dropbox_code_verifier', codeVerifier);
				
				// Use the redirect URI we already determined and checked
				const redirectUri = predictedRedirectUri;
				
				// Build authorization URL
				const authUrl = 'https://www.dropbox.com/oauth2/authorize?' +
					'client_id=' + encodeURIComponent(DROPBOX_APP_KEY) +
					'&response_type=code' +
					'&code_challenge=' + encodeURIComponent(codeChallenge) +
					'&code_challenge_method=S256' +
					'&redirect_uri=' + encodeURIComponent(redirectUri);
				
				// Debug: show what redirect URI we're using
				console.log('Using redirect URI:', redirectUri);
				console.log('Full auth URL:', authUrl);
				
				statusEl.textContent = 'æ­£åœ¨é‡å®šå‘åˆ° Dropbox æˆæƒé¡µé¢...';
				
				window.location.href = authUrl;
			}

			// Handle OAuth callback
			async function handleOAuthCallback() {
				// Debug: show current URL and parameters
				console.log('Current URL:', window.location.href);
				console.log('URL search params:', window.location.search);
				
				const urlParams = new URLSearchParams(window.location.search);
				const code = urlParams.get('code');
				const error = urlParams.get('error');
				
				console.log('Code parameter:', code);
				console.log('Error parameter:', error);

				if (error) {
					statusEl.textContent = `âŒ Dropbox æˆæƒå¤±è´¥: ${error}`;
					return;
				}

				if (code) {
					statusEl.textContent = 'æ£€æµ‹åˆ°æˆæƒç ï¼Œæ­£åœ¨è·å–è®¿é—®ä»¤ç‰Œ...';
					console.log('Starting token exchange...');
					console.log('Token exchange using App Key:', DROPBOX_APP_KEY);
					const codeVerifier = localStorage.getItem('dropbox_code_verifier');

				// Auto-detect redirect URI (same logic as in auth function)
				let redirectUri;
				if (window.location.protocol === 'file:') {
					redirectUri = 'http://localhost:8000/';
				} else {
					const currentPath = window.location.origin + window.location.pathname;
					if (currentPath.endsWith('/index.html')) {
						redirectUri = currentPath;
					} else if (currentPath.endsWith('/')) {
						redirectUri = currentPath;
					} else {
						redirectUri = currentPath + '/';
					}
				}					try {
						const response = await fetch('https://api.dropboxapi.com/oauth2/token', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/x-www-form-urlencoded',
							},
							body: new URLSearchParams({
								code: code,
								grant_type: 'authorization_code',
								client_id: DROPBOX_APP_KEY,
								code_verifier: codeVerifier,
								redirect_uri: redirectUri
							})
						});

						if (response.ok) {
							const data = await response.json();
							accessToken = data.access_token;
							localStorage.setItem('dropbox_access_token', accessToken);
							localStorage.removeItem('dropbox_code_verifier');
							
							// Clean up URL
							window.history.replaceState({}, document.title, window.location.pathname);
							
							statusEl.textContent = 'âœ… Dropbox æˆæƒæˆåŠŸï¼';
							updateButtonStates();
							
							// Load collection history
							loadCollectionHistory();
						} else {
							const errorData = await response.json();
							statusEl.textContent = `âŒ è·å–è®¿é—®ä»¤ç‰Œå¤±è´¥: ${errorData.error_description || errorData.error}`;
						}
					} catch (err) {
						statusEl.textContent = `âŒ æˆæƒè¿‡ç¨‹å‡ºé”™: ${err.message}`;
					}
				}
			}

			// Upload CSV to Dropbox
			async function uploadToDropbox(csv) {
				if (!accessToken) {
					statusEl.textContent = 'è¯·å…ˆè¿æ¥ Dropbox';
					return false;
				}

				statusEl.textContent = 'æ­£åœ¨ä¸Šä¼ åˆ° Dropbox...';
				
				const now = new Date();
				const year = now.getFullYear();
				const month = String(now.getMonth() + 1).padStart(2, '0');
				const day = String(now.getDate()).padStart(2, '0');
				
				// æ–°æ ¼å¼ï¼š/Plant_Data_Collection/YYYY_MM.csv
				const mainFolder = '/Plant_Data_Collection';
				const monthFileName = `${year}_${month}.csv`;
				const filePath = `${mainFolder}/${monthFileName}`;
				const dateKey = `${year}-${month}-${day}`;

				try {
					// è§£æå½“å‰è¦ä¸Šä¼ çš„CSVæ•°æ®ï¼ˆåªæœ‰æ•°æ®è¡Œï¼Œä¸å«è¡¨å¤´ï¼‰
					const csvLines = csv.trim().split('\n');
					const headers = csvLines[0]; // timestamp,growth_cm,stem_mm,...
					const newDataLine = csvLines[1]; // æ–°çš„æ•°æ®è¡Œ
					
					// å°è¯•ä¸‹è½½ç°æœ‰çš„æœˆåº¦æ–‡ä»¶
					let existingContent = null;
					let existingLines = [];
					
					statusEl.textContent = 'æ­£åœ¨æ£€æŸ¥å½“æœˆæ–‡ä»¶...';
					try {
						const downloadResponse = await fetch('https://content.dropboxapi.com/2/files/download', {
							method: 'POST',
							headers: {
								'Authorization': 'Bearer ' + accessToken,
								'Dropbox-API-Arg': JSON.stringify({
									path: filePath
								})
							}
						});
						
						if (downloadResponse.ok) {
							existingContent = await downloadResponse.text();
							existingLines = existingContent.trim().split('\n');
							console.log('æ‰¾åˆ°ç°æœ‰æœˆåº¦æ–‡ä»¶ï¼Œå…±', existingLines.length - 1, 'è¡Œæ•°æ®');
						}
					} catch (error) {
						console.log('å½“æœˆæ–‡ä»¶ä¸å­˜åœ¨æˆ–è¯»å–å¤±è´¥ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶');
					}
					
					// æ„å»ºæ–°çš„CSVå†…å®¹
					let updatedCSV;
					if (existingLines.length > 0) {
						// æ–‡ä»¶å·²å­˜åœ¨ï¼Œæ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²æœ‰æ•°æ®
						const todayTimestamp = newDataLine.split(',')[0]; // æå–timestamp
						const todayDate = todayTimestamp.split('T')[0]; // æå–æ—¥æœŸéƒ¨åˆ† YYYY-MM-DD
						
						let dayUpdated = false;
						const dataLines = existingLines.slice(1); // å»æ‰è¡¨å¤´
						const updatedDataLines = dataLines.map(line => {
							const lineTimestamp = line.split(',')[0];
							const lineDate = lineTimestamp.split('T')[0];
							
							if (lineDate === todayDate) {
								// æ‰¾åˆ°ä»Šå¤©çš„æ•°æ®ï¼Œæ›´æ–°å®ƒ
								dayUpdated = true;
								console.log('æ›´æ–°ä»Šå¤©çš„æ•°æ®:', todayDate);
								return newDataLine;
							}
							return line;
						});
						
						if (!dayUpdated) {
							// ä»Šå¤©è¿˜æ²¡æœ‰æ•°æ®ï¼Œè¿½åŠ æ–°è¡Œ
							console.log('è¿½åŠ æ–°çš„ä¸€å¤©æ•°æ®:', todayDate);
							updatedDataLines.push(newDataLine);
						}
						
						// é‡æ–°ç»„åˆCSVï¼ˆè¡¨å¤´ + æ•°æ®è¡Œï¼‰
						updatedCSV = headers + '\n' + updatedDataLines.join('\n');
					} else {
						// æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°æ–‡ä»¶
						console.log('åˆ›å»ºæ–°çš„æœˆåº¦æ–‡ä»¶');
						updatedCSV = csv;
					}
					
					// ä¸Šä¼ æ›´æ–°åçš„CSVæ–‡ä»¶ï¼ˆä½¿ç”¨overwriteæ¨¡å¼ï¼‰
					statusEl.textContent = 'æ­£åœ¨ä¿å­˜æ•°æ®...';
					const response = await fetch('https://content.dropboxapi.com/2/files/upload', {
						method: 'POST',
						headers: {
							'Authorization': 'Bearer ' + accessToken,
							'Content-Type': 'application/octet-stream',
							'Dropbox-API-Arg': JSON.stringify({
								path: filePath,
								mode: 'overwrite', // è¦†ç›–æ¨¡å¼
								autorename: false
							})
						},
						body: updatedCSV
					});

					console.log('Upload response status:', response.status);

					if (response.ok) {
						const result = await response.json();
						statusEl.textContent = 'âœ… æˆåŠŸä¸Šä¼ åˆ°äº‘ç«¯: ' + result.name;
						
						// æ›´æ–°æ—¥å†æ˜¾ç¤º
						collectionData[dateKey] = 1;
						generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
						
						return true;
					} else {
						const errorText = await response.text();
						console.log('Error response text:', errorText);
						
						let errorData;
						try {
							errorData = JSON.parse(errorText);
						} catch (e) {
							errorData = { error: errorText };
						}

						if (response.status === 401) {
							localStorage.removeItem('dropbox_access_token');
							accessToken = null;
							updateButtonStates();
							statusEl.textContent = 'Dropbox ä»¤ç‰Œå·²è¿‡æœŸï¼Œè¯·é‡æ–°æˆæƒ';
						} else {
							statusEl.textContent = 'Dropbox ä¸Šä¼ å¤±è´¥ (' + response.status + '): ' + (errorData.error_summary || errorData.error || errorText);
						}
						return false;
					}
				} catch (err) {
					statusEl.textContent = 'Dropbox ä¸Šä¼ å‡ºé”™: ' + err.message;
					console.error('Upload error:', err);
					return false;
				}
			}

			// Update button states based on auth status
			function updateButtonStates() {
				if (!isURLValid) {
					dropboxBtn.style.display = 'none';
					authBtn.style.display = 'none';
					return;
				}

				if (accessToken) {
					dropboxBtn.style.display = 'inline-block';
					authBtn.style.display = 'none';
				} else {
					dropboxBtn.style.display = 'none';
					authBtn.style.display = 'inline-block';
				}
			}

			// Event listeners
			submitBtn.addEventListener('click', ()=>{
				const fd = new FormData(form);
				const csv = buildCSV(fd);
				csvPreview.style.display = 'block';
				csvPreview.textContent = csv;
				
				// Download CSV
				const blob = new Blob([csv],{type:'text/csv'});
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = 'data_' + (new Date()).toISOString().replace(/[:.]/g,'-') + '.csv';
				document.body.appendChild(a);
				a.click();
				a.remove();
				URL.revokeObjectURL(url);
				
				statusEl.textContent = 'CSV å·²ä¸‹è½½';
			});

			dropboxBtn.addEventListener('click', async ()=>{
				const fd = new FormData(form);
				const csv = buildCSV(fd);
				csvPreview.style.display = 'block';
				csvPreview.textContent = csv;
				
				await uploadToDropbox(csv);
			});

			authBtn.addEventListener('click', authenticateDropbox);

			// Initialize
			if (isURLValid) {
				statusEl.textContent = accessToken ? 'âœ… å·²è¿æ¥åˆ° Dropbox' : 'è¯·è¿æ¥ Dropbox å¼€å§‹ä½¿ç”¨';
				
				updateButtonStates();
				handleOAuthCallback();
				
				// Generate initial calendar
				generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
				
				// Load collection history if authenticated
				if (accessToken) {
					loadCollectionHistory();
				}
			}
		</script>
	</body>
</html>
