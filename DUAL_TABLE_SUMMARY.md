# 双表方案实现总结

## ✅ 已完成的修改

### 1. 数据库结构 (`supabase_schema.sql`)

#### 表1: phenotype_records
- **用途**: 存储每个样本的原始采集数据
- **结构**: 30个样本/周 = 30行/周
- **字段**: 20个采集指标
- **约束**: `UNIQUE(user_id, year, week, replicate_id)`

#### 表2: weekly_statistics
- **用途**: 存储每周的统计指标
- **结构**: 1周 = 1行
- **字段**: 6个统计指标 + 配置参数
- **约束**: `UNIQUE(user_id, year, week)`
- **触发器**: 自动更新 `updated_at`

---

### 2. 数据采集页面 (`collection.html`)

✅ **数据保存到 phenotype_records**
- 每个样本独立保存
- 未采集的指标为 `NULL`
- 支持切换样本验证

✅ **进度统计优化**
- 页面加载时从数据库读取所有样本数据
- 准确显示已完成样本数量
- 刷新页面后进度不会清零

---

### 3. 统计页面 (`statistics.html`)

✅ **实时计算统计指标**
```javascript
calculateAndSaveWeeklyStatistics()
  ↓
1. 从 phenotype_records 读取本周30个样本数据
2. 计算每个指标的平均值
3. 从 weekly_statistics 读取历史数据
4. 累加计算统计指标
5. 保存/更新到 weekly_statistics
```

✅ **统计指标**
- 单头累计坐果粒数（累加）
- 总产量（累加）
- 单头总采收果穗数（累加）
- 单头产量（累加）
- 单位产量（计算）
- 回液比例（平均）

✅ **配置参数**
- 温室面积（localStorage → weekly_statistics）
- 滴箭个数（localStorage）

---

### 4. 趋势分析页面 (`trends.html`)

✅ **支持两类指标**

**采集指标**（如：生长量、茎粗等）
```javascript
从 phenotype_records 读取
  ↓
按周分组计算平均值
  ↓
绘制趋势图
```

**统计指标**（如：单头累计坐果数、总产量等）
```javascript
从 weekly_statistics 直接读取
  ↓
绘制趋势图（无需聚合）
```

✅ **自动识别指标类型**
```javascript
if (indicator.isStatistic || indicator.isConstant) {
  // 从 weekly_statistics 读取
} else {
  // 从 phenotype_records 读取并计算平均值
}
```

---

## 🎯 双表方案的优势

### 1. 数据分离
- ✅ 采集数据（原始、详细）
- ✅ 统计数据（汇总、预计算）
- ✅ 职责清晰，易于维护

### 2. 展示统计指标趋势
- ✅ 可以直接查看"单头累计坐果数"随周次的变化
- ✅ 可以直接查看"总产量"的累积趋势
- ✅ 无需每次重新计算历史数据

### 3. 配置参数历史记录
- ✅ 保存每周的温室面积配置
- ✅ 可以追溯历史配置变化
- ✅ 统计指标计算更准确

### 4. 查询性能
- ✅ 统计指标已预计算，查询更快
- ✅ 趋势图绘制更流畅
- ✅ 适合长期数据积累

---

## 📊 数据流程图

```
┌─────────────────────────────────────────────────────────────┐
│                    用户采集数据                              │
└─────────────────────┬───────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────────┐
│              phenotype_records 表                            │
│  Week 1: Rep 1, Rep 2, ..., Rep 30 (30行)                   │
│  Week 2: Rep 1, Rep 2, ..., Rep 30 (30行)                   │
│  Week 3: Rep 1, Rep 2, ..., Rep 30 (30行)                   │
└─────────────────────┬───────────────────────────────────────┘
                      ↓
              访问 statistics.html
                      ↓
┌─────────────────────────────────────────────────────────────┐
│           计算统计指标（自动触发）                           │
│  1. 读取本周30个样本数据                                     │
│  2. 计算平均值                                               │
│  3. 累加历史数据                                             │
│  4. 保存到 weekly_statistics                                │
└─────────────────────┬───────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────────────────┐
│              weekly_statistics 表                            │
│  Week 1: accum_grain=5, total_yield=0.5 (1行)               │
│  Week 2: accum_grain=8, total_yield=1.2 (1行)               │
│  Week 3: accum_grain=12, total_yield=2.0 (1行)              │
└─────────────────────┬───────────────────────────────────────┘
                      ↓
              访问 trends.html
                      ↓
┌─────────────────────────────────────────────────────────────┐
│                  绘制趋势图                                  │
│  采集指标: 从 phenotype_records 计算                         │
│  统计指标: 从 weekly_statistics 直接读取                     │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔧 使用步骤

### 1. 部署数据库
```sql
-- 在 Supabase SQL Editor 中运行
-- supabase_schema.sql
```

### 2. 数据采集
1. 访问 `collection.html`
2. 选择样本（1-30）
3. 勾选指标并输入数据
4. 点击"提交数据"

### 3. 查看统计
1. 访问 `statistics.html`
2. 系统自动计算并保存统计数据
3. 显示累积统计指标

### 4. 分析趋势
1. 访问 `trends.html`
2. 选择指标（采集指标或统计指标）
3. 查看趋势图

---

## 📈 示例：统计指标趋势

### 单头累计坐果粒数

| 周次 | 本周新增（平均） | 累计坐果数 |
|------|------------------|------------|
| Week 1 | 5 粒/头 | 5 粒/头 |
| Week 2 | 3 粒/头 | 8 粒/头 |
| Week 3 | 4 粒/头 | 12 粒/头 |
| Week 4 | 6 粒/头 | 18 粒/头 |

在 `trends.html` 中选择"单头累计坐果粒数"，可以看到：
- Week 1: 5
- Week 2: 8
- Week 3: 12
- Week 4: 18

**趋势图显示累积增长曲线** 📈

---

## 🔄 数据一致性

### 自动更新机制
每次访问 `statistics.html` 时：
1. 检查本周是否有统计记录
2. 如果有，更新统计数据
3. 如果没有，创建新记录

### 修改历史数据
如果修改了历史采集数据：
1. 访问 `statistics.html`
2. 系统会重新计算本周统计
3. 历史周次的统计需要手动触发更新（或添加"刷新所有统计"功能）

---

## 🚀 扩展功能建议

### 1. 批量重新计算统计
添加"刷新所有统计"按钮：
```javascript
async function recalculateAllStatistics() {
  // 获取所有历史周次
  // 逐周重新计算并更新 weekly_statistics
}
```

### 2. 导出统计报表
导出包含统计指标的 Excel 文件：
```javascript
async function exportStatisticsReport() {
  // 从 weekly_statistics 读取所有数据
  // 生成 CSV/Excel 文件
}
```

### 3. 统计指标对比
在趋势页面添加多指标对比：
```javascript
// 同时显示"总产量"和"单位产量"的趋势
// 使用双Y轴图表
```

---

## 📝 维护建议

### 定期检查
- ✅ 统计数据是否准确
- ✅ 配置参数是否正确
- ✅ 趋势图是否正常显示

### 性能监控
- ✅ 查询时间（应 < 100ms）
- ✅ 页面加载速度
- ✅ 数据库大小

### 备份策略
- ✅ 定期备份 phenotype_records（原始数据）
- ✅ weekly_statistics 可以随时重新计算

---

## ✨ 总结

双表方案已完全实现并优化：
- ✅ 数据库结构清晰
- ✅ 数据采集流畅
- ✅ 统计计算准确
- ✅ 趋势分析完善
- ✅ 支持统计指标趋势展示

**现在可以开始使用了！** 🎉

