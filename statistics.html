<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ğŸ“ˆ ç»Ÿè®¡æ•°é‡ - å¾—å¸Œè¡¨å‹é‡‡é›†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="common.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .statistics-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(5, 150, 105, 0.12);
            border: 1px solid rgba(5, 150, 105, 0.15);
            max-width: 800px;
            margin: 0 auto 20px auto;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(5, 150, 105, 0.1);
        }

        .stat-label {
            color: #065f46;
            font-weight: 500;
            font-size: 1rem;
        }

        .stat-value {
            color: #047857;
            font-weight: 700;
            font-size: 1.3rem;
        }

        .no-data {
            color: #6b7280;
            text-align: center;
            padding: 40px 20px;
            font-size: 1rem;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #059669;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <div class="nav-links">
            <a href="index.html" class="nav-link" data-page="home" data-lang="nav.home">ğŸ  é¦–é¡µ</a>
            <a href="calendar.html" class="nav-link" data-page="calendar" data-lang="nav.calendar">ğŸ“… é‡‡é›†æ—¥å†</a>
            <a href="collection.html" class="nav-link" data-page="collection" data-lang="nav.collection">ğŸ“Š æ•°æ®é‡‡é›†</a>
            <a href="statistics.html" class="nav-link active" data-page="statistics" data-lang="nav.statistics">ğŸ“ˆ
                ç»Ÿè®¡æ•°é‡</a>
            <a href="trends.html" class="nav-link" data-page="trends" data-lang="nav.trends">ğŸ“‰ è¶‹åŠ¿åˆ†æ</a>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button class="nav-link" id="authBtn" style="border: 1px solid white; cursor: pointer; display: none;">ğŸ”— ç™»å½•</button>
            <button class="lang-switch" id="langSwitch" style="position: static;">EN</button>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title" data-lang="statisticCount">ğŸ“ˆ ç»Ÿè®¡æ•°é‡</h1>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- é…ç½®å‚æ•° -->
        <div class="statistics-card">
            <h2 class="section-title">âš™ï¸ <span data-lang="configParams">é…ç½®å‚æ•°</span></h2>
            <div style="display: grid; gap: 20px;">
                <div class="stat-item" style="flex-direction: column; align-items: flex-start;">
                    <label class="stat-label" style="margin-bottom: 8px;">
                        <span data-lang="greenhouse_area_m2">æ¸©å®¤é¢ç§¯</span> (mÂ²)
                        <span id="areaLockIcon" style="margin-left: 8px; display: none;">ğŸ”’</span>
                    </label>
                    <input type="number" id="greenhouseAreaInput" 
                           style="width: 100%; padding: 10px; border: 2px solid #6ee7b7; border-radius: 8px; font-size: 1rem;"
                           placeholder="0" step="0.1" min="0">
                </div>
                <div class="stat-item" style="flex-direction: column; align-items: flex-start;">
                    <label class="stat-label" style="margin-bottom: 8px;">
                        <span data-lang="dripper_count">æ»´ç®­ä¸ªæ•°</span>
                        <span id="dripperLockIcon" style="margin-left: 8px; display: none;">ğŸ”’</span>
                    </label>
                    <input type="number" id="dripperCountInput" 
                           style="width: 100%; padding: 10px; border: 2px solid #6ee7b7; border-radius: 8px; font-size: 1rem;"
                           placeholder="0" step="1" min="0">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button id="saveConfigBtn" class="btn btn-primary" 
                            style="flex: 1; background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 12px 24px; border: none; border-radius: 10px; cursor: pointer; font-size: 1rem; font-weight: 600;">
                        ğŸ’¾ <span data-lang="saveConfig">ä¿å­˜é…ç½®</span>
                    </button>
                    <button id="unlockConfigBtn" class="btn btn-secondary" 
                            style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 12px 24px; border: none; border-radius: 10px; cursor: pointer; font-size: 1rem; font-weight: 600; display: none;">
                        ğŸ”“ <span data-lang="unlockConfig">è§£é”ä¿®æ”¹</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Cumulative Statistics -->
        <div class="statistics-card">
            <h2 class="section-title" data-lang="statisticIndicators">ğŸ“Š ç´¯ç§¯ç»Ÿè®¡æŒ‡æ ‡</h2>
            <div id="statisticValues">
                <div class="loading" data-lang="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <script src="common.js?v=20251214"></script>
    <script>
        // Set active navigation
        setActiveNav('statistics');

        // Add translations
        translations.zh.configParams = 'é…ç½®å‚æ•°';
        translations.zh.saveConfig = 'ä¿å­˜é…ç½®';
        translations.zh.configSaved = 'é…ç½®å·²ä¿å­˜';
        translations.zh.configSaveFailed = 'é…ç½®ä¿å­˜å¤±è´¥';
        translations.zh.unlockConfig = 'è§£é”ä¿®æ”¹';
        translations.zh.enterPassword = 'è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ';
        translations.zh.wrongPassword = 'å¯†ç é”™è¯¯';
        translations.zh.configLocked = 'é…ç½®å·²é”å®šï¼Œç‚¹å‡»"è§£é”ä¿®æ”¹"æ¥ä¿®æ”¹';
        
        translations.en.configParams = 'Configuration Parameters';
        translations.en.saveConfig = 'Save Configuration';
        translations.en.configSaved = 'Configuration Saved';
        translations.en.configSaveFailed = 'Failed to Save Configuration';
        translations.en.unlockConfig = 'Unlock to Edit';
        translations.en.enterPassword = 'Enter admin password';
        translations.en.wrongPassword = 'Wrong password';
        translations.en.configLocked = 'Configuration locked, click "Unlock to Edit" to modify';

        let indicators = getIndicators();
        
        const greenhouseAreaInput = document.getElementById('greenhouseAreaInput');
        const dripperCountInput = document.getElementById('dripperCountInput');
        const saveConfigBtn = document.getElementById('saveConfigBtn');
        const unlockConfigBtn = document.getElementById('unlockConfigBtn');
        const areaLockIcon = document.getElementById('areaLockIcon');
        const dripperLockIcon = document.getElementById('dripperLockIcon');
        
        // ç®¡ç†å‘˜å¯†ç  (å®é™…åº”ç”¨ä¸­åº”è¯¥ä»æœåŠ¡å™¨éªŒè¯)
        const ADMIN_PASSWORD = 'admin123';
        
        let isConfigLocked = false;

        // æ£€æŸ¥é…ç½®æ˜¯å¦å·²ä¿å­˜å¹¶é”å®š
        function checkConfigLock() {
            const savedArea = localStorage.getItem('greenhouse_area_m2');
            const savedDripper = localStorage.getItem('dripper_count');
            const isLocked = localStorage.getItem('config_locked') === 'true';
            
            if (isLocked && (savedArea || savedDripper)) {
                lockConfig();
            }
        }

        // é”å®šé…ç½®
        function lockConfig() {
            isConfigLocked = true;
            greenhouseAreaInput.disabled = true;
            dripperCountInput.disabled = true;
            saveConfigBtn.style.display = 'none';
            unlockConfigBtn.style.display = 'block';
            areaLockIcon.style.display = 'inline';
            dripperLockIcon.style.display = 'inline';
            
            greenhouseAreaInput.style.background = '#f3f4f6';
            dripperCountInput.style.background = '#f3f4f6';
            
            localStorage.setItem('config_locked', 'true');
        }

        // è§£é”é…ç½®
        function unlockConfig() {
            isConfigLocked = false;
            greenhouseAreaInput.disabled = false;
            dripperCountInput.disabled = false;
            saveConfigBtn.style.display = 'block';
            unlockConfigBtn.style.display = 'none';
            areaLockIcon.style.display = 'none';
            dripperLockIcon.style.display = 'none';
            
            greenhouseAreaInput.style.background = 'white';
            dripperCountInput.style.background = 'white';
            
            localStorage.setItem('config_locked', 'false');
        }

        // åŠ è½½é…ç½®
        async function loadConfig() {
            // ä»localStorageåŠ è½½
            const savedArea = localStorage.getItem('greenhouse_area_m2');
            const savedDripper = localStorage.getItem('dripper_count');
            
            if (savedArea) greenhouseAreaInput.value = savedArea;
            if (savedDripper) dripperCountInput.value = savedDripper;
            
            checkConfigLock();
        }

        // ä¿å­˜é…ç½®
        async function saveConfig() {
            if (isConfigLocked) {
                const lang = translations[currentLang];
                alert(lang.configLocked);
                return;
            }
            
            const area = parseFloat(greenhouseAreaInput.value) || 0;
            const dripper = parseInt(dripperCountInput.value) || 0;
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('greenhouse_area_m2', area);
            localStorage.setItem('dripper_count', dripper);
            
            const lang = translations[currentLang];
            const originalText = saveConfigBtn.innerHTML;
            saveConfigBtn.innerHTML = `âœ… ${lang.configSaved}`;
            saveConfigBtn.disabled = true;
            
            setTimeout(() => {
                saveConfigBtn.innerHTML = originalText;
                saveConfigBtn.disabled = false;
                
                // ä¿å­˜åè‡ªåŠ¨é”å®š
                lockConfig();
            }, 2000);
            
            // é‡æ–°è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
            await updateStatisticIndicators();
        }
        
        // è§£é”æŒ‰é’®äº‹ä»¶
        async function handleUnlock() {
            const lang = translations[currentLang];
            const password = prompt(lang.enterPassword);
            
            if (password === ADMIN_PASSWORD) {
                unlockConfig();
            } else if (password !== null) {
                alert(lang.wrongPassword);
            }
        }
        
        saveConfigBtn.addEventListener('click', saveConfig);
        unlockConfigBtn.addEventListener('click', handleUnlock);
        
        // é˜»æ­¢é”å®šçŠ¶æ€ä¸‹çš„è¾“å…¥
        [greenhouseAreaInput, dripperCountInput].forEach(input => {
            input.addEventListener('focus', () => {
                if (isConfigLocked) {
                    const lang = translations[currentLang];
                    alert(lang.configLocked);
                    input.blur();
                }
            });
        });

        // ä»weekly_statisticsè¡¨è·å–æœ€æ–°çš„ç»Ÿè®¡æ•°æ®
        async function getLatestStatistics(userId) {
            try {
                const { data, error } = await supabase
                    .from('weekly_statistics')
                    .select('*')
                    .eq('user_id', userId)
                    .order('year', { ascending: false })
                    .order('week', { ascending: false })
                    .limit(1)
                    .single();

                if (error) {
                    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œè¿”å›ç©ºå¯¹è±¡
                    if (error.code === 'PGRST116') {
                        return null;
                    }
                    throw error;
                }

                return data;
            } catch (error) {
                console.error('Error fetching latest statistics:', error);
                return null;
            }
        }

        // è®¡ç®—å¹¶ä¿å­˜æœ¬å‘¨ç»Ÿè®¡æ•°æ®
        async function calculateAndSaveWeeklyStatistics() {
            if (!currentUser || currentUser.is_guest) {
                return;
            }

            const now = getBeijingTime();
            const year = now.getFullYear();
            const week = getWeekNumber(now);
            const dateKey = now.toISOString().split('T')[0];

            try {
                // 1. è·å–æœ¬å‘¨æ‰€æœ‰æ ·æœ¬æ•°æ®
                const { data: weekData, error: weekError } = await supabase
                    .from('phenotype_records')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('year', year)
                    .eq('week', week);

                if (weekError) throw weekError;

                // 2. è·å–å†å²ç»Ÿè®¡æ•°æ®ï¼ˆç”¨äºç´¯ç§¯è®¡ç®—ï¼‰
                const { data: historyStats, error: historyError } = await supabase
                    .from('weekly_statistics')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .lt('week', week)
                    .order('year', { ascending: false })
                    .order('week', { ascending: false });

                if (historyError) throw historyError;

                // 3. è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
                const stats = {
                    user_id: currentUser.id,
                    year: year,
                    week: week,
                    date: dateKey,
                    greenhouse_area_m2: parseFloat(localStorage.getItem('greenhouse_area_m2')) || 0,
                };

                // è®¡ç®—æœ¬å‘¨å¹³å‡å€¼
                if (weekData && weekData.length > 0) {
                    // æœ¬å‘¨æ–°å¢åæœæ•°å¹³å‡å€¼
                    const newGrainCounts = weekData.map(r => r.new_grain_count).filter(v => v !== null && v !== undefined);
                    const avgNewGrainCount = newGrainCounts.length > 0 
                        ? newGrainCounts.reduce((a, b) => a + b, 0) / newGrainCounts.length 
                        : 0;

                    // æœ¬å‘¨äº§é‡å¹³å‡å€¼
                    const weeklyYields = weekData.map(r => r.weekly_yield_kg).filter(v => v !== null && v !== undefined);
                    const avgWeeklyYield = weeklyYields.length > 0 
                        ? weeklyYields.reduce((a, b) => a + b, 0) / weeklyYields.length 
                        : 0;

                    // æœ¬å‘¨å•ç©—é‡å¹³å‡å€¼
                    const earWeights = weekData.map(r => r.ear_weight_g).filter(v => v !== null && v !== undefined);
                    const avgEarWeight = earWeights.length > 0 
                        ? earWeights.reduce((a, b) => a + b, 0) / earWeights.length 
                        : 0;

                    // æœ¬å‘¨é‡‡æ”¶æœç©—æ•°å¹³å‡å€¼
                    const harvestCounts = weekData.map(r => r.new_harvest_grain_count).filter(v => v !== null && v !== undefined);
                    const avgHarvestCount = harvestCounts.length > 0 
                        ? harvestCounts.reduce((a, b) => a + b, 0) / harvestCounts.length 
                        : 0;

                    // ç´¯ç§¯è®¡ç®—
                    const prevAccumGrainCount = historyStats && historyStats.length > 0 
                        ? (historyStats[0].accum_grain_count || 0) 
                        : 0;
                    const prevTotalYield = historyStats && historyStats.length > 0 
                        ? (historyStats[0].total_yield_kg || 0) 
                        : 0;
                    const prevTotalHarvestEar = historyStats && historyStats.length > 0 
                        ? (historyStats[0].total_harvest_ear_count || 0) 
                        : 0;
                    const prevSingleHeadYield = historyStats && historyStats.length > 0 
                        ? (historyStats[0].single_head_yield_g || 0) 
                        : 0;

                    stats.accum_grain_count = prevAccumGrainCount + avgNewGrainCount;
                    stats.total_yield_kg = prevTotalYield + avgWeeklyYield;
                    stats.total_harvest_ear_count = prevTotalHarvestEar + avgHarvestCount;
                    stats.single_head_yield_g = prevSingleHeadYield + avgEarWeight;

                    // è®¡ç®—å•ä½äº§é‡
                    stats.unit_yield = stats.greenhouse_area_m2 > 0 
                        ? stats.total_yield_kg / stats.greenhouse_area_m2 
                        : 0;

                    // è®¡ç®—å›æ¶²æ¯”ä¾‹
                    const dripperCount = parseFloat(localStorage.getItem('dripper_count')) || 1;
                    const validRefluxData = weekData.filter(r => 
                        r.irrigation_ml !== null && r.irrigation_ml > 0 && 
                        r.reflux_ml !== null
                    );
                    if (validRefluxData.length > 0) {
                        const totalRatio = validRefluxData.reduce((sum, r) => {
                            return sum + (r.reflux_ml / (r.irrigation_ml * dripperCount)) * 100;
                        }, 0);
                        stats.reflux_ratio = totalRatio / validRefluxData.length;
                    } else {
                        stats.reflux_ratio = 0;
                    }
                } else {
                    // æœ¬å‘¨æ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨å†å²ç´¯ç§¯å€¼
                    stats.accum_grain_count = historyStats && historyStats.length > 0 ? (historyStats[0].accum_grain_count || 0) : 0;
                    stats.total_yield_kg = historyStats && historyStats.length > 0 ? (historyStats[0].total_yield_kg || 0) : 0;
                    stats.total_harvest_ear_count = historyStats && historyStats.length > 0 ? (historyStats[0].total_harvest_ear_count || 0) : 0;
                    stats.single_head_yield_g = historyStats && historyStats.length > 0 ? (historyStats[0].single_head_yield_g || 0) : 0;
                    stats.unit_yield = 0;
                    stats.reflux_ratio = 0;
                }

                // 4. ä¿å­˜æˆ–æ›´æ–°ç»Ÿè®¡æ•°æ®
                const { data: existingStats, error: checkError } = await supabase
                    .from('weekly_statistics')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .eq('year', year)
                    .eq('week', week)
                    .maybeSingle();

                if (checkError) throw checkError;

                if (existingStats) {
                    // æ›´æ–°ç°æœ‰è®°å½•
                    const { error: updateError } = await supabase
                        .from('weekly_statistics')
                        .update(stats)
                        .eq('id', existingStats.id);

                    if (updateError) throw updateError;
                    console.log('Weekly statistics updated');
                } else {
                    // æ’å…¥æ–°è®°å½•
                    const { error: insertError } = await supabase
                        .from('weekly_statistics')
                        .insert([stats]);

                    if (insertError) throw insertError;
                    console.log('Weekly statistics created');
                }

                return stats;
            } catch (error) {
                console.error('Error calculating/saving weekly statistics:', error);
                return null;
            }
        }

        // Update statistic indicators - ä»weekly_statisticsè¡¨è¯»å–
        async function updateStatisticIndicators() {
            const valuesEl = document.getElementById('statisticValues');
            if (!valuesEl) return;

            // Check auth
            if (!currentUser || currentUser.is_guest) {
                valuesEl.innerHTML = `<div class="no-data" data-lang="noData">æš‚æ— æ•°æ®</div>`;
                return;
            }

            // å…ˆè®¡ç®—å¹¶ä¿å­˜æœ¬å‘¨ç»Ÿè®¡æ•°æ®
            await calculateAndSaveWeeklyStatistics();

            // è·å–æœ€æ–°ç»Ÿè®¡æ•°æ®
            const stats = await getLatestStatistics(currentUser.id);

            const statisticIndicators = indicators.filter(ind => ind.isStatistic || ind.isConstant);

            if (statisticIndicators.length === 0) {
                valuesEl.innerHTML = `<div class="no-data" data-lang="noData">æš‚æ— ç»Ÿè®¡æŒ‡æ ‡</div>`;
                return;
            }

            let html = '';
            
            for (const indicator of statisticIndicators) {
                let value = 0;
                
                // ä»ç»Ÿè®¡æ•°æ®æˆ–localStorageè¯»å–å€¼
                if (indicator.field === 'greenhouse_area_m2') {
                    value = parseFloat(localStorage.getItem('greenhouse_area_m2')) || 0;
                } else if (indicator.field === 'dripper_count') {
                    value = parseInt(localStorage.getItem('dripper_count')) || 0;
                } else if (stats && stats[indicator.field] !== null && stats[indicator.field] !== undefined) {
                    value = parseFloat(stats[indicator.field]) || 0;
                }

                const decimals = indicator.step >= 1 ? 0 : (indicator.step >= 0.1 ? 1 : 2);
                html += `
                    <div class="stat-item">
                        <span class="stat-label">${indicator.name}</span>
                        <span class="stat-value">${value.toFixed(decimals)} ${indicator.unit}</span>
                    </div>
                `;
            }

            valuesEl.innerHTML = html || '<div class="no-data" data-lang="noData">æš‚æ— æ•°æ®</div>';
        }

        // Initialize
        async function init() {
            const session = await initAuth();
            await loadConfig();
            await updateStatisticIndicators();
        }

        init();
    </script>
</body>

</html>