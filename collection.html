<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ğŸ“Š æ•°æ®é‡‡é›† - å¾—å¸Œè¡¨å‹é‡‡é›†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="common.css?v=fix1">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .collection-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.92) 100%);
            border-radius: var(--radius-2xl, 32px);
            padding: 36px;
            box-shadow: var(--shadow-lg, 0 10px 25px rgba(0, 0, 0, 0.05), 0 20px 40px rgba(16, 185, 129, 0.1));
            border: 1px solid rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
        }

        .section-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(16, 185, 129, 0.15);
            border-radius: var(--radius-xl, 24px);
            margin-bottom: 24px;
            overflow: hidden;
            box-shadow: var(--shadow-sm, 0 1px 2px rgba(0, 0, 0, 0.04), 0 1px 3px rgba(16, 185, 129, 0.06));
            transition: var(--transition-normal, 250ms cubic-bezier(0.4, 0, 0.2, 1));
        }

        .section-card:hover {
            box-shadow: var(--shadow-md, 0 4px 6px rgba(0, 0, 0, 0.04), 0 10px 15px rgba(16, 185, 129, 0.08));
        }

        .section-header {
            background: linear-gradient(135deg, var(--color-primary-50, #ecfdf5) 0%, var(--color-primary-100, #d1fae5) 100%);
            padding: 18px 24px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-primary-800, #065f46);
            border-bottom: 2px solid var(--color-primary-400, #34d399);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            cursor: pointer;
            user-select: none;
        }

        /* Toggle Icon */
        .section-header::after {
            content: 'â–¼';
            font-size: 0.9rem;
            transition: transform 0.3s ease;
        }

        /* Collapsed State Styles */
        .section-card.collapsed .section-header::after {
            transform: rotate(-90deg);
        }

        .section-card.collapsed .section-header {
            border-bottom-color: transparent;
        }

        .section-content {
            padding: 24px;
            max-height: 5000px;
            opacity: 1;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: top;
        }

        .section-card.collapsed .section-content {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
            overflow: hidden;
        }

        /* éšè—æ•°å­—è¾“å…¥æ¡†çš„ç®­å¤´ */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 18px;
            margin-bottom: 18px;
        }

        .input-item {
            display: flex;
            flex-direction: column;
            position: relative;
            background: rgba(255, 255, 255, 0.6);
            padding: 14px;
            border-radius: var(--radius-lg, 16px);
            border: 1px solid rgba(16, 185, 129, 0.08);
            transition: var(--transition-normal, 250ms cubic-bezier(0.4, 0, 0.2, 1));
        }

        .input-item:hover {
            border-color: rgba(16, 185, 129, 0.2);
            background: rgba(255, 255, 255, 0.9);
        }

        .input-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .input-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--color-primary-500, #10b981);
            border-radius: var(--radius-sm, 8px);
        }

        .input-label {
            font-size: 0.9rem;
            color: var(--color-neutral-700, #404040);
            font-weight: 600;
            flex: 1;
        }

        .input-range {
            font-size: 0.72rem;
            color: var(--color-neutral-500, #737373);
            background: linear-gradient(135deg, var(--color-primary-50, #ecfdf5), var(--color-neutral-50, #fafafa));
            padding: 4px 8px;
            border-radius: var(--radius-full, 9999px);
            white-space: nowrap;
            font-weight: 500;
        }

        .input-field {
            padding: 12px 14px;
            border: 2px solid var(--color-neutral-200, #e5e5e5);
            border-radius: var(--radius-md, 12px);
            font-size: 1rem;
            transition: var(--transition-normal, 250ms cubic-bezier(0.4, 0, 0.2, 1));
            background-color: #fff;
        }

        /* æœªé€‰ä¸­/é”å®šçŠ¶æ€ï¼šç°è‰² */
        .input-field:disabled {
            background: var(--color-neutral-100, #f5f5f5);
            cursor: not-allowed;
            color: var(--color-neutral-400, #a3a3a3);
            border-color: var(--color-neutral-200, #e5e5e5);
        }

        /* é€‰ä¸­/æ´»åŠ¨çŠ¶æ€ */
        .input-field:not(:disabled) {
            background: #fff;
            border-color: var(--color-primary-400, #34d399);
            box-shadow: 0 4px 8px -2px rgba(16, 185, 129, 0.12);
        }

        /* è¾“å…¥äº†å€¼çš„çŠ¶æ€ï¼ˆé€šè¿‡ JS æ·»åŠ  classï¼‰ */
        .input-field.has-value {
            background: linear-gradient(135deg, var(--color-primary-50, #ecfdf5) 0%, #fff 100%);
            color: var(--color-primary-900, #064e3b);
            font-weight: 600;
            border-color: var(--color-primary-500, #10b981);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--color-primary-600, #059669);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15);
        }

        .input-field.error {
            border-color: var(--color-accent-rose, #f43f5e) !important;
            background: #fff5f5 !important;
            color: #dc2626 !important;
            box-shadow: 0 0 0 3px rgba(244, 63, 94, 0.1);
        }

        .btn-primary {
            background: var(--bg-gradient-button, linear-gradient(135deg, #10b981 0%, #059669 100%));
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: var(--radius-xl, 24px);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-normal, 250ms cubic-bezier(0.4, 0, 0.2, 1));
            width: 100%;
            margin-top: 24px;
            box-shadow: var(--shadow-md, 0 4px 6px rgba(0, 0, 0, 0.04), 0 10px 15px rgba(16, 185, 129, 0.08));
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg, 0 10px 25px rgba(0, 0, 0, 0.05), 0 20px 40px rgba(16, 185, 129, 0.15));
        }

        .btn-primary:active {
            transform: translateY(-1px);
        }

        .replicate-selector {
            margin-bottom: 24px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(16, 185, 129, 0.02) 100%);
            border-radius: var(--radius-xl, 24px);
            border: 1px solid rgba(16, 185, 129, 0.1);
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .replicate-selector select {
            padding: 12px 18px;
            border: 2px solid var(--color-primary-400, #34d399);
            border-radius: var(--radius-lg, 16px);
            font-size: 1rem;
            cursor: pointer;
            background: white;
            color: var(--color-primary-800, #065f46);
            font-weight: 500;
            transition: var(--transition-normal, 250ms cubic-bezier(0.4, 0, 0.2, 1));
        }

        .replicate-selector select:hover {
            border-color: var(--color-primary-500, #10b981);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.15);
        }

        .replicate-selector select:focus {
            outline: none;
            border-color: var(--color-primary-600, #059669);
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.15);
        }

        @media (max-width: 768px) {
            .collection-card {
                padding: 20px;
                border-radius: 20px;
            }

            .section-header {
                padding: 15px 18px;
                font-size: 1rem;
            }

            .section-content {
                padding: 18px;
            }

            .input-group {
                grid-template-columns: 1fr;
                /* Stack inputs vertically */
                gap: 15px;
            }

            .replicate-selector {
                padding: 15px;
                flex-direction: column;
                align-items: stretch;
            }

            .replicate-selector select {
                width: 100%;
            }

            .btn-primary {
                padding: 14px;
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .collection-card {
                padding: 12px;
                border-radius: 16px;
            }

            .section-card {
                margin-bottom: 16px;
                border-radius: 16px;
            }

            .section-header {
                padding: 12px 15px;
            }

            .section-content {
                padding: 15px;
            }

            .input-item {
                padding: 12px;
            }

            #currentProjectDisplay {
                font-size: 0.9rem;
                display: block;
                margin-top: 5px;
                background: rgba(16, 185, 129, 0.1) !important;
            }
        }
    </style>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <div class="nav-links">
            <a href="index.html" class="nav-link" title="é¦–é¡µ">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
            </a>
            <a href="calendar.html" class="nav-link" data-page="calendar" title="é‡‡é›†æ—¥å†">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
            </a>
            <a href="collection.html" class="nav-link" data-page="collection" title="æ•°æ®é‡‡é›†">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                </svg>
            </a>
            <a href="trends.html" class="nav-link" data-page="trends" title="ç»Ÿè®¡åˆ†æ">
                <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="20" x2="18" y2="10"></line>
                    <line x1="12" y1="20" x2="12" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
            </a>
        </div>
        <div class="user-area" id="navUserArea">
            <button class="lang-switch" id="langSwitch" style="display: none;">ğŸŒ EN</button>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <div class="collection-card">
            <!-- Project Settings -->
            <!-- Project Settings -->
            <div
                style="margin-bottom: 20px; padding: 0 10px; display: flex; align-items: center; justify-content: space-between;">
                <label
                    style="font-weight: 600; color: #065f46; display: flex; align-items: center; gap: 10px; font-size: 1.2rem;">
                    ğŸŒ¿ å½“å‰é¡¹ç›®:
                    <span id="currentProjectDisplay"
                        style="color: #059669; background: #ecfdf5; padding: 5px 12px; border-radius: 8px;"></span>
                </label>

            </div>

            <!-- Facility Settings Section -->
            <div class="section-card collapsed">
                <div class="section-header" onclick="toggleSection(this.parentElement)">âš™ï¸ æ¸©å®¤å‚æ•°è®¾ç½®</div>
                <div class="section-content">
                    <div class="input-group" id="constantInputs"></div>

                    <!-- Sample Names Management -->
                    <div
                        style="margin-top: 20px; padding: 15px; background: #f0fdf4; border-radius: 12px; border: 1px solid #d1fae5;">
                        <h4 style="margin: 0 0 15px 0; color: #065f46; font-size: 1rem;">ğŸŒ¿ é¢„è®¾æ ·æœ¬åç§°</h4>
                        <div id="sampleNamesList"
                            style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
                            <!-- Sample name tags will be rendered here -->
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="text" id="newSampleNameInput" class="input-field"
                                placeholder="è¾“å…¥æ ·æœ¬åç§° (e.g. A-1)" style="flex: 1; padding: 8px 12px; max-width: 200px;">
                            <button class="btn-primary" onclick="addSampleName()"
                                style="padding: 8px 16px; width: auto; margin-top: 0; font-size: 0.9rem;">
                                + æ·»åŠ 
                            </button>
                        </div>
                    </div>

                    <button class="btn-primary" id="saveConstantsBtn" onclick="saveConstants()"
                        style="margin-top: 20px; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">
                        ğŸ’¾ ä¿å­˜å‚æ•°
                    </button>
                </div>
            </div>

            <!-- Weekly Data Section -->
            <div class="section-card collapsed">
                <div class="section-header" onclick="toggleSection(this.parentElement)"
                    style="display: flex; justify-content: space-between; align-items: center;">
                    <span>ğŸ“Š æ¯å‘¨æ•°æ®</span>
                    <span id="weeklyHeaderInfo" style="font-size: 1rem; font-weight: 600; color: #10b981;"></span>
                </div>
                <div class="section-content">
                    <!-- Weekly Sample Management -->
                    <div class="replicate-selector" style="margin-bottom: 20px; padding: 15px;">
                        <label style="font-weight: 600; color: #065f46;">
                            é€‰æ‹©æ ·æœ¬:
                            <select id="weeklyReplicateSelect" style="min-width: 150px;"></select>
                        </label>
                    </div>

                    <!-- No Sample Placeholder -->
                    <div id="noSamplePlaceholder"
                        style="text-align: center; padding: 40px; color: #999; display: none;">
                        <div style="font-size: 2rem; margin-bottom: 10px;">ğŸŒ±</div>
                        <p>è¯·å…ˆåœ¨ã€Œæ¸©å®¤å‚æ•°è®¾ç½®ã€ä¸­æ·»åŠ æ ·æœ¬åç§°</p>
                        <p style="font-size: 0.85rem;">Please add sample names in "Facility Settings" first</p>
                    </div>

                    <div id="weeklyDataArea" style="display: none;">
                        <div class="input-group" id="weeklyInputs"></div>
                        <button class="btn-primary" id="saveWeeklyBtn" onclick="saveToDatabase('weekly')"
                            style="margin-top: 20px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            ğŸ’¾ ä¿å­˜å‘¨æ•°æ®
                        </button>
                    </div>
                </div>
            </div>

            <!-- Daily Data Section -->
            <div class="section-card collapsed">
                <div class="section-header" onclick="toggleSection(this.parentElement)"
                    style="display: flex; justify-content: space-between; align-items: center;">
                    <span>ğŸ“… æ¯æ—¥æ•°æ®</span>
                    <span id="dailyHeaderInfo" style="font-size: 1rem; font-weight: 600; color: #8B5CF6;"></span>
                </div>
                <div class="section-content">
                    <!-- Daily Replicate Selector -->


                    <div class="input-group" id="dailyInputs"></div>
                    <button class="btn-primary" id="saveDailyBtn" onclick="saveToDatabase('daily')"
                        style="margin-top: 20px; background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);">
                        ğŸ’¾ ä¿å­˜æ—¥æ•°æ®
                    </button>
                </div>
            </div>

            <!-- ... -->

        </div>
    </div>
    <script src="common.js?v=fix40"></script>
    <script>
        setActiveNav('collection');

        // Accordion: Only one section can be open at a time
        function toggleSection(sectionCard) {
            const allSections = document.querySelectorAll('.section-card');
            const wasCollapsed = sectionCard.classList.contains('collapsed');

            // Close all sections first
            allSections.forEach(section => {
                section.classList.add('collapsed');
            });

            // If the clicked section was collapsed, open it
            if (wasCollapsed) {
                sectionCard.classList.remove('collapsed');
            }
            // If it was already open, it stays closed (all closed now)
        }

        // Initialize Project Context
        let currentProjectName = localStorage.getItem('currentProject');

        document.addEventListener('DOMContentLoaded', () => {
            if (!currentProjectName) {
                // Fallback or Redirect
                const last = localStorage.getItem('lastProjectName');
                if (last) {
                    currentProjectName = last;
                    localStorage.setItem('currentProject', last);
                } else {
                    // Redirect to index if no project selected
                    window.location.href = 'index.html';
                    return;
                }
            }

            // Display project name
            const displayEl = document.getElementById('currentProjectDisplay');
            if (displayEl) displayEl.textContent = currentProjectName;

            // Display current week and date in headers
            const now = getBeijingTime();
            const year = now.getFullYear();
            const week = getWeekNumber(now);
            const month = now.getMonth() + 1;
            const day = now.getDate();
            const weekday = now.getDay(); // 0=Sunday, 1=Monday, ...
            const weekdayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

            const weeklyHeader = document.getElementById('weeklyHeaderInfo');
            if (weeklyHeader) {
                weeklyHeader.textContent = `ç¬¬${week}å‘¨ï¼ˆå‘¨${weekdayNames[weekday]}ï¼‰`;
            }

            const dailyHeader = document.getElementById('dailyHeaderInfo');
            if (dailyHeader) {
                dailyHeader.textContent = `${month}æœˆ${day}æ—¥ï¼ˆå‘¨${weekdayNames[weekday]}ï¼‰`;
            }
        });
        document.addEventListener('DOMContentLoaded', function () {
            const addBtn = document.getElementById('addReplicateBtn');
            if (addBtn) {
                addBtn.onclick = function (e) {
                    e.preventDefault();
                    maxReplicateId++;

                    collectionData[maxReplicateId] = {}; // åˆå§‹åŒ–æ•°æ®ç»“æ„

                    // æ·»åŠ é€‰é¡¹åˆ°ä¸‹æ‹‰èœå•
                    const select = document.getElementById('replicateSelect');
                    const option = document.createElement('option');
                    option.value = maxReplicateId;
                    option.textContent = `æ ·æœ¬ #${maxReplicateId}`;
                    select.appendChild(option);

                    // è‡ªåŠ¨åˆ‡æ¢åˆ°æ–°æ ·æœ¬
                    select.value = maxReplicateId;
                    currentReplicate = maxReplicateId;
                    loadReplicateData(currentReplicate);
                };
            }
        });

        // è·å–æŒ‡æ ‡é…ç½®
        let indicators = [];
        try {
            indicators = getIndicators();
            // å¼ºåˆ¶ç§»é™¤æ‰€æœ‰é»˜è®¤å€¼ï¼Œç¡®ä¿è¾“å…¥æ¡†ä¸ºç©º
            indicators.forEach(ind => delete ind.defaultValue);
            console.log('åŠ è½½äº†', indicators.length, 'ä¸ªæŒ‡æ ‡');
        } catch (e) {
            console.error('åŠ è½½æŒ‡æ ‡å¤±è´¥:', e);
            alert('é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
        }

        // åŠ¨æ€æ ·æœ¬ç®¡ç†
        let maxWeeklyRep = 0; // Start with 0 samples - user must add one
        let currentWeeklyRep = 0;
        let maxDailyRep = 1;
        let currentDailyRep = 1;

        let collectionData = {};

        // Initialize Data Structure
        function initDataStructure() {
            // Constants data cache
            if (!collectionData.constants) collectionData.constants = {};
        }

        // Update Weekly section UI based on sample count
        function updateWeeklyUIState() {
            const placeholder = document.getElementById('noSamplePlaceholder');
            const dataArea = document.getElementById('weeklyDataArea');

            if (maxWeeklyRep === 0) {
                // No samples - show placeholder, hide data area
                if (placeholder) placeholder.style.display = 'block';
                if (dataArea) dataArea.style.display = 'none';
            } else {
                // Has samples - hide placeholder, show data area
                if (placeholder) placeholder.style.display = 'none';
                if (dataArea) dataArea.style.display = 'block';
            }
        }

        // ç”Ÿæˆæ‰€æœ‰æ ·æœ¬é€‰æ‹©å™¨
        function generateReplicateSelectors() {
            updateSelector('weekly');
            updateSelector('daily');
        }

        function updateSelector(type) {
            const max = type === 'weekly' ? maxWeeklyRep : maxDailyRep;
            const current = type === 'weekly' ? currentWeeklyRep : currentDailyRep;
            const selectId = type === 'weekly' ? 'weeklyReplicateSelect' : '';
            if (type === 'daily') return; // Daily data has no selector

            const select = document.getElementById(selectId);
            if (!select) return;
            select.innerHTML = '';

            // Weekly: show placeholder if no samples
            if (type === 'weekly') {
                updateWeeklyUIState();
            }

            if (max === 0) {
                // No samples yet
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'æ— æ ·æœ¬';
                option.disabled = true;
                option.selected = true;
                select.appendChild(option);
                return;
            }

            for (let i = 1; i <= max; i++) {
                const option = document.createElement('option');
                option.value = i;
                // Use predefined sample name if available
                const sampleNames = collectionData.sampleNames || [];
                const displayName = sampleNames[i - 1] || `æ ·æœ¬ #${i}`;
                option.textContent = displayName;
                if (i === current) option.selected = true;
                select.appendChild(option);
            }

            select.onchange = function () {
                const val = parseInt(this.value);
                if (type === 'weekly') {
                    currentWeeklyRep = val;
                } else {
                    currentDailyRep = val;
                }
                loadDataForType(type, val);
            };
        }

        function setupAddButtons() {
            // Weekly samples are now managed in Facility Settings
            // Daily data doesn't need sample management
            // This function is kept for potential future use
        }

        // ç”Ÿæˆè¾“å…¥æ¡†
        function generateInputFields() {
            const weeklyContainer = document.getElementById('weeklyInputs');
            const dailyContainer = document.getElementById('dailyInputs');
            const constantContainer = document.getElementById('constantInputs');

            weeklyContainer.innerHTML = '';
            dailyContainer.innerHTML = '';
            if (constantContainer) constantContainer.innerHTML = '';

            indicators.forEach(ind => {
                if (ind.isStatistic) return;

                let container;
                if (ind.frequency === 'weekly') container = weeklyContainer;
                else if (ind.frequency === 'daily') container = dailyContainer;
                else if (ind.frequency === 'constant') container = constantContainer;
                else return;

                if (!container) return;

                const item = document.createElement('div');
                item.className = 'input-item';

                // åˆ›å»ºå¤´éƒ¨
                const header = document.createElement('div');
                header.className = 'input-header';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'input-checkbox';
                checkbox.id = `check-${ind.field}`;

                const label = document.createElement('span');
                label.className = 'input-label';
                label.textContent = `${ind.name} (${ind.unit})`;

                const rangeSpan = document.createElement('span');
                rangeSpan.className = 'input-range';
                rangeSpan.textContent = `[${ind.min}-${ind.max}]`;

                header.appendChild(checkbox);
                header.appendChild(label);
                header.appendChild(rangeSpan);

                // Input field
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'input-field';
                input.id = `input-${ind.field}`;
                input.placeholder = `ç‚¹å‡»å·¦ä¾§å¤é€‰æ¡†è§£é”è¾“å…¥`;
                input.min = ind.min;
                input.max = ind.max;
                input.step = ind.step;
                input.disabled = true;

                // Checkbox æ§åˆ¶
                checkbox.onchange = function () {
                    if (this.checked) {
                        const allCheckboxes = document.querySelectorAll('.input-checkbox');
                        allCheckboxes.forEach(cb => {
                            if (cb !== this && cb.checked) {
                                cb.checked = false;
                                const otherInputId = cb.id.replace('check-', 'input-');
                                const otherInput = document.getElementById(otherInputId);
                                if (otherInput) {
                                    otherInput.disabled = true;
                                    otherInput.placeholder = `å·²é”å®š`;
                                    otherInput.classList.remove('active-input');
                                }
                            }
                        });

                        input.disabled = false;
                        input.placeholder = `è¯·è¾“å…¥ ${ind.min} åˆ° ${ind.max}`;
                        setTimeout(() => input.focus(), 10);
                    } else {
                        input.disabled = true;
                        input.placeholder = `æ— æ•°æ® (ç‚¹å‡»è§£é”)`;
                        input.classList.remove('error');
                        if (input.value === '') {
                            const repId = ind.frequency === 'weekly' ? currentWeeklyRep :
                                (ind.frequency === 'daily' ? currentDailyRep : 'constants');

                            if (repId === 'constants') {
                                if (collectionData.constants) collectionData.constants[ind.field] = null;
                            } else {
                                if (collectionData[repId]) collectionData[repId][ind.field] = null;
                            }
                            input.classList.remove('has-value');
                        }
                    }
                };

                // è¾“å…¥éªŒè¯ä¸æ•°æ®ä¿å­˜
                input.oninput = function () {
                    const val = parseFloat(this.value);
                    const repId = ind.frequency === 'weekly' ? currentWeeklyRep :
                        (ind.frequency === 'daily' ? currentDailyRep : 'constants');

                    if (isNaN(val)) {
                        this.classList.remove('has-value');
                        if (repId === 'constants') {
                            if (collectionData.constants) collectionData.constants[ind.field] = null;
                        } else {
                            if (collectionData[repId]) collectionData[repId][ind.field] = null;
                        }
                        this.classList.remove('error');
                        return;
                    }

                    this.classList.add('has-value');
                    if (val < ind.min || val > ind.max) {
                        this.classList.add('error');
                    } else {
                        this.classList.remove('error');
                    }

                    if (repId === 'constants') {
                        if (!collectionData.constants) collectionData.constants = {};
                        collectionData.constants[ind.field] = val;
                    } else {
                        if (!collectionData[repId]) collectionData[repId] = {};
                        collectionData[repId][ind.field] = val;
                    }
                };

                input.onblur = function () { };

                item.appendChild(header);
                item.appendChild(input);
                container.appendChild(item);
            });
        }

        // åŠ è½½æŒ‡å®šç±»å‹çš„æ•°æ®
        function loadDataForType(type, repId) {
            indicators.forEach(ind => {
                if (ind.frequency !== type) return;

                if (ind.isStatistic || ind.isConstant) return;

                const input = document.getElementById(`input-${ind.field}`);
                const checkbox = document.getElementById(`check-${ind.field}`);

                if (input && checkbox) {
                    // Safe access
                    if (!collectionData[repId]) collectionData[repId] = {};
                    const value = collectionData[repId][ind.field];

                    if (value !== null && value !== undefined) {
                        // æœ‰æ•°æ®ï¼šæ˜¾ç¤ºå€¼ï¼Œä½†ä¿æŒéæ´»åŠ¨çŠ¶æ€ï¼ˆcheckbox unchecked, input disabledï¼‰
                        // è¿™æ ·ç¬¦åˆäº’æ–¥åŸåˆ™ï¼Œä¸”ç”¨æˆ·ä¸€çœ¼èƒ½çœ‹åˆ°å·²æœ‰æ•°æ®

                        checkbox.checked = false;
                        input.disabled = true;

                        input.value = value;
                        input.classList.add('has-value');

                        if (value < ind.min || value > ind.max) {
                            input.classList.add('error');
                        } else {
                            input.classList.remove('error');
                        }
                    } else {
                        checkbox.checked = false;
                        input.disabled = true;
                        input.value = '';
                        input.placeholder = `ç‚¹å‡»å·¦ä¾§å¤é€‰æ¡†è§£é”è¾“å…¥`;
                        input.classList.remove('has-value');
                        input.classList.remove('error');
                    }
                }
            });
        }

        // ä¿å­˜åˆ°æ•°æ®åº“
        async function saveToDatabase(type) {
            if (!currentUser || currentUser.is_guest) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const btnId = type === 'weekly' ? 'saveWeeklyBtn' : 'saveDailyBtn';
            const btn = document.getElementById(btnId);
            if (!btn) return;

            const originalText = btn.textContent;
            btn.textContent = 'â³ æ­£åœ¨ä¿å­˜...';
            btn.disabled = true;

            try {
                const now = getBeijingTime();
                const year = now.getFullYear();
                const week = getWeekNumber(now);
                const date = now.toISOString().split('T')[0];

                // æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨å¯¹åº”çš„ Current Replicate
                const currentRep = type === 'weekly' ? currentWeeklyRep : currentDailyRep;

                // å‡†å¤‡æ•°æ®å¯¹è±¡
                const payload = {
                    user_id: currentUser.id,
                    year: year,
                    week: week,
                    replicate_id: currentRep
                };

                // Add new columns
                if (type === 'weekly') {
                    const project = currentProjectName; // Use global variable
                    // Get sample name from predefined list based on current selection
                    const sampleNames = collectionData.sampleNames || [];
                    const sample = sampleNames[currentWeeklyRep - 1] || '';

                    if (!sample) {
                        alert('è¯·é€‰æ‹©æ ·æœ¬ï¼\n(Please select a sample)');
                        btn.textContent = originalText;
                        btn.disabled = false;
                        return;
                    }
                    payload.project_name = project;
                    payload.sample_name = sample;
                }

                // Add project name to daily data as well
                if (type === 'daily') {
                    payload.project_name = currentProjectName;
                }

                // æ—¥æ•°æ®é¢å¤–éœ€è¦æ—¥æœŸ
                if (type === 'daily') {
                    payload.date = date;
                }

                // æ”¶é›†æ•°æ®
                if (!collectionData[currentRep]) collectionData[currentRep] = {};
                const currentData = collectionData[currentRep];
                let hasData = false;

                indicators.forEach(ind => {
                    if (ind.isStatistic || ind.isConstant) return;
                    // åªå¤„ç†å½“å‰ç±»å‹çš„æ•°æ® (ind.frequency å¿…é¡»åŒ¹é… type)
                    if (ind.frequency !== type) return;

                    const value = currentData[ind.field];
                    // åªæœ‰ä¸æ˜¯ null/undefined çš„å€¼æ‰å‘é€
                    // æ³¨æ„: 0 æ˜¯æœ‰æ•ˆå€¼ï¼Œæ‰€ä»¥ !== null && !== undefined æ˜¯æ­£ç¡®çš„
                    if (value !== null && value !== undefined) {
                        const cnName = translations['zh'].indicators[ind.field];
                        if (cnName) {
                            payload[cnName] = value;
                            hasData = true;
                        }
                    }
                });

                if (!hasData) {
                    throw new Error('æœªå¡«å†™ä»»ä½•æ•°æ®');
                }

                // ç¡®å®šç›®æ ‡è¡¨å’Œå†²çªé”®
                const tableName = type === 'weekly' ? 'weekly_phenotypes' : 'daily_phenotypes';
                // Weekly: conflict on sample_name; Daily: conflict includes project_name now
                const conflictKey = type === 'weekly' ? 'user_id, year, week, sample_name' : 'user_id, date, project_name';

                // å‘é€è¯·æ±‚
                const { error } = await supabase
                    .from(tableName)
                    .upsert(payload, {
                        onConflict: conflictKey
                    });

                if (error) throw error;

                btn.textContent = 'âœ… ä¿å­˜æˆåŠŸï¼';

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert(`ä¿å­˜å¤±è´¥: ${error.message}`);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }



        // ä»æ•°æ®åº“åŠ è½½æ•°æ®
        async function loadFromDatabase() {
            if (!currentUser || currentUser.is_guest) {
                console.log('æ¸¸å®¢æ¨¡å¼ï¼Œè·³è¿‡æ•°æ®åŠ è½½');
                return;
            }

            // å…ˆåŠ è½½ Constants (åŒ…å« sampleNames)
            await loadConstants();

            try {
                const now = getBeijingTime();
                const year = now.getFullYear();
                const week = getWeekNumber(now);
                const date = now.toISOString().split('T')[0];

                const [weeklyResult, dailyResult] = await Promise.all([
                    supabase.from('weekly_phenotypes')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .eq('project_name', currentProjectName) // Filter by project
                        .eq('year', year)
                        .eq('week', week),
                    supabase.from('daily_phenotypes')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .eq('project_name', currentProjectName) // Filter by project
                        .eq('date', date)
                ]);

                // æ‰¾å‡ºæœ€å¤§ Replicate ID ï¼ˆåˆ†å¼€è®¡ç®—ï¼‰
                let dbMaxWeekly = 1;
                let dbMaxDaily = 1;

                if (weeklyResult.data) {
                    weeklyResult.data.forEach(row => {
                        if (row.replicate_id > dbMaxWeekly) dbMaxWeekly = row.replicate_id;
                    });
                }
                if (dailyResult.data) {
                    dailyResult.data.forEach(row => {
                        if (row.replicate_id > dbMaxDaily) dbMaxDaily = row.replicate_id;
                    });
                }

                // è‡ªåŠ¨æ‰©å±• Max Reps
                maxWeeklyRep = Math.max(maxWeeklyRep, dbMaxWeekly);
                maxDailyRep = Math.max(maxDailyRep, dbMaxDaily);

                // è¡¥å…¨æ•°æ®ç»“æ„
                const overallMax = Math.max(maxWeeklyRep, maxDailyRep);
                for (let i = 1; i <= overallMax; i++) {
                    if (!collectionData[i]) collectionData[i] = {};
                }

                // é‡å»ºä¸‹æ‹‰èœå•
                generateReplicateSelectors();

                // å¡«å……æ•°æ® - Weekly
                // ç°åœ¨éœ€è¦æ ¹æ® sample_name åŒ¹é…é¢„è®¾æ ·æœ¬åˆ—è¡¨çš„ç´¢å¼•
                if (!weeklyResult.error && weeklyResult.data) {
                    const sampleNames = collectionData.sampleNames || [];

                    weeklyResult.data.forEach(row => {
                        const sampleName = row.sample_name;
                        // æŸ¥æ‰¾æ­¤ sample_name åœ¨é¢„è®¾åˆ—è¡¨ä¸­çš„ç´¢å¼•
                        const idx = sampleNames.indexOf(sampleName);
                        if (idx === -1) {
                            console.log('è·³è¿‡æœªçŸ¥æ ·æœ¬:', sampleName);
                            return; // è·³è¿‡ä¸åœ¨é¢„è®¾åˆ—è¡¨ä¸­çš„æ•°æ®
                        }

                        const repId = idx + 1; // è½¬æ¢ä¸º 1-based index
                        if (!collectionData[repId]) collectionData[repId] = {};

                        // Store sample name for reference
                        collectionData[repId].sample_name = sampleName;

                        indicators.forEach(ind => {
                            if (ind.frequency === 'weekly') {
                                const cnName = translations['zh'].indicators[ind.field];
                                const val = row[cnName];
                                if (val !== undefined && val !== null) {
                                    collectionData[repId][ind.field] = val;
                                }
                            }
                        });
                    });
                }

                if (!dailyResult.error && dailyResult.data) {
                    dailyResult.data.forEach(row => {
                        // Force all daily data to replicate 1
                        const repId = 1;
                        if (!collectionData[repId]) collectionData[repId] = {};

                        indicators.forEach(ind => {
                            if (ind.frequency === 'daily') {
                                const cnName = translations['zh'].indicators[ind.field];
                                const val = row[cnName];
                                if (val !== undefined && val !== null) {
                                    collectionData[repId][ind.field] = val;
                                }
                            }
                        });
                    });
                }

                console.log('æ•°æ®åŠ è½½å®Œæˆ');
                // åˆ·æ–°å½“å‰è§†å›¾
                loadDataForType('weekly', currentWeeklyRep);
                loadDataForType('daily', currentDailyRep);

            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
            }
        }

        async function loadConstants() {
            try {
                const { data, error } = await supabase
                    .from('facility_settings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('project_name', currentProjectName) // Filter by project
                    .single();

                if (error && error.code !== 'PGRST116') throw error; // PGRST116 is "No rows found"

                let needsSetup = false;

                if (data) {
                    if (!collectionData.constants) collectionData.constants = {};
                    indicators.forEach(ind => {
                        if (ind.frequency === 'constant') {
                            const cnName = translations['zh'].indicators[ind.field];
                            if (data[cnName] !== undefined) {
                                collectionData.constants[ind.field] = data[cnName];

                                // Update UI
                                const input = document.getElementById(`input-${ind.field}`);
                                const checkbox = document.getElementById(`check-${ind.field}`);
                                if (input && checkbox) {
                                    checkbox.checked = false;
                                    input.disabled = true;
                                    input.value = data[cnName];
                                    input.classList.add('has-value');
                                }
                            }
                        }
                    });

                    // Load sample names
                    if (data.sample_names && Array.isArray(data.sample_names)) {
                        collectionData.sampleNames = data.sample_names;
                    } else {
                        collectionData.sampleNames = [];
                    }
                    renderSampleNames();
                    updateWeeklySelectorWithPredefinedNames();

                    // Check if greenhouse area is set
                    const area = data["æ¸©å®¤é¢ç§¯"];
                    if (!area || area <= 0) {
                        needsSetup = true;
                    }
                } else {
                    // No facility settings yet
                    collectionData.sampleNames = [];
                    renderSampleNames();
                    needsSetup = true;
                }

                // Show warning if setup needed
                if (needsSetup) {
                    showSetupWarning();
                }
            } catch (err) {
                console.error('åŠ è½½å‚æ•°å¤±è´¥:', err);
            }
        }

        function showSetupWarning() {
            // Auto-open Facility Settings section
            const allSections = document.querySelectorAll('.section-card');
            allSections.forEach((section, index) => {
                if (index === 0) { // First section is Facility Settings
                    section.classList.remove('collapsed');
                } else {
                    section.classList.add('collapsed');
                }
            });

            // Use global showModal
            showModal({
                title: 'è¯·å…ˆè®¾ç½®æ¸©å®¤å‚æ•°',
                message: 'æ¸©å®¤é¢ç§¯å°šæœªè®¾å®šï¼Œè¿™å°†å½±å“ã€Œå•ä½äº§é‡ã€çš„è®¡ç®—ã€‚<br>è¯·åœ¨ã€Œæ¸©å®¤å‚æ•°è®¾ç½®ã€ä¸­å¡«å†™æ¸©å®¤é¢ç§¯åä¿å­˜ã€‚',
                icon: 'âš ï¸',
                buttonText: 'å»è®¾ç½®',
                onClose: () => {
                    // Scroll to Facility Settings section
                    const facilitySection = document.querySelector('.section-card');
                    if (facilitySection) {
                        facilitySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            });
        }

        // Sample Names Management
        function renderSampleNames() {
            const container = document.getElementById('sampleNamesList');
            if (!container) return;

            const names = collectionData.sampleNames || [];

            if (names.length === 0) {
                container.innerHTML = '<span style="color: #999; font-size: 0.9rem;">æš‚æ— é¢„è®¾æ ·æœ¬</span>';
                return;
            }

            container.innerHTML = names.map((name, index) => `
                <span style="display: inline-flex; align-items: center; gap: 6px; 
                    background: white; border: 1px solid #d1fae5; padding: 6px 12px; 
                    border-radius: 20px; font-size: 0.9rem; color: #065f46;">
                    ${name}
                    <button onclick="removeSampleName(${index})" 
                        style="background: none; border: none; cursor: pointer; 
                        color: #999; font-size: 1rem; padding: 0; line-height: 1;">Ã—</button>
                </span>
            `).join('');
        }

        function addSampleName() {
            const input = document.getElementById('newSampleNameInput');
            const name = input.value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥æ ·æœ¬åç§°');
                return;
            }

            if (!collectionData.sampleNames) collectionData.sampleNames = [];

            if (collectionData.sampleNames.includes(name)) {
                alert('è¯¥æ ·æœ¬åç§°å·²å­˜åœ¨');
                return;
            }

            collectionData.sampleNames.push(name);
            renderSampleNames();
            input.value = '';

            // Update Weekly selector
            updateWeeklySelectorWithPredefinedNames();
        }

        function removeSampleName(index) {
            if (!collectionData.sampleNames) return;
            collectionData.sampleNames.splice(index, 1);
            renderSampleNames();
            updateWeeklySelectorWithPredefinedNames();
        }

        function updateWeeklySelectorWithPredefinedNames() {
            // This updates the Weekly section to use predefined sample names
            maxWeeklyRep = collectionData.sampleNames ? collectionData.sampleNames.length : 0;
            if (maxWeeklyRep > 0 && currentWeeklyRep === 0) {
                currentWeeklyRep = 1;
            }
            updateSelector('weekly');
        }

        async function saveConstants() {
            if (!currentUser || currentUser.is_guest) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const btn = document.getElementById('saveConstantsBtn');
            const originalText = btn.textContent;
            btn.textContent = 'â³ ä¿å­˜ä¸­...';
            btn.disabled = true;

            try {
                const payload = {
                    user_id: currentUser.id,
                    project_name: currentProjectName // Ensure project name is part of Key
                };
                let hasData = false;

                if (!collectionData.constants) collectionData.constants = {};

                indicators.forEach(ind => {
                    if (ind.frequency === 'constant') {
                        const val = collectionData.constants[ind.field];
                        if (val !== undefined && val !== null) {
                            const cnName = translations['zh'].indicators[ind.field];
                            payload[cnName] = val;
                            hasData = true;
                        }
                    }
                });

                // Add sample names
                payload.sample_names = collectionData.sampleNames || [];

                // Since project name is always present (from context), we can save even if only creating entry
                // But we used hasData check. "Dripper count" etc might be 0.
                // Assuming we want to save.
                hasData = true;

                if (!hasData) throw new Error('æ²¡æœ‰å¯ä¿å­˜çš„å‚æ•°');

                const { error } = await supabase
                    .from('facility_settings')
                    .upsert(payload, { onConflict: 'user_id, project_name' });

                if (error) throw error;

                btn.textContent = 'âœ… ä¿å­˜æˆåŠŸ';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);

            } catch (err) {
                console.error(err);
                alert('ä¿å­˜å¤±è´¥: ' + err.message);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // äº‹ä»¶ç›‘å¬


        // åˆå§‹åŒ–åº”ç”¨
        async function init() {
            try {
                console.log('å¼€å§‹åˆå§‹åŒ–...');

                await initAuth();
                console.log('è®¤è¯å®Œæˆ');

                initDataStructure();
                console.log('æ•°æ®ç»“æ„åˆå§‹åŒ–å®Œæˆ');

                generateReplicateSelectors();
                setupAddButtons();
                console.log('æ ·æœ¬é€‰æ‹©å™¨ç”Ÿæˆå®Œæˆ');

                generateInputFields();
                console.log('è¾“å…¥æ¡†ç”Ÿæˆå®Œæˆ');

                await loadFromDatabase();
                console.log('æ•°æ®åº“æ•°æ®åŠ è½½å®Œæˆ');

                loadDataForType('weekly', currentWeeklyRep);
                loadDataForType('daily', currentDailyRep);

                console.log('åˆå§‹åŒ–å®Œæˆï¼');

            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                alert('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }

        // å¯åŠ¨åº”ç”¨
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>

</html>