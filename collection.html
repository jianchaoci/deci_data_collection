<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ğŸ“Š æ•°æ®é‡‡é›† - å¾—å¸Œè¡¨å‹é‡‡é›†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="common.css?v=fix1">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .collection-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(5, 150, 105, 0.12);
        }

        .section-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .section-header {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            padding: 15px 20px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #065f46;
            border-bottom: 2px solid #10b981;
        }

        .section-content {
            padding: 20px;
        }

        /* éšè—æ•°å­—è¾“å…¥æ¡†çš„ç®­å¤´ */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield;
        }

        .input-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .input-item {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .input-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .input-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #10b981;
        }

        .input-label {
            font-size: 0.9rem;
            color: #374151;
            font-weight: 500;
            flex: 1;
        }

        .input-range {
            font-size: 0.75rem;
            color: #6b7280;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            white-space: nowrap;
        }

        .input-field {
            padding: 10px 12px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
            background-color: #fff;
        }

        /* æœªé€‰ä¸­/é”å®šçŠ¶æ€ï¼šç°è‰² */
        .input-field:disabled {
            background: #e5e7eb;
            /* æ›´æ·±çš„ç° */
            cursor: not-allowed;
            color: #6b7280;
            border-color: #d1d5db;
        }

        /* é€‰ä¸­/æ´»åŠ¨çŠ¶æ€ */
        .input-field:not(:disabled) {
            background: #fff;
            border-color: #10b981;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.1);
        }

        /* è¾“å…¥äº†å€¼çš„çŠ¶æ€ï¼ˆé€šè¿‡ JS æ·»åŠ  classï¼‰ */
        .input-field.has-value {
            background: #ecfdf5;
            /* æ·¡ç»¿è‰²èƒŒæ™¯è¡¨ç¤ºæœ‰å€¼ */
            color: #064e3b;
            font-weight: 600;
        }

        .input-field:focus {
            outline: none;
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .input-field.error {
            border-color: #ef4444 !important;
            background: #fef2f2 !important;
            color: #dc2626 !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 20px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        .replicate-selector {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(16, 185, 129, 0.05);
            border-radius: 10px;
        }

        .replicate-selector select {
            padding: 10px 15px;
            border: 2px solid #10b981;
            border-radius: 8px;
            font-size: 1rem;
            margin-left: 10px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <div class="nav-links">
            <a href="index.html" class="nav-link" data-page="home">ğŸ  é¦–é¡µ</a>
            <a href="calendar.html" class="nav-link" data-page="calendar">ğŸ“… é‡‡é›†æ—¥å†</a>
            <a href="collection.html" class="nav-link" data-page="collection">ğŸ“Š æ•°æ®é‡‡é›†</a>
            <a href="statistics.html" class="nav-link" data-page="statistics">ğŸ“ˆ ç»Ÿè®¡åˆ†æ</a>
            <a href="trends.html" class="nav-link" data-page="trends">ğŸ“‰ è¶‹åŠ¿åˆ†æ</a>
        </div>
        <div class="user-area">
            <button class="lang-switch" id="langSwitch">ğŸŒ EN</button>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <div class="collection-card">
            <h2 style="color: #047857; margin-bottom: 20px;">ğŸŒ± è¡¨å‹æ•°æ®é‡‡é›†</h2>

            <!-- Replicate Selector -->
            <div class="replicate-selector">
                <label style="font-weight: 600; color: #065f46;">
                    é€‰æ‹©æ ·æœ¬:
                    <select id="replicateSelect"></select>
                    <button id="addReplicateBtn" class="btn-primary"
                        style="margin-left: 10px; padding: 5px 12px; font-size: 1.2rem;">+</button>
                </label>
            </div>

            <!-- Weekly Data Section -->
            <div class="section-card">
                <div class="section-header">ğŸ“Š æ¯å‘¨æ•°æ® (Weekly Data)</div>
                <div class="section-content">
                    <div class="input-group" id="weeklyInputs"></div>
                </div>
            </div>

            <!-- Daily Data Section -->
            <div class="section-card">
                <div class="section-header">ğŸ“… æ¯æ—¥æ•°æ® (Daily Data)</div>
                <div class="section-content">
                    <div class="input-group" id="dailyInputs"></div>
                </div>
            </div>

            <!-- Submit Button -->
            <button class="btn-primary" id="saveBtn">ğŸ’¾ ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“</button>

            <!-- ... -->

        </div>
    </div>

    <script src="common.js?v=fix28"></script>
    <script>
        setActiveNav('collection');

        // ç»‘å®šæ·»åŠ æŒ‰é’®äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function () {
            const addBtn = document.getElementById('addReplicateBtn');
            if (addBtn) {
                addBtn.onclick = function (e) {
                    e.preventDefault();
                    maxReplicateId++;

                    collectionData[maxReplicateId] = {}; // åˆå§‹åŒ–æ•°æ®ç»“æ„

                    // æ·»åŠ é€‰é¡¹åˆ°ä¸‹æ‹‰èœå•
                    const select = document.getElementById('replicateSelect');
                    const option = document.createElement('option');
                    option.value = maxReplicateId;
                    option.textContent = `æ ·æœ¬ #${maxReplicateId}`;
                    select.appendChild(option);

                    // è‡ªåŠ¨åˆ‡æ¢åˆ°æ–°æ ·æœ¬
                    select.value = maxReplicateId;
                    currentReplicate = maxReplicateId;
                    loadReplicateData(currentReplicate);
                };
            }
        });

        // è·å–æŒ‡æ ‡é…ç½®
        let indicators = [];
        try {
            indicators = getIndicators();
            // å¼ºåˆ¶ç§»é™¤æ‰€æœ‰é»˜è®¤å€¼ï¼Œç¡®ä¿è¾“å…¥æ¡†ä¸ºç©º
            indicators.forEach(ind => delete ind.defaultValue);
            console.log('åŠ è½½äº†', indicators.length, 'ä¸ªæŒ‡æ ‡');
        } catch (e) {
            console.error('åŠ è½½æŒ‡æ ‡å¤±è´¥:', e);
            alert('é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
        }

        // åŠ¨æ€æ ·æœ¬ç®¡ç†
        let maxReplicateId = 1;
        let currentReplicate = 1;
        let collectionData = {};

        // åˆå§‹åŒ–æ•°æ®ç»“æ„ (é»˜è®¤åªæœ‰1ä¸ª)
        function initDataStructure() {
            collectionData[1] = {}; // åˆå§‹åªæœ‰æ ·æœ¬ #1
        }

        // ç”Ÿæˆæ ·æœ¬é€‰æ‹©å™¨
        function generateReplicateSelector() {
            const select = document.getElementById('replicateSelect');
            select.innerHTML = '';

            // æ ¹æ®å½“å‰æœ€å¤§IDç”Ÿæˆé€‰é¡¹
            for (let i = 1; i <= maxReplicateId; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `æ ·æœ¬ #${i}`;
                select.appendChild(option);
            }

            select.value = currentReplicate;

            // åˆ‡æ¢æ ·æœ¬äº‹ä»¶
            select.onchange = function () {
                currentReplicate = parseInt(this.value);
                loadReplicateData(currentReplicate);
            };

            // æ·»åŠ æŒ‰é’®äº‹ä»¶ (åªç»‘å®šä¸€æ¬¡ï¼Œæˆ–è€…åœ¨ init é‡Œç»‘å®š)
            // è¿™é‡Œæˆ‘ä»¬æ”¾åœ¨ generate å¤–é¢æ›´åˆé€‚ï¼Œæˆ–è€…ç¡®ä¿ update æ—¶ä¸é‡å¤ç»‘å®š
            // ä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†åœ¨ init() ä¸­ç»Ÿä¸€ç»‘å®šäº‹ä»¶
        }

        // ç”Ÿæˆè¾“å…¥æ¡†
        function generateInputFields() {
            const weeklyContainer = document.getElementById('weeklyInputs');
            const dailyContainer = document.getElementById('dailyInputs');

            weeklyContainer.innerHTML = '';
            dailyContainer.innerHTML = '';

            indicators.forEach(ind => {
                if (ind.isStatistic || ind.isConstant) return;

                const container = ind.frequency === 'weekly' ? weeklyContainer : dailyContainer;

                const item = document.createElement('div');
                item.className = 'input-item';

                // åˆ›å»ºå¤´éƒ¨ï¼ˆcheckbox + label + rangeï¼‰
                const header = document.createElement('div');
                header.className = 'input-header';

                // Checkbox
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'input-checkbox';
                checkbox.id = `check-${ind.field}`;

                // Label
                const label = document.createElement('span');
                label.className = 'input-label';
                label.textContent = `${ind.name} (${ind.unit})`;

                // Range display
                const rangeSpan = document.createElement('span');
                rangeSpan.className = 'input-range';
                rangeSpan.textContent = `[${ind.min}-${ind.max}]`;

                header.appendChild(checkbox);
                header.appendChild(label);
                header.appendChild(rangeSpan);

                // Input field
                const input = document.createElement('input');
                input.type = 'number';
                input.className = 'input-field';
                input.id = `input-${ind.field}`;
                input.placeholder = `ç‚¹å‡»å·¦ä¾§å¤é€‰æ¡†è§£é”è¾“å…¥`;
                input.min = ind.min;
                input.max = ind.max;
                input.step = ind.step;
                input.disabled = true; // åˆå§‹ç¦ç”¨

                // Checkbox æ§åˆ¶è¾“å…¥æ¡†çš„å¯ç”¨/ç¦ç”¨
                checkbox.onchange = function () {
                    if (this.checked) {
                        // äº’æ–¥é€»è¾‘ï¼šé€‰ä¸­å½“å‰æ—¶ï¼Œå–æ¶ˆå…¶ä»–æ‰€æœ‰çš„é€‰ä¸­çŠ¶æ€
                        const allCheckboxes = document.querySelectorAll('.input-checkbox');
                        allCheckboxes.forEach(cb => {
                            if (cb !== this && cb.checked) {
                                cb.checked = false;
                                // è§¦å‘ change äº‹ä»¶æˆ–æ‰‹åŠ¨æ‰§è¡Œç¦ç”¨é€»è¾‘
                                // ç”±äºæ‰‹åŠ¨æ”¹å˜ checked ä¸ä¼šè§¦å‘ onchangeï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ç¦ç”¨å¯¹åº”çš„ input
                                const otherInputId = cb.id.replace('check-', 'input-');
                                const otherInput = document.getElementById(otherInputId);
                                if (otherInput) {
                                    otherInput.disabled = true;
                                    otherInput.placeholder = `å·²é”å®š`;
                                    otherInput.classList.remove('active-input'); // å¯é€‰ï¼šç§»é™¤é«˜äº®æ ·å¼
                                }
                            }
                        });

                        // å¯ç”¨å½“å‰
                        input.disabled = false;
                        input.placeholder = `è¯·è¾“å…¥ ${ind.min} åˆ° ${ind.max} ä¹‹é—´çš„å€¼`;

                        // è‡ªåŠ¨èšç„¦
                        setTimeout(() => input.focus(), 10);

                    } else {
                        // é”å®šå½“å‰
                        input.disabled = true;
                        input.placeholder = `æ— æ•°æ® (ç‚¹å‡»è§£é”)`;
                        input.classList.remove('error');

                        // å¦‚æœåªæ˜¯å•çº¯ç‚¹å‡»å–æ¶ˆï¼Œä¸”å†…å®¹ä¸ºç©ºï¼Œæ˜¯å¦è¦æ¸…ç©ºæ•°æ®ï¼Ÿ
                        // åŸé€»è¾‘ä¿ç•™ï¼šå¦‚æœæ˜¯ç©ºå€¼ï¼ŒcollectionData è®¾ä¸º null
                        if (input.value === '') {
                            collectionData[currentReplicate][ind.field] = null;
                            input.classList.remove('has-value');
                        }
                    }
                };

                // è¾“å…¥éªŒè¯
                input.oninput = function () {
                    const val = parseFloat(this.value);

                    if (isNaN(val)) {
                        // ç©ºå€¼
                        this.classList.remove('has-value');
                        collectionData[currentReplicate][ind.field] = null;
                        this.classList.remove('error');
                        return;
                    }

                    // æœ‰å€¼
                    this.classList.add('has-value');

                    // æ£€æŸ¥èŒƒå›´
                    // æ£€æŸ¥èŒƒå›´
                    if (val < ind.min || val > ind.max) {
                        this.classList.add('error');
                    } else {
                        this.classList.remove('error');
                    }
                    // æ ¸å¿ƒä¿®æ”¹ï¼šæ— è®ºæ˜¯å¦errorï¼Œéƒ½ä¿å­˜å€¼ï¼
                    collectionData[currentReplicate][ind.field] = val;
                };

                // ç§»é™¤å¼¹çª—
                input.onblur = function () { };

                item.appendChild(header);
                item.appendChild(input);
                container.appendChild(item);
            });
        }

        // åŠ è½½æ ·æœ¬æ•°æ®
        function loadReplicateData(repId) {
            indicators.forEach(ind => {
                if (ind.isStatistic || ind.isConstant) return;

                const input = document.getElementById(`input-${ind.field}`);
                const checkbox = document.getElementById(`check-${ind.field}`);

                if (input && checkbox) {
                    const value = collectionData[repId][ind.field];

                    if (value !== null && value !== undefined) {
                        // æœ‰æ•°æ®ï¼šå‹¾é€‰ checkboxï¼Œå¯ç”¨è¾“å…¥æ¡†ï¼Œå¡«å……å€¼
                        checkbox.checked = true;
                        input.disabled = false;
                        input.value = value;
                        input.placeholder = `è¯·è¾“å…¥ ${ind.min} åˆ° ${ind.max} ä¹‹é—´çš„å€¼`;
                        input.classList.add('has-value');
                        // éªŒè¯èŒƒå›´
                        if (value < ind.min || value > ind.max) {
                            input.classList.add('error');
                        } else {
                            input.classList.remove('error');
                        }
                    } else {
                        // æ— æ•°æ®ï¼šå–æ¶ˆå‹¾é€‰ï¼Œç¦ç”¨è¾“å…¥æ¡†ï¼Œæ¸…ç©ºå€¼
                        checkbox.checked = false;
                        input.disabled = true;
                        input.value = '';
                        input.placeholder = `ç‚¹å‡»å·¦ä¾§å¤é€‰æ¡†è§£é”è¾“å…¥`;
                        input.classList.remove('has-value');
                        input.classList.remove('error');
                    }
                }
            });
        }

        // ä¿å­˜åˆ°æ•°æ®åº“
        async function saveToDatabase() {
            if (!currentUser || currentUser.is_guest) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const btn = document.getElementById('saveBtn');
            const originalText = btn.textContent;
            btn.textContent = 'â³ æ­£åœ¨ä¿å­˜...';
            btn.disabled = true;

            try {
                const now = getBeijingTime();
                const year = now.getFullYear();
                const week = getWeekNumber(now);
                const date = now.toISOString().split('T')[0];

                const weeklyData = {
                    user_id: currentUser.id,
                    year: year,
                    week: week,
                    replicate_id: currentReplicate
                };

                const dailyData = {
                    user_id: currentUser.id,
                    date: date,
                    year: year,
                    week: week,
                    replicate_id: currentReplicate
                };

                // æ³¨æ„: "å•å¤´ç´¯è®¡åæœç²’æ•°" ç”± Supabase æ•°æ®åº“è§¦å‘å™¨è‡ªåŠ¨è®¡ç®—
                // å‰ç«¯åªéœ€æäº¤åŸå§‹æµ‹é‡å€¼ï¼Œæ— éœ€åœ¨æ­¤å¤„è®¡ç®—

                // æ”¶é›†æ•°æ®
                const currentData = collectionData[currentReplicate];
                indicators.forEach(ind => {
                    if (ind.isStatistic || ind.isConstant) return;

                    const value = currentData[ind.field];
                    if (value !== null && value !== undefined) {
                        // è·å–ä¸­æ–‡åç§°ä½œä¸ºæ•°æ®åº“åˆ—å
                        // å¼ºåˆ¶ä½¿ç”¨ 'zh' ä¸­æ–‡é…ç½®ï¼Œæ— è®ºå½“å‰è¯­è¨€å¦‚ä½•
                        const cnName = translations['zh'].indicators[ind.field];

                        if (!cnName) {
                            console.warn(`æœªæ‰¾åˆ°æŒ‡æ ‡ ${ind.field} çš„ä¸­æ–‡ç¿»è¯‘ï¼Œå°†è·³è¿‡ä¿å­˜`);
                            return;
                        }

                        if (ind.frequency === 'weekly') {
                            weeklyData[cnName] = value;
                        } else {
                            dailyData[cnName] = value;
                        }
                    }
                });

                // å¹¶è¡Œä¿å­˜
                const [weeklyResult, dailyResult] = await Promise.all([
                    supabase.from('weekly_phenotypes').upsert(weeklyData, {
                        onConflict: 'user_id, year, week, replicate_id'
                    }),
                    supabase.from('daily_phenotypes').upsert(dailyData, {
                        onConflict: 'user_id, date, replicate_id'
                    })
                ]);

                if (weeklyResult.error) {
                    throw new Error('å‘¨æ•°æ®ä¿å­˜å¤±è´¥: ' + weeklyResult.error.message);
                }
                if (dailyResult.error) {
                    throw new Error('æ—¥æ•°æ®ä¿å­˜å¤±è´¥: ' + dailyResult.error.message);
                }

                btn.textContent = 'âœ… ä¿å­˜æˆåŠŸï¼';
                alert('âœ… æ•°æ®å·²æˆåŠŸä¿å­˜åˆ°æ•°æ®åº“ï¼');

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('âŒ ä¿å­˜å¤±è´¥: ' + error.message);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // ä»æ•°æ®åº“åŠ è½½æ•°æ®
        async function loadFromDatabase() {
            if (!currentUser || currentUser.is_guest) {
                console.log('æ¸¸å®¢æ¨¡å¼ï¼Œè·³è¿‡æ•°æ®åŠ è½½');
                return;
            }

            try {
                const now = getBeijingTime();
                const year = now.getFullYear();
                const week = getWeekNumber(now);
                const date = now.toISOString().split('T')[0];

                const [weeklyResult, dailyResult] = await Promise.all([
                    supabase.from('weekly_phenotypes')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .eq('year', year)
                        .eq('week', week),
                    supabase.from('daily_phenotypes')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .eq('date', date)
                ]);

                // æ‰¾å‡ºæœ€å¤§ Replicate ID ä»¥æ¢å¤æ ·æœ¬åˆ—è¡¨
                let dbMaxRepId = 1;

                if (weeklyResult.data) {
                    weeklyResult.data.forEach(row => {
                        if (row.replicate_id > dbMaxRepId) dbMaxRepId = row.replicate_id;
                    });
                }
                if (dailyResult.data) {
                    dailyResult.data.forEach(row => {
                        if (row.replicate_id > dbMaxRepId) dbMaxRepId = row.replicate_id;
                    });
                }

                // å¦‚æœæ•°æ®åº“ä¸­æœ‰æ›´å¤šæ ·æœ¬ï¼Œè‡ªåŠ¨æ‰©å±•
                if (dbMaxRepId > maxReplicateId) {
                    console.log(`ä»æ•°æ®åº“æ¢å¤æ ·æœ¬åˆ—è¡¨: æœ€å¤§ID ${dbMaxRepId}`);
                    // è¡¥å…¨ç¼ºå¤±çš„æ•°æ®ç»“æ„
                    for (let i = maxReplicateId + 1; i <= dbMaxRepId; i++) {
                        collectionData[i] = {};
                    }
                    maxReplicateId = dbMaxRepId;
                    // é‡å»ºä¸‹æ‹‰èœå•
                    generateReplicateSelector();
                }

                if (!weeklyResult.error && weeklyResult.data) {
                    weeklyResult.data.forEach(row => {
                        const repId = row.replicate_id;
                        // ç¡®ä¿ç»“æ„å­˜åœ¨ï¼ˆç†è®ºä¸Šä¸Šé¢å·²ç»å¤„ç†äº†ï¼Œä½†ä¸ºäº†å®‰å…¨ï¼‰
                        if (!collectionData[repId]) collectionData[repId] = {};

                        if (collectionData[repId]) {
                            indicators.forEach(ind => {
                                if (ind.frequency === 'weekly') {
                                    // ä¿®æ­£ï¼šæ•°æ®åº“åˆ—åå·²å˜ä¸ºä¸­æ–‡ï¼Œéœ€é€šè¿‡ç¿»è¯‘æ˜ å°„è·å–
                                    // å¼ºåˆ¶ä½¿ç”¨ 'zh' é…ç½®
                                    const cnName = translations['zh'].indicators[ind.field];
                                    // å°è¯•è·å–å€¼ï¼ˆå¤„ç†å¯èƒ½çš„å¤§å°å†™æˆ–Trimé—®é¢˜ï¼Œè™½ç„¶ç†è®ºä¸Šåº”å®Œå…¨åŒ¹é…ï¼‰
                                    const val = row[cnName];
                                    if (val !== undefined && val !== null) {
                                        collectionData[repId][ind.field] = val;
                                    }
                                }
                            });
                        }
                    });
                }

                if (!dailyResult.error && dailyResult.data) {
                    dailyResult.data.forEach(row => {
                        const repId = row.replicate_id;
                        if (!collectionData[repId]) collectionData[repId] = {};

                        if (collectionData[repId]) {
                            indicators.forEach(ind => {
                                if (ind.frequency === 'daily') {
                                    // ä¿®æ­£ï¼šä½¿ç”¨ä¸­æ–‡åˆ—åè¯»å–
                                    const cnName = translations['zh'].indicators[ind.field];
                                    const val = row[cnName];
                                    if (val !== undefined && val !== null) {
                                        collectionData[repId][ind.field] = val;
                                    }
                                }
                            });
                        }
                    });
                }

                console.log('æ•°æ®åŠ è½½å®Œæˆ');
                // åˆ·æ–°å½“å‰è§†å›¾
                loadReplicateData(currentReplicate);

            } catch (error) {
                console.error('æ•°æ®åŠ è½½å¤±è´¥:', error);
            }
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('saveBtn').onclick = saveToDatabase;

        // åˆå§‹åŒ–åº”ç”¨
        async function init() {
            try {
                console.log('å¼€å§‹åˆå§‹åŒ–...');

                await initAuth();
                console.log('è®¤è¯å®Œæˆ');

                initDataStructure();
                console.log('æ•°æ®ç»“æ„åˆå§‹åŒ–å®Œæˆ');

                generateReplicateSelector();
                console.log('æ ·æœ¬é€‰æ‹©å™¨ç”Ÿæˆå®Œæˆ');

                generateInputFields();
                console.log('è¾“å…¥æ¡†ç”Ÿæˆå®Œæˆ');

                await loadFromDatabase();
                console.log('æ•°æ®åº“æ•°æ®åŠ è½½å®Œæˆ');

                loadReplicateData(currentReplicate);
                console.log('åˆå§‹åŒ–å®Œæˆï¼');

            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                alert('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        }

        // å¯åŠ¨åº”ç”¨
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>

</html>