<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ğŸ“Š æ•°æ®é‡‡é›† - å¾—å¸Œè¡¨å‹é‡‡é›†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="common.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .collection-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(5, 150, 105, 0.12);
            border: 1px solid rgba(5, 150, 105, 0.15);
            max-width: 900px;
            margin: 0 auto;
        }

        .indicator-group {
            margin-bottom: 20px;
            opacity: 0.5;
            transition: opacity 0.2s ease;
        }

        .indicator-group.active {
            opacity: 1;
        }

        .indicator-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .indicator-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: #10b981;
        }

        .indicator-name {
            font-weight: 600;
            color: #064e3b;
            font-size: 0.95rem;
            flex: 1;
        }

        .indicator-label-left {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .indicator-value-display {
            font-weight: 700;
            color: #065f46;
            font-size: 0.95rem;
        }

        .slider-container {
            position: relative;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: linear-gradient(to right, #d1fae5, #6ee7b7);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981, #059669);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(5, 150, 105, 0.4);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981, #059669);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(5, 150, 105, 0.4);
        }

        input[type="range"]:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        input[type="range"]:disabled::-webkit-slider-thumb {
            cursor: not-allowed;
            background: #9ca3af;
        }

        input[type="range"]:disabled::-moz-range-thumb {
            cursor: not-allowed;
            background: #9ca3af;
        }

        /* Style for collected indicators */
        input[type="range"].collected {
            /* Green to Indigo gradient for high contrast */
            background: linear-gradient(to right, #10b981, #6366f1);
            /* Stronger, slightly purple shadow */
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.6);
        }

        input[type="range"].collected::-webkit-slider-thumb {
            background: #ffffff;
            /* Indigo border to match the gradient end */
            border: 2px solid #6366f1;
            transform: scale(1.2);
            box-shadow: 0 0 8px rgba(99, 102, 241, 0.4);
        }

        input[type="range"].collected::-moz-range-thumb {
            background: #ffffff;
            border: 2px solid #6366f1;
            transform: scale(1.2);
            box-shadow: 0 0 8px rgba(99, 102, 241, 0.4);
        }

        .progress-info {
            margin-top: 20px;
            padding: 15px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            color: #047857;
        }

        .replicate-selector-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.3);
            padding: 10px;
            border-radius: 12px;
        }

        .replicate-selector-container label {
            font-weight: 600;
            color: #065f46;
        }

        .replicate-select {
            padding: 8px 16px;
            border-radius: 8px;
            border: 2px solid #6ee7b7;
            background: white;
            color: #064e3b;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            outline: none;
        }

        .replicate-select:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
    </style>
</head>

<body>
    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <div class="nav-links">
            <a href="index.html" class="nav-link" data-page="home" data-lang="nav.home">ğŸ  é¦–é¡µ</a>
            <a href="calendar.html" class="nav-link" data-page="calendar" data-lang="nav.calendar">ğŸ“… é‡‡é›†æ—¥å†</a>
            <a href="collection.html" class="nav-link active" data-page="collection" data-lang="nav.collection">ğŸ“Š
                æ•°æ®é‡‡é›†</a>
            <a href="statistics.html" class="nav-link" data-page="statistics" data-lang="nav.statistics">ğŸ“ˆ ç»Ÿè®¡æ•°é‡</a>
            <a href="trends.html" class="nav-link" data-page="trends" data-lang="nav.trends">ğŸ“‰ è¶‹åŠ¿åˆ†æ</a>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button class="nav-link" id="authBtn" style="border: 1px solid white; cursor: pointer; display: none;">ğŸ”— ç™»å½•</button>
            <button class="lang-switch" id="langSwitch" style="position: static;">EN</button>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title" data-lang="dataCollection">ğŸ“Š æŒ‡æ ‡é‡‡é›†</h1>
        <div class="action-buttons">
            <button type="button" class="btn btn-primary" id="submitBtn" data-lang="exportBtn">ğŸ“¥ å¯¼å‡º CSV</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <div class="collection-card">
            <div class="card-header-row"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="display: flex; flex-direction: column;">
                    <h2 class="section-title" style="margin-bottom: 5px;">
                        <span data-lang="dataCollection">ğŸ“Š æŒ‡æ ‡é‡‡é›†</span> - <span id="currentReplicateDisplay">#1</span>
                    </h2>
                    <div id="collectionProgress" style="font-size: 0.9rem; color: #059669; font-weight: 500;"></div>
                </div>

                <!-- Replicate Selector INSIDE CARD -->
                <div class="replicate-selector-container"
                    style="margin: 0; padding: 5px 15px; background: rgba(16, 185, 129, 0.1);">
                    <label for="replicateSelect" data-lang="selectReplicate" style="margin-right: 10px;">é‡å¤:</label>
                    <select id="replicateSelect" class="replicate-select">
                        <!-- Options 1-30 generated by JS -->
                    </select>
                </div>
            </div>

            <form id="dataForm">
                <!-- Indicators will be dynamically generated here -->
            </form>

            <div class="form-actions" style="margin-top: 30px; text-align: center;">
                <button type="button" class="btn btn-primary" id="saveDbBtn"
                    style="background: linear-gradient(135deg, #10b981, #059669); font-size: 1.1rem; padding: 12px 30px;">
                    â˜ï¸ <span data-lang="saveToDb">æäº¤åˆ°æ•°æ®åº“</span>
                </button>
            </div>
        </div>
    </div>

    <script src="common.js?v=20251214"></script>
    <script>
        // Set active navigation
        setActiveNav('collection');

        // DOM Elements
        const form = document.getElementById('dataForm');
        const submitBtn = document.getElementById('submitBtn'); // Export CSV btn
        const saveDbBtn = document.getElementById('saveDbBtn');
        const replicateSelect = document.getElementById('replicateSelect');
        const currentReplicateDisplay = document.getElementById('currentReplicateDisplay');

        let indicators = getIndicators();
        let currentReplicate = 1;
        const TOTAL_REPLICATES = 30;

        // Store data for all 30 replicates in memory (and localStorage)
        // Structure: { 1: { growth_cm: 10, ... }, 2: { ... } }
        let replicatesData = {};

        // Add translations
        translations.zh.selectReplicate = 'é‡å¤:';
        translations.zh.replicate = 'æ ·æœ¬';
        translations.zh.saveToDb = 'æäº¤åˆ°æ•°æ®åº“';
        translations.zh.saving = 'æ­£åœ¨æäº¤...';
        translations.zh.saveSuccess = 'æäº¤æˆåŠŸï¼';
        translations.zh.saveError = 'æäº¤å¤±è´¥';

        translations.en.selectReplicate = 'Rep:';
        translations.en.replicate = 'Sample';
        translations.en.saveToDb = 'Submit to Database';
        translations.en.saving = 'Submitting...';
        translations.en.saveSuccess = 'Submitted Successfully!';
        translations.en.saveError = 'Submission Failed';

        // Initialize Data - ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰æ ·æœ¬æ•°æ®
        async function initData() {
            // åˆå§‹åŒ–æ‰€æœ‰æ ·æœ¬ï¼Œæ‰€æœ‰æŒ‡æ ‡ä¸ºnull
            for (let i = 1; i <= TOTAL_REPLICATES; i++) {
                replicatesData[i] = {};
                indicators.forEach(ind => {
                    if (!ind.isStatistic && !ind.isConstant) {
                        replicatesData[i][ind.field] = null;
                    }
                });
            }

            // ä»æ•°æ®åº“åŠ è½½æœ¬å‘¨æ‰€æœ‰æ ·æœ¬çš„æ•°æ®ï¼ˆå¦‚æœå·²ç™»å½•ï¼‰
            if (currentUser && !currentUser.is_guest) {
                try {
                    const now = getBeijingTime();
                    const year = now.getFullYear();
                    const week = getWeekNumber(now);

                    const { data, error } = await supabase
                        .from('phenotype_records')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .eq('year', year)
                        .eq('week', week)
                        .order('replicate_id', { ascending: true });

                    if (error) {
                        console.error('Error loading all replicates from database:', error);
                    } else if (data && data.length > 0) {
                        // åŠ è½½æ‰€æœ‰æ ·æœ¬çš„æ•°æ®
                        data.forEach(row => {
                            const repIndex = row.replicate_id;
                            if (repIndex >= 1 && repIndex <= TOTAL_REPLICATES) {
                                indicators.forEach(ind => {
                                    if (!ind.isStatistic && !ind.isConstant) {
                                        const value = row[ind.field];
                                        // æ•°æ®åº“ä¸­æœ‰ä»€ä¹ˆå°±æ˜¯ä»€ä¹ˆï¼ˆnullæˆ–å€¼ï¼‰
                                        replicatesData[repIndex][ind.field] = (value !== null && value !== undefined) ? value : null;
                                    }
                                });
                            }
                        });
                        console.log(`Loaded ${data.length} replicate records from database`);
                    }
                } catch (error) {
                    console.error('Exception loading all replicates from database:', error);
                }
            }
        }

        // Save Data to LocalStorage
        function saveData() {
            const todayKey = `collection_data_${getBeijingTime().toISOString().split('T')[0]}`;
            localStorage.setItem(todayKey, JSON.stringify(replicatesData));
        }

        // Generate Replicate Options
        function generateReplicateOptions() {
            replicateSelect.innerHTML = '';
            const lang = translations[currentLang];
            const repLabel = lang.replicate || 'æ ·æœ¬';

            for (let i = 1; i <= TOTAL_REPLICATES; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${repLabel} #${i}`;
                replicateSelect.appendChild(option);
            }

            replicateSelect.value = currentReplicate;

            replicateSelect.addEventListener('change', async (e) => {
                const newReplicate = parseInt(e.target.value);
                
                // æ£€æŸ¥å½“å‰æ ·æœ¬æ˜¯å¦å·²å¼€å§‹é‡‡é›†ä½†æœªå®Œæˆ
                if (currentReplicate !== newReplicate) {
                    const canSwitch = checkCanSwitchReplicate(currentReplicate);
                    if (!canSwitch.allowed) {
                        // ä¸å…è®¸åˆ‡æ¢ï¼Œæ¢å¤é€‰æ‹©
                        replicateSelect.value = currentReplicate;
                        alert(canSwitch.message);
                        return;
                    }
                }
                
                currentReplicate = newReplicate;
                currentReplicateDisplay.textContent = `#${currentReplicate}`;
                await loadReplicateValues(currentReplicate);
            });
        }

        // Generate form
        function generateForm() {
            form.innerHTML = '';

            indicators.forEach((indicator, index) => {
                if (indicator.isStatistic || indicator.isConstant) return;

                const group = document.createElement('div');
                group.className = 'indicator-group';
                group.id = `group-${indicator.field}`;

                const label = document.createElement('div');
                label.className = 'indicator-label';

                const labelLeft = document.createElement('div');
                labelLeft.className = 'indicator-label-left';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'indicator-checkbox';
                checkbox.id = `check-${indicator.field}`;
                checkbox.checked = false; // å¼ºåˆ¶åˆå§‹ä¸ºæœªé€‰ä¸­
                checkbox.addEventListener('change', (e) => handleCheckboxChange(e, indicator.field));

                const nameSpan = document.createElement('span');
                nameSpan.className = 'indicator-name';
                nameSpan.textContent = `${indicator.name} (${indicator.unit})`;

                labelLeft.appendChild(checkbox);
                labelLeft.appendChild(nameSpan);

                const valueSpan = document.createElement('span');
                valueSpan.className = 'indicator-value-display';
                valueSpan.id = `value-${indicator.field}`;
                valueSpan.textContent = indicator.defaultValue;

                label.appendChild(labelLeft);
                label.appendChild(valueSpan);

                const sliderContainer = document.createElement('div');
                sliderContainer.className = 'slider-container';

                const slider = document.createElement('input');
                slider.type = 'range';
                slider.id = `slider-${indicator.field}`;
                slider.name = indicator.field;
                slider.min = indicator.min;
                slider.max = indicator.max;
                slider.step = indicator.step;
                slider.value = indicator.defaultValue;
                slider.disabled = true; // å¼ºåˆ¶åˆå§‹ä¸ºç¦ç”¨

                slider.addEventListener('input', (e) => {
                    const val = parseFloat(e.target.value);
                    valueSpan.textContent = e.target.value;
                    
                    // åªæœ‰å½“checkboxå‹¾é€‰äº†æ‰ä¿å­˜å€¼ï¼Œå¦åˆ™ä¸è®¡å…¥é‡‡é›†
                    const checkbox = document.getElementById(`check-${indicator.field}`);
                    if (checkbox && checkbox.checked) {
                        replicatesData[currentReplicate][indicator.field] = val;
                        slider.classList.add('collected');
                    } else {
                        replicatesData[currentReplicate][indicator.field] = null;
                        slider.classList.remove('collected');
                    }
                    
                    saveData();
                    updateCollectionProgress();
                });

                sliderContainer.appendChild(slider);
                group.appendChild(label);
                group.appendChild(sliderContainer);
                form.appendChild(group);
            });
        }

        // Load values for specific replicate from database
        async function loadReplicateValues(repIndex) {
            // å…ˆé‡ç½®æ‰€æœ‰checkboxå’ŒsliderçŠ¶æ€
            indicators.forEach(indicator => {
                if (indicator.isStatistic || indicator.isConstant) return;
                
                const checkbox = document.getElementById(`check-${indicator.field}`);
                const slider = document.getElementById(`slider-${indicator.field}`);
                const valueDisplay = document.getElementById(`value-${indicator.field}`);
                const group = document.getElementById(`group-${indicator.field}`);
                
                if (checkbox) {
                    checkbox.checked = false;
                }
                if (slider) {
                    slider.disabled = true;
                    slider.value = indicator.defaultValue;
                }
                if (valueDisplay) {
                    valueDisplay.textContent = indicator.defaultValue;
                }
                if (group) {
                    group.classList.remove('active');
                }
                if (slider) {
                    slider.classList.remove('collected');
                }
            });

            // åˆå§‹åŒ–æ•°æ®ä¸ºnull
            if (!replicatesData[repIndex]) {
                replicatesData[repIndex] = {};
            }
            indicators.forEach(ind => {
                if (!ind.isStatistic && !ind.isConstant) {
                    replicatesData[repIndex][ind.field] = null;
                }
            });

            // ä»æ•°æ®åº“åŠ è½½æ•°æ®ï¼ˆå¦‚æœå·²ç™»å½•ï¼‰
            if (currentUser && !currentUser.is_guest) {
                try {
                    const now = getBeijingTime();
                    const todayStr = now.toISOString().split('T')[0];
                    const year = now.getFullYear();
                    const week = getWeekNumber(now);

                    const { data, error } = await supabase
                        .from('phenotype_records')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .eq('year', year)
                        .eq('week', week)
                        .eq('replicate_id', repIndex)
                        .single();

                    if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
                        console.error('Error loading data from database:', error);
                    } else if (data) {
                        // ä»æ•°æ®åº“åŠ è½½æ•°æ® - ä¸åšä»»ä½•å€¼åˆ¤æ–­ï¼Œæ•°æ®åº“æ˜¯ä»€ä¹ˆå°±æ˜¯ä»€ä¹ˆ
                        indicators.forEach(indicator => {
                            if (indicator.isStatistic || indicator.isConstant) return;

                            const value = data[indicator.field];
                            const slider = document.getElementById(`slider-${indicator.field}`);
                            const valueDisplay = document.getElementById(`value-${indicator.field}`);

                            if (value !== null && value !== undefined) {
                                // æ•°æ®åº“ä¸­æœ‰å€¼ï¼ˆä¸ç®¡æ˜¯ä»€ä¹ˆå€¼ï¼ŒåŒ…æ‹¬0ï¼‰ï¼šä¿å­˜å¹¶æ˜¾ç¤º
                                replicatesData[repIndex][indicator.field] = value;
                                if (slider && valueDisplay) {
                                    slider.value = value;
                                    valueDisplay.textContent = value;
                                    slider.classList.add('collected');
                                }
                            } else {
                                // æ•°æ®åº“ä¸­æ˜¯nullï¼šä¿æŒnull
                                replicatesData[repIndex][indicator.field] = null;
                                if (slider && valueDisplay) {
                                    slider.value = indicator.defaultValue;
                                    valueDisplay.textContent = indicator.defaultValue;
                                    slider.classList.remove('collected');
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('Exception loading data from database:', error);
                }
            }

            // æ›´æ–°æ˜¾ç¤º
            indicators.forEach(indicator => {
                if (indicator.isStatistic || indicator.isConstant) return;

                const slider = document.getElementById(`slider-${indicator.field}`);
                const valueDisplay = document.getElementById(`value-${indicator.field}`);
                const value = replicatesData[repIndex][indicator.field];

                if (slider && valueDisplay) {
                    if (value !== null && value !== undefined) {
                        // æ˜¾ç¤ºå·²é‡‡é›†çš„å€¼
                        slider.value = value;
                        valueDisplay.textContent = value;
                        slider.classList.add('collected');
                    } else {
                        // æ˜¾ç¤ºé»˜è®¤å€¼
                        slider.value = indicator.defaultValue;
                        valueDisplay.textContent = indicator.defaultValue;
                        slider.classList.remove('collected');
                    }
                }
            });

            updateCollectionProgress();
        }

        // Check if can switch to another replicate
        function checkCanSwitchReplicate(repIndex) {
            const totalIndicators = indicators.filter(ind => !ind.isStatistic && !ind.isConstant).length;
            const currentData = replicatesData[repIndex] || {};
            let nullCount = 0;

            // ç»Ÿè®¡å½“å‰æ ·æœ¬ä¸­æœ‰å¤šå°‘ä¸ªnullå€¼
            indicators.forEach(ind => {
                if (!ind.isStatistic && !ind.isConstant) {
                    const value = currentData[ind.field];
                    if (value === null || value === undefined) {
                        nullCount++;
                    }
                }
            });

            // å¦‚æœæœ‰nullå€¼ï¼ˆæœªå®Œæˆé‡‡é›†ï¼‰ï¼Œä¸å…è®¸åˆ‡æ¢
            if (nullCount > 0 && nullCount < totalIndicators) {
                // éƒ¨åˆ†é‡‡é›†äº†ï¼Œæœ‰nullå€¼ï¼Œä¸å…è®¸åˆ‡æ¢
                const collectedCount = totalIndicators - nullCount;
                const message = currentLang === 'zh' 
                    ? `âŒ æ— æ³•åˆ‡æ¢æ ·æœ¬ï¼\n\næ ·æœ¬ #${repIndex} æœªå®Œæˆé‡‡é›†ï¼Œè¿˜æœ‰ ${nullCount} é¡¹æŒ‡æ ‡ä¸ºç©ºã€‚\n\nå·²é‡‡é›†ï¼š${collectedCount}/${totalIndicators}\n\nè¯·å®Œæˆæ‰€æœ‰æŒ‡æ ‡åå†åˆ‡æ¢ã€‚`
                    : `âŒ Cannot switch sample!\n\nSample #${repIndex} is incomplete, ${nullCount} indicators are null.\n\nCollected: ${collectedCount}/${totalIndicators}\n\nPlease complete all indicators before switching.`;
                return { allowed: false, message: message };
            }

            return { allowed: true, message: '' };
        }

        function handleCheckboxChange(event, field) {
            const checkbox = event.target;

            if (checkbox.checked) {
                // å‹¾é€‰æ—¶ï¼šå¯ç”¨æ»‘å—ï¼Œä¿å­˜å½“å‰æ»‘å—çš„å€¼
                document.querySelectorAll('.indicator-checkbox').forEach(cb => {
                    if (cb.id !== `check-${field}`) {
                        cb.checked = false;
                        const cbField = cb.id.replace('check-', '');
                        document.getElementById(`slider-${cbField}`).disabled = true;
                        document.getElementById(`group-${cbField}`).classList.remove('active');
                    }
                });

                const slider = document.getElementById(`slider-${field}`);
                slider.disabled = false;
                document.getElementById(`group-${field}`).classList.add('active');
                
                // ä¿å­˜å½“å‰æ»‘å—çš„å€¼
                const val = parseFloat(slider.value);
                replicatesData[currentReplicate][field] = val;
                slider.classList.add('collected');
            } else {
                // å–æ¶ˆå‹¾é€‰æ—¶ï¼šç¦ç”¨æ»‘å—ï¼Œè®¾ç½®ä¸ºnullï¼ˆæœªé‡‡é›†ï¼‰
                const slider = document.getElementById(`slider-${field}`);
                slider.disabled = true;
                document.getElementById(`group-${field}`).classList.remove('active');
                
                replicatesData[currentReplicate][field] = null;
                slider.classList.remove('collected');
            }
            
            saveData();
            updateCollectionProgress();
        }

        // Update collection progress (For current replicate)
        function updateCollectionProgress() {
            // ç»Ÿè®¡å½“å‰æ ·æœ¬å·²é‡‡é›†æ•°æ®çš„æŒ‡æ ‡æ•°é‡
            let collectedInRep = 0;
            const totalIndicators = indicators.filter(ind => !ind.isStatistic && !ind.isConstant).length;
            const currentData = replicatesData[currentReplicate] || {};

            indicators.forEach(ind => {
                if (!ind.isStatistic && !ind.isConstant) {
                    const value = currentData[ind.field];
                    // ç®€å•åˆ¤æ–­ï¼šå€¼ä¸ä¸ºnullä¸”ä¸ä¸ºundefined = å·²é‡‡é›†
                    if (value !== null && value !== undefined) {
                        collectedInRep++;
                    }
                }
            });

            // è®¡ç®—æ‰€æœ‰æ ·æœ¬ä¸­æœ‰å¤šå°‘ä¸ªå®Œæˆé‡‡é›†
            let completeCount = 0;
            
            for (let i = 1; i <= TOTAL_REPLICATES; i++) {
                const repData = replicatesData[i];
                let collected = 0;
                
                indicators.forEach(ind => {
                    if (!ind.isStatistic && !ind.isConstant) {
                        const value = repData[ind.field];
                        // ç®€å•åˆ¤æ–­ï¼šå€¼ä¸ä¸ºnullä¸”ä¸ä¸ºundefined = å·²é‡‡é›†
                        if (value !== null && value !== undefined) {
                            collected++;
                        }
                    }
                });
                
                if (collected === totalIndicators) {
                    completeCount++;
                }
            }

            const progressEl = document.getElementById('collectionProgress');
            const lang = translations[currentLang];

            let statusText = '';
            if (currentLang === 'zh') {
                statusText = `å·²å®Œæˆæ ·æœ¬ ${completeCount}/${TOTAL_REPLICATES}, å½“å‰æ ·æœ¬é‡‡é›† ${collectedInRep}/${totalIndicators}`;
            } else {
                statusText = `Completed Samples ${completeCount}/${TOTAL_REPLICATES}, Current ${collectedInRep}/${totalIndicators}`;
            }

            progressEl.textContent = statusText;
        }

        // Export CSV
        function buildCSV() {
            // Columns: Year, Week, Date, Replicate_ID, Field1, Field2...
            const headers = ['Year', 'Week', 'Date', 'Replicate_ID'];
            const fields = [];

            indicators.forEach(ind => {
                if (!ind.isStatistic && !ind.isConstant) {
                    headers.push(ind.field);
                    fields.push(ind.field);
                }
            });

            let csvContent = headers.join(',') + '\n';
            const now = getBeijingTime();
            const year = now.getFullYear();
            const week = getWeekNumber(now);
            const dateStr = now.toISOString().split('T')[0];

            // Iterate all replicates
            for (let i = 1; i <= TOTAL_REPLICATES; i++) {
                const data = replicatesData[i];
                // Row structure matching database: Year, Week, Date, Replicate_ID...
                const row = [year, week, dateStr, i];

                fields.forEach(field => {
                    row.push(data[field] !== undefined ? data[field] : '');
                });

                csvContent += row.join(',') + '\n';
            }

            return csvContent;
        }

        function exportCSV() {
            const csv = buildCSV();
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'phenotype_data_' + getBeijingTime().toISOString().replace(/[:.]/g, '-') + '.csv';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        // Save to Database
        async function saveToDatabase() {
            if (!currentUser || currentUser.is_guest) {
                alert(currentLang === 'zh' ? 'è¯·å…ˆç™»å½•' : 'Please login first');
                return;
            }

            // åªéªŒè¯å½“å‰æ ·æœ¬æ˜¯å¦å®Œæˆé‡‡é›†
            const totalIndicators = indicators.filter(ind => !ind.isStatistic && !ind.isConstant).length;
            const currentData = replicatesData[currentReplicate];
            const uncollectedIndicators = [];
            let collectedCount = 0;
            
            indicators.forEach(ind => {
                if (!ind.isStatistic && !ind.isConstant) {
                    if (currentData[ind.field] === null || currentData[ind.field] === undefined) {
                        uncollectedIndicators.push(ind.name);
                    } else {
                        collectedCount++;
                    }
                }
            });
            
            // å¦‚æœå½“å‰æ ·æœ¬æœ‰æœªé‡‡é›†çš„æŒ‡æ ‡ï¼Œé˜»æ­¢æäº¤
            if (uncollectedIndicators.length > 0) {
                let message = '';
                if (currentLang === 'zh') {
                    message = `âŒ æäº¤å¤±è´¥ï¼\n\næ ·æœ¬ #${currentReplicate} æœ‰ ${uncollectedIndicators.length} é¡¹æŒ‡æ ‡æœªé‡‡é›†ï¼š\n\n`;
                    message += uncollectedIndicators.map((name, i) => `${i + 1}. ${name}`).join('\n');
                    message += `\n\nè¯·å®Œæˆæ‰€æœ‰æŒ‡æ ‡çš„é‡‡é›†åå†æäº¤ã€‚`;
                } else {
                    message = `âŒ Submission Failed!\n\nSample #${currentReplicate} has ${uncollectedIndicators.length} uncollected indicators:\n\n`;
                    message += uncollectedIndicators.map((name, i) => `${i + 1}. ${name}`).join('\n');
                    message += `\n\nPlease complete all indicators before submitting.`;
                }
                alert(message);
                return;
            }

            const lang = translations[currentLang];
            const originalText = saveDbBtn.innerHTML;
            saveDbBtn.disabled = true;
            saveDbBtn.innerHTML = `â³ ${lang.saving}`;

            try {
                console.log('Starting submission to Supabase...');
                const now = getBeijingTime();
                const todayStr = now.toISOString().split('T')[0];
                const year = now.getFullYear();
                const week = getWeekNumber(now); // from common.js
                console.log(`Submitting for Year: ${year}, Week: ${week}, Date: ${todayStr}`);

                // Prepare rows for bulk upsert
                const rows = [];

                // Iterate through replicates 1 to 30
                for (let i = 1; i <= TOTAL_REPLICATES; i++) {
                    const repData = replicatesData[i];

                    const row = {
                        user_id: currentUser.id,
                        year: year,
                        week: week,
                        date: todayStr,
                        replicate_id: i,
                    };

                    // Flatten traits into columns
                    // ç®€å•å¤„ç†ï¼šnullå°±æ˜¯nullï¼Œæœ‰å€¼å°±æ˜¯å€¼ï¼ˆä¸åšä»»ä½•åˆ¤æ–­ï¼‰
                    indicators.forEach(ind => {
                        if (!ind.isStatistic && !ind.isConstant) {
                            const value = repData[ind.field];
                            // æ•°æ®æ˜¯ä»€ä¹ˆå°±æäº¤ä»€ä¹ˆï¼ˆåŒ…æ‹¬0å€¼ï¼‰
                            row[ind.field] = (value !== null && value !== undefined) ? value : null;
                        }
                    });

                    rows.push(row);
                }

                console.log(`Prepared ${rows.length} rows for upsert.`);

                // Call Supabase Upsert
                // Target table: phenotype_records
                const { error, data } = await supabase
                    .from('phenotype_records')
                    .upsert(rows, { onConflict: 'user_id, year, week, replicate_id' })
                    .select();

                if (error) {
                    console.error('Supabase Error:', error);
                    throw error;
                }

                console.log('Supabase submission successful:', data);

                // è®¡ç®—æ€»ä½“é‡‡é›†è¿›åº¦
                let totalCompleted = 0;
                for (let i = 1; i <= TOTAL_REPLICATES; i++) {
                    const repData = replicatesData[i];
                    let isComplete = true;
                    
                    for (const ind of indicators) {
                        if (!ind.isStatistic && !ind.isConstant) {
                            if (repData[ind.field] === null || repData[ind.field] === undefined) {
                                isComplete = false;
                                break;
                            }
                        }
                    }
                    
                    if (isComplete) {
                        totalCompleted++;
                    }
                }

                // æ˜¾ç¤ºæäº¤æˆåŠŸæ¶ˆæ¯å’Œé‡‡é›†è¿›åº¦
                let successMessage = '';
                if (currentLang === 'zh') {
                    successMessage = `âœ… æäº¤æˆåŠŸï¼\n\nå½“å‰é‡‡é›†è¿›åº¦ï¼š${totalCompleted} / ${TOTAL_REPLICATES} ä¸ªæ ·æœ¬å·²å®Œæˆ`;
                } else {
                    successMessage = `âœ… Submitted Successfully!\n\nProgress: ${totalCompleted} / ${TOTAL_REPLICATES} samples completed`;
                }
                alert(successMessage);

                saveDbBtn.innerHTML = `âœ… ${lang.saveSuccess}`;
                setTimeout(() => {
                    saveDbBtn.innerHTML = originalText;
                    saveDbBtn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('Save failed details:', error);
                let checkTableMsg = '';
                if (error.code === '42P01') { // undefined_table
                    checkTableMsg = '\n(é”™è¯¯ï¼šè¡¨ä¸å­˜åœ¨ï¼Œè¯·è¿è¡Œ SQL è„šæœ¬)';
                } else if (error.code === '42501') { // permission_denied
                    checkTableMsg = '\n(é”™è¯¯ï¼šæƒé™æ‹’ç»ï¼Œè¯·æ£€æŸ¥ç™»å½•çŠ¶æ€æˆ– RLS ç­–ç•¥)';
                }
                saveDbBtn.innerHTML = `âŒ ${lang.saveError}: ${error.message}${checkTableMsg}`;
                setTimeout(() => {
                    saveDbBtn.innerHTML = originalText;
                    saveDbBtn.disabled = false;
                }, 5000);
            }
        }

        // Event listeners
        submitBtn.addEventListener('click', exportCSV);
        saveDbBtn.addEventListener('click', saveToDatabase);

        // Initialize
        async function init() {
            await initAuth(); // Ensure auth loaded for submit check
            await initData(); // ç­‰å¾…ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰æ ·æœ¬æ•°æ®
            generateReplicateOptions();
            generateForm();
            await loadReplicateValues(1); // Load Rep 1 by default
            updateCollectionProgress(); // åˆå§‹åŒ–æ—¶æ›´æ–°è¿›åº¦
        }

        init();
    </script>
</body>

</html>